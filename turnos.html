<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestiones Inbound - Generador de Turnos AI v6.0 FINAL</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%236a11cb' d='M50 0 L100 25 L100 75 L50 100 L0 75 L0 25 Z'%3E%3C/path%3E%3Cpath fill='%23ffffff' d='M50 20 L75 35 L75 65 L50 80 L25 65 L25 35 Z'%3E%3C/path%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary-start: #8e2de2;
            --color-primary-end: #4a00e0;
            --color-accent-light: #00bcd4;
            --color-glow: rgba(142, 45, 226, 0.5);
            --color-success: #28a745;
            --color-success-start: #16a34a;
            --color-success-end: #15803d;
            --color-error: #dc3545;
            --font-family: 'Manrope', sans-serif;
            --bg-dark: #0d1117;
            --glass-bg: rgba(20, 22, 37, 0.6);
            --glass-border: rgba(100, 120, 255, 0.2);
            --text-light: #f0f0f0;
            --text-medium: #a0a0b0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: var(--bg-dark);
            position: relative;
            overflow: hidden;
            color: var(--text-light);
        }

        #neuronCanvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0; opacity: 0.7;
        }

        .main-container {
            width: 100%;
            max-width: 900px;
            background: var(--glass-bg); backdrop-filter: blur(15px);
            border-radius: 24px; border: 1px solid var(--glass-border);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5), 0 0 20px var(--color-glow);
            display: grid; grid-template-columns: 1fr;
            overflow: hidden; z-index: 10;
        }
        @media (min-width: 800px) { .main-container { grid-template-columns: 38% 62%; } }

        .illustration-panel {
            padding: 40px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            background: rgba(0, 0, 0, 0.2); border-right: 1px solid var(--glass-border);
        }
        .illustration-panel h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px; color: var(--text-light);
        }
        .illustration-panel p {
            font-size: 15px;
            color: var(--text-medium);
            line-height: 1.6; max-width: 300px;
        }

        .content-panel { padding: 40px; }
        .header { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 28px; font-weight: 700; color: var(--text-light); }
        
        .upload-area {
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.2);
            display: flex; align-items: center; justify-content: center;
            min-height: 160px; margin-bottom: 25px;
            position: relative; overflow: hidden;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }
        .status-content { display: none; }
        .upload-area.is-loading .loading-content,
        .upload-area.is-success .success-content,
        .upload-area.is-error .error-content {
            display: flex;
            flex-direction: column; align-items: center;
            justify-content: center; gap: 15px; z-index: 10;
            width: 100%;
        }

        .techno-loader { position: relative; width: 80px; height: 80px; }
        .core-pulse {
            width: 20%;
            height: 20%;
            background: #fff; border-radius: 50%;
            box-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px var(--color-accent-light);
            position: absolute; top: 40%; left: 40%;
            animation: corePulse 1.5s ease-in-out infinite;
        }
        @keyframes corePulse {
            0%, 100% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        .circuit-flow {
            fill: none;
            stroke-width: 1.5; stroke: var(--color-primary-start);
            stroke-dasharray: 100; stroke-dashoffset: 100;
            animation: flow 3s linear infinite;
        }
        #flow-2 { animation-delay: 0.5s; stroke: var(--color-primary-end); }
        #flow-3 { animation-delay: 1s; }
        @keyframes flow { to { stroke-dashoffset: -100; } }
        .status-text-dynamic {
            font-size: 16px;
            font-weight: 600; color: var(--text-medium);
            text-align: center; transition: opacity 0.3s ease;
            margin-top: 10px;
        }
        
        .success-icon svg path {
            stroke: var(--color-success);
            stroke-dasharray: 29; stroke-dashoffset: 29;
            animation: drawCheck 0.4s 0.2s cubic-bezier(0.76, 0, 0.24, 1) forwards;
        }
        @keyframes drawCheck { to { stroke-dashoffset: 0; } }
        .upload-area.is-success { border-color: rgba(40, 167, 69, 0.5); box-shadow: 0 0 20px rgba(40, 167, 69, 0.4); }
        .success-text { color: var(--color-success); font-size: 16px; font-weight: 600; }
        
        .error-icon { height: 40px; width: 40px; color: var(--color-error); }
        .upload-area.is-error { border-color: rgba(220, 53, 69, 0.5); box-shadow: 0 0 20px rgba(220, 53, 69, 0.4); }
        .error-text { color: var(--color-error); font-size: 16px; font-weight: 600; }

        #weekSelectorContainer { display: none; margin-top: 20px; animation: fadeIn 0.5s; }
        #weekSelectorContainer label { display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-medium); }
        
        .custom-select-wrapper { position: relative; }
        .custom-select-trigger {
            width: 100%;
            padding: 12px 15px; border-radius: 8px;
            background: rgba(0, 0, 0, 0.2); border: 1px solid var(--glass-border);
            color: var(--text-light); font-family: var(--font-family); font-size: 16px;
            cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            transition: all 0.3s ease;
        }
        .custom-select-trigger:hover, .custom-select-wrapper.open .custom-select-trigger {
            border-color: rgba(142, 45, 226, 0.7); box-shadow: 0 0 15px var(--color-glow);
        }
        .custom-select-trigger::after { content: 'â–¼'; font-size: 12px; color: var(--text-medium); transition: transform 0.3s ease; }
        .custom-select-wrapper.open .custom-select-trigger::after { transform: rotate(180deg); }
        
        .custom-options {
            position: absolute;
            top: 105%; left: 0; right: 0;
            background: rgba(20, 22, 37, 0.7); backdrop-filter: blur(10px);
            border-radius: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            z-index: 100; max-height: 200px; overflow-y: auto;
            border: 1px solid var(--glass-border);
            opacity: 0; visibility: hidden; transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        .custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-option { padding: 12px 15px; cursor: pointer; transition: background-color 0.2s ease; border-bottom: 1px solid rgba(100, 120, 255, 0.1); }
        .custom-option:last-child { border-bottom: none; }
        .custom-option:hover { background-color: rgba(142, 45, 226, 0.2); }
        .custom-option.selected { background-color: rgba(142, 45, 226, 0.3); font-weight: 600; color: #fff; }
        #weekSelector { display: none; }

        .button-container { text-align: center; margin-top: 25px; }
        .button {
            background-image: linear-gradient(45deg, var(--color-primary-start) 0%, var(--color-primary-end) 100%);
            color: white; border: none; padding: 14px 35px; border-radius: 10px;
            font-size: 16px; font-weight: 700; cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            background-size: 200% auto;
        }
        .button:hover { transform: translateY(-3px); box-shadow: 0 7px 30px var(--color-glow); background-position: right center; }
        .button:disabled {
            opacity: 0.4;
            cursor: not-allowed; transform: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); background-position: left center;
        }
        .button.is-success {
            background-image: linear-gradient(45deg, var(--color-success-start) 0%, var(--color-success-end) 100%);
        }
        .button.is-success:hover {
            box-shadow: 0 7px 30px rgba(40, 167, 69, 0.4);
        }

        .status-message {
            text-align: center;
            margin-top: 20px; padding: 15px; border-radius: 10px;
            display: none; animation: slideDown 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status-message.success { background: rgba(40, 167, 69, 0.2); border: 1px solid rgba(40, 167, 69, 0.5); color: #28a745; display: block; }
        .status-message.error { background: rgba(220, 53, 69, 0.2); border: 1px solid rgba(220, 53, 69, 0.5); color: var(--color-error); display: block; }
        
        .settings-container { display: none; position: relative; margin-top: 20px; text-align: right; animation: fadeIn 0.5s; }
        .settings-button { background: transparent; border: none; cursor: pointer; color: var(--text-medium); padding: 5px; border-radius: 50%; transition: all 0.2s ease; }
        .settings-button:hover { background-color: rgba(142, 45, 226, 0.2); color: var(--text-light); }
        .settings-button.is-active { color: var(--color-accent-light); animation: blink-active 1.5s infinite; }
        @keyframes blink-active { 50% { opacity: 0.4; } }
        
        .settings-panel {
            display: none;
            position: absolute; bottom: 100%; right: 0; margin-bottom: 8px;
            background: var(--glass-bg); backdrop-filter: blur(10px);
            border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            padding: 20px; z-index: 100; width: 320px; text-align: left;
            border: 1px solid var(--glass-border);
        }
        .settings-panel h3 { font-size: 16px; margin-bottom: 15px; color: var(--text-light); }
        .settings-panel .setting-group { margin-bottom: 20px; }
        #permanenciaInput {
            width: 100%;
            padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border);
            background-color: rgba(0,0,0,0.2); font-family: var(--font-family);
            font-size: 15px; color: var(--text-light);
        }
        #permanenciaInput:focus { border-color: rgba(142, 45, 226, 0.7); box-shadow: 0 0 15px var(--color-glow); outline: none;}
        .radio-group label { display: flex; align-items: center; margin-top: 10px; cursor: pointer; }
        .radio-group input { margin-right: 10px; }


        .button-small {
            background-image: linear-gradient(45deg, var(--color-primary-start) 0%, var(--color-primary-end) 100%);
            color: white; border: none; padding: 8px 16px; border-radius: 8px;
            font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;
        }
        .button-small:hover { transform: translateY(-2px); box-shadow: 0 4px 15px var(--color-glow); }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
</head>
<body>
    <canvas id="neuronCanvas"></canvas>

    <div class="main-container">
        <div class="illustration-panel">
            <h2>GestiÃ³n de Turnos IA</h2>
            <p>SincronizaciÃ³n automÃ¡tica con la nube. Selecciona la semana y genera tu informe de turnos con un solo clic.</p>
        </div>
        <div class="content-panel">
            <div class="header"><h1>Generador de Turnos Diarios</h1></div>

            <div class="upload-area" id="statusContainer">
                 <div class="status-content loading-content">
                    <div class="techno-loader">
                        <svg viewBox="0 0 100 100">
                            <path class="circuit-flow" id="flow-1" d="M 50,50 m -25,0 a 25,25 0 1,1 50,0 a 25,25 0 1,1 -50,0"></path>
                            <path class="circuit-flow" id="flow-2" d="M 50,50 m -35,0 a 35,35 0 1,0 70,0 a 35,35 0 1,0 -70,0"></path>
                            <path class="circuit-flow" id="flow-3" d="M 50,10 V 90 M 10,50 H 90"></path>
                        </svg>
                        <div class="core-pulse"></div>
                    </div>
                    <div class="status-text-dynamic" id="dynamicStatusText"></div>
                 </div>
                 <div class="status-content success-content">
                    <div class="success-icon"><svg viewBox="0 0 24 24"><path fill="none" stroke-width="2.5" stroke="currentColor" d="M5,13 l4,4 l10,-10" /></svg></div>
                    <div class="success-text">SincronizaciÃ³n completa</div>
                 </div>
                 <div class="status-content error-content">
                    <div class="status-icon error-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg></div>
                    <div class="error-text" id="errorText"></div>
                 </div>
            </div>

            <div id="weekSelectorContainer">
                <label for="weekSelector">1. Selecciona la semana a generar</label>
                <div class="custom-select-wrapper" id="customSelect">
                    <select id="weekSelector"></select>
                    <div class="custom-select-trigger" id="customSelectTrigger">-- Esperando datos --</div>
                    <div class="custom-options" id="customOptions"></div>
                </div>
            </div>
            
            <div class="settings-container" id="settingsContainer">
                <button id="settingsBtn" class="settings-button" title="Configurar Texto de Permanencia">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M19.82 10.99 21 12l-1.18 1.01-.01.01c-.47 2.09-2.32 3.65-4.54 3.86l-.01.01L14 18.04V19a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.96l-1.25-1.17-.01-.01c-2.22-.21-4.07-1.77-4.54-3.86l-.01-.01L3 12l1.18-1.01.01-.01c.47-2.09 2.32-3.65 4.54-3.86l.01-.01L10 5.96V5a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.96l1.25 1.17.01.01c2.22.21 4.07 1.77 4.54 3.86l.01.01ZM12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/></svg>
                </button>
                <div class="settings-panel" id="settingsPanel">
                    <div class="setting-group">
                        <h3>Permanencia</h3>
                        <input type="text" id="permanenciaInput" placeholder="Escribe aquÃ­...">
                    </div>
                    <div class="setting-group">
                        <h3>ConfiguraciÃ³n de Descansos</h3>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="descansosOption" value="con" checked>
                                Generar con descansos
                            </label>
                            <label>
                                <input type="radio" name="descansosOption" value="sin">
                                Generar sin descansos
                            </label>
                        </div>
                    </div>
                    <button id="permanenciaAcceptBtn" class="button-small">Aceptar</button>
                </div>
            </div>

            <div class="button-container">
                <button class="button" id="generateBtn" disabled>Generar Excel</button>
            </div>
            <div class="status-message" id="statusMessage"></div>
        </div>
    </div>
    
    <script>
        let allData = null, turnosData = null, generatedWorkbook = null, fileName = '';
        let statusInterval, permanenciaText = '';
        // NUEVO: Variable para controlar la generaciÃ³n de descansos
        let generarConDescansos = true;
        
        const generateBtn = document.getElementById('generateBtn');
        const weekSelectorContainer = document.getElementById('weekSelectorContainer');
        const weekSelector = document.getElementById('weekSelector');
        const customSelect = document.getElementById('customSelect');
        const customSelectTrigger = document.getElementById('customSelectTrigger');
        const customOptions = document.getElementById('customOptions');
        const statusMessage = document.getElementById('statusMessage');
        const statusContainer = document.getElementById('statusContainer');
        const dynamicStatusText = document.getElementById('dynamicStatusText');
        const errorText = document.getElementById('errorText');
        
        const settingsContainer = document.getElementById('settingsContainer');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const permanenciaInput = document.getElementById('permanenciaInput');
        const permanenciaAcceptBtn = document.getElementById('permanenciaAcceptBtn');

        // --- INICIO: LÃ“GICA DE LA RED NEURONAL DE FONDO (CANVAS) ---
        const canvas = document.getElementById('neuronCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particlesArray;
        class Particle {
            constructor(x, y, size, speedX, speedY) {
                this.x = x; this.y = y; this.size = size;
                this.speedX = speedX; this.speedY = speedY;
                this.pulseSpeed = Math.random() * 0.02 + 0.005;
                this.pulseOffset = Math.random() * Math.PI * 2;
            }
            draw() {
                const pulse = Math.abs(Math.sin(this.pulseOffset + Date.now() * this.pulseSpeed));
                const alpha = 0.5 + pulse * 0.5;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
                ctx.shadowBlur = 10;
                ctx.shadowColor = `rgba(0, 188, 212, ${alpha})`;
                ctx.fillStyle = `rgba(200, 225, 255, ${alpha})`;
                ctx.fill();
                ctx.shadowBlur = 0;
            }
            update() {
                if (this.x > canvas.width || this.x < 0) this.speedX = -this.speedX;
                if (this.y > canvas.height || this.y < 0) this.speedY = -this.speedY;
                this.x += this.speedX; this.y += this.speedY;
            }
        }
        function initParticles() {
            particlesArray = [];
            let numberOfParticles = (canvas.height * canvas.width) / 9000;
            for (let i = 0; i < numberOfParticles; i++) {
                let size = (Math.random() * 2) + 1;
                let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
                let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
                let speedX = (Math.random() * 0.9) - 0.45;
                let speedY = (Math.random() * 0.9) - 0.45;
                particlesArray.push(new Particle(x, y, size, speedX, speedY));
            }
        }
        function connectParticles() {
            let opacityValue = 1;
            for (let a = 0; a < particlesArray.length; a++) {
                for (let b = a; b < particlesArray.length; b++) {
                    let distance = ((particlesArray[a].x - particlesArray[b].x) ** 2) + ((particlesArray[a].y - particlesArray[b].y) ** 2);
                    if (distance < (canvas.width / 7) * (canvas.height / 7)) {
                        opacityValue = 1 - (distance / 20000);
                        ctx.strokeStyle = `rgba(0, 188, 212, ${opacityValue})`;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(particlesArray[a].x, particlesArray[a].y);
                        ctx.lineTo(particlesArray[b].x, particlesArray[b].y);
                        ctx.stroke();
                    }
                }
            }
        }
        function animateParticles() {
            requestAnimationFrame(animateParticles);
            ctx.clearRect(0, 0, innerWidth, innerHeight);
            for (let i = 0; i < particlesArray.length; i++) {
                particlesArray[i].update();
                particlesArray[i].draw();
            }
            connectParticles();
        }
        window.addEventListener('resize', () => {
            canvas.width = innerWidth;
            canvas.height = innerHeight;
            initParticles();
        });
        initParticles();
        animateParticles();
        // --- FIN: LÃ“GICA DE LA RED NEURONAL ---
        
        // --- INICIO: MANEJO DE LA INTERFAZ (SELECTORES Y PANEL DE CONFIGURACIÃ“N) ---
        customSelectTrigger.addEventListener('click', () => customSelect.classList.toggle('open'));
        settingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsPanel.style.display = settingsPanel.style.display === 'block' ? 'none' : 'block';
        });

        // ACTUALIZADO: El botÃ³n Aceptar ahora guarda ambas configuraciones
        permanenciaAcceptBtn.addEventListener('click', () => {
            permanenciaText = permanenciaInput.value;
            settingsBtn.classList.toggle('is-active', permanenciaText.trim() !== '');
            
            const descansosValue = document.querySelector('input[name="descansosOption"]:checked').value;
            generarConDescansos = (descansosValue === 'con');

            settingsPanel.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (!customSelect.contains(e.target)) customSelect.classList.remove('open');
            if (!settingsContainer.contains(e.target)) settingsPanel.style.display = 'none';
        });
        // --- FIN: MANEJO DE LA INTERFAZ ---
        
        // --- INICIO: LÃ“GICA DE DATOS Y FECHAS ---
        function excelSerialToDate(serial) { if (typeof serial !== 'number' || serial < 1) return null; const utcDate = new Date((serial - 25569) * 86400 * 1000); return new Date(utcDate.getTime() + (utcDate.getTimezoneOffset() * 60000)); }
        function parseDateTime(value, dateReference) { if (value === null || value === undefined || typeof value !== 'number') return null; if (value > 1) return excelSerialToDate(value); if (value >= 0 && value < 1 && dateReference instanceof Date) { const totalMilliseconds = Math.round(value * 24 * 60 * 60 * 1000); const combinedDate = new Date(dateReference.getFullYear(), dateReference.getMonth(), dateReference.getDate()); combinedDate.setTime(combinedDate.getTime() + totalMilliseconds); return combinedDate; } return null; }
        function normalizeDate(d) { if (!(d instanceof Date)) return null; const date = new Date(d); date.setHours(0, 0, 0, 0); return date; }

        async function loadDataFromFlow() {
            statusContainer.className = 'upload-area is-loading';
            const statusMessages = ["Iniciando conexiÃ³n segura...", "Analizando topologÃ­a de red...", "Enviando solicitud al nÃºcleo central...", "Recibiendo streams de datos encriptados...", "Decodificando paquetes...", "Procesando registros con IA...", "Optimizando resultados..."];
            let messageIndex = 0;
            dynamicStatusText.textContent = statusMessages[messageIndex];
            statusInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % statusMessages.length;
                dynamicStatusText.style.opacity = '0';
                setTimeout(() => {
                    dynamicStatusText.textContent = statusMessages[messageIndex];
                    dynamicStatusText.style.opacity = '1';
                }, 300);
            }, 1800);
            const flowUrl = "https://default136d6ab55b55496f97cb2424247715.ed.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a6c5e734ae1d4bc8a2da0972cf1ed1e0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=iQVhRZddVOE3RtVzIpkGkzu9MI1bAzp0vmUWiJtcuIw";

            try {
                const response = await fetch(flowUrl, { method: "POST" });
                if (!response.ok) throw new Error("Respuesta de red no fue exitosa: " + response.status);
                const rawData = await response.json();
                if (!Array.isArray(rawData) || rawData.length === 0) throw new Error("No se recibieron datos.");
                allData = rawData.map(row => { const newRow = { ...row }; const fechaKeys = ['Fecha', 'fecha', 'Date']; const iniKeys = ['Ini', 'ini', 'INICIO']; const finKeys = ['FIN', 'Fin', 'fin']; let dateComponent = null; for (const key of fechaKeys) { if (row[key] !== undefined) { dateComponent = excelSerialToDate(parseFloat(row[key])); break; } } newRow.Fecha = dateComponent; for (const key of iniKeys) { if (row[key] !== undefined) { newRow.Ini = parseDateTime(parseFloat(row[key]), dateComponent); break; } } for (const key of finKeys) { if (row[key] !== undefined) { newRow.FIN = parseDateTime(parseFloat(row[key]), dateComponent); break; } } return newRow; });
                clearInterval(statusInterval);
                statusContainer.className = 'upload-area is-success';
                populateWeekSelector(allData);
                weekSelectorContainer.style.display = 'block';

            } catch (error) {
                console.error("Error al cargar datos:", error);
                clearInterval(statusInterval);
                statusContainer.className = 'upload-area is-error';
                errorText.textContent = error.message;
            }
        }
        
        function getMonday(d) { d = new Date(d); const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1); const monday = new Date(d.setDate(diff)); monday.setHours(0, 0, 0, 0); return monday; }
        
        function populateWeekSelector(data) { const weekSet = new Set(); data.forEach(row => { if (row.Fecha instanceof Date && !isNaN(row.Fecha)) { weekSet.add(getMonday(row.Fecha).toISOString()); } }); const sortedWeeks = Array.from(weekSet).sort((a, b) => new Date(b) - new Date(a)); const last4Weeks = sortedWeeks.slice(0, 4); weekSelector.innerHTML = ''; customOptions.innerHTML = ''; if (last4Weeks.length === 0) { customSelectTrigger.textContent = 'No se encontraron semanas vÃ¡lidas'; customSelectTrigger.style.color = 'var(--color-error)'; return; } customSelectTrigger.textContent = '-- Selecciona una semana --'; customSelectTrigger.style.color = ''; last4Weeks.forEach(mondayISO => { const monday = new Date(mondayISO); const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6); const mondayDay = monday.getDate(); const sundayDay = sunday.getDate(); const mondayMonth = monday.toLocaleString('es-ES', { month: 'long' }); const sundayMonth = sunday.toLocaleString('es-ES', { month: 'long' }); let optionText; if (mondayMonth === sundayMonth) { optionText = `Semana del ${mondayDay} al ${sundayDay} de ${sundayMonth}`; } else { optionText = `Semana del ${mondayDay} de ${mondayMonth} al ${sundayDay} de ${sundayMonth}`; } const option = document.createElement('option'); option.value = mondayISO; option.textContent = optionText; weekSelector.appendChild(option); const customOption = document.createElement('div'); customOption.classList.add('custom-option'); customOption.textContent = optionText; customOption.dataset.value = mondayISO; customOption.addEventListener('click', () => { customSelectTrigger.textContent = customOption.textContent; weekSelector.value = customOption.dataset.value; weekSelector.dispatchEvent(new Event('change')); document.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected')); customOption.classList.add('selected'); customSelect.classList.remove('open'); }); customOptions.appendChild(customOption); }); }
        
        function handleWeekSelection(event) { const selectedMondayISO = event.target.value; if (!selectedMondayISO) { turnosData = null; generateBtn.disabled = true; settingsContainer.style.display = 'none'; return; } const selectedMonday = new Date(selectedMondayISO); const sunday = new Date(selectedMonday); sunday.setDate(selectedMonday.getDate() + 6); turnosData = allData.filter(row => { const rowDate = normalizeDate(row.Fecha); return rowDate && rowDate >= selectedMonday && rowDate <= sunday; }); generateBtn.disabled = false; settingsContainer.style.display = 'block'; }
        
        function showStatus(message, type) { statusMessage.className = `status-message ${type}`; statusMessage.textContent = message; setTimeout(() => { statusMessage.className = 'status-message'; }, 4000); }
        function isLibre(row) { const ini = row['Ini']; const fin = row['FIN']; const iniStr = typeof ini === 'string' ? ini.trim().toUpperCase() : ''; const finStr = typeof fin === 'string' ? fin.trim().toUpperCase() : ''; const iniInvalid = !(ini instanceof Date); const finInvalid = !(fin instanceof Date); return iniStr.includes('LIBRE') || finStr.includes('LIBRE') || (iniInvalid && finInvalid); }
        function formatTime(date) { if (!(date instanceof Date) && typeof date !== 'string') return ''; if (typeof date === 'string') return date; const d = date; return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`; }
        function formatDate(date) { if (!(date instanceof Date)) return ''; const d = normalizeDate(date); const days = ['domingo', 'lunes', 'martes', 'miÃ©rcoles', 'jueves', 'viernes', 'sÃ¡bado']; const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre']; return `${days[d.getDay()]}, ${d.getDate()} de ${months[d.getMonth()]} del ${d.getFullYear()}`; }
        // --- FIN: LÃ“GICA DE DATOS Y FECHAS ---

        // --- INICIO: LÃ“GICA COMPLETA Y FUNCIONAL DE GENERACIÃ“N DE EXCEL ---
        generateBtn.addEventListener('click', generateExcel);
        weekSelector.addEventListener('change', handleWeekSelection);
       
        async function generateExcel() {
            if (!turnosData || turnosData.length === 0) {
                showStatus('No hay datos vÃ¡lidos para procesar en la semana seleccionada.', 'error');
                return;
            }
            generateBtn.disabled = true;
            const originalText = generateBtn.textContent;
            generateBtn.textContent = 'Generando...';
            
            setTimeout(async () => {
                try {
                    await createExcelWorkbookWithStyles();
                    
                    generateBtn.classList.add('is-success');
                    generateBtn.textContent = 'Descargando...';

                    await triggerDownload();
                    
                    setTimeout(() => {
                        generateBtn.classList.remove('is-success');
                        generateBtn.textContent = originalText;
                        generateBtn.disabled = false;
                        showStatus('Excel generado y descargado con Ã©xito.', 'success');
                    }, 2000);

                } catch (error) {
                    showStatus('OcurriÃ³ un error al generar el archivo.', 'error');
                    console.error(error);
                    generateBtn.disabled = false;
                    generateBtn.textContent = originalText;
                }
            }, 100);
        }

        async function triggerDownload() {
            if (generatedWorkbook && fileName) {
                const buffer = await generatedWorkbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        }
        function getColacionDuration(rowData) {
            const rawValue = rowData['Dur_Colac'];
            if (rawValue !== undefined && rawValue !== null) {
                const cleanValue = String(rawValue).trim();
                const numValue = parseInt(cleanValue, 10);
                if (!isNaN(numValue) && (numValue === 30 || numValue === 60)) {
                    return numValue;
                }
            }
            return null;
        }
        async function createExcelWorkbookWithStyles() {
            fileName = '';
            const workbook = new ExcelJS.Workbook();
            const sheetNames = ['Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sabado', 'Domingo'];
            const jsDayToSheetIndex = [6, 0, 1, 2, 3, 4, 5];
            sheetNames.forEach((sheetName, index) => {
                const dayOfWeekToFind = jsDayToSheetIndex.indexOf(index);
                const dayData = turnosData.filter(row => {
                    if (isLibre(row) || !(row.Fecha instanceof Date)) return false;
                    const rowDate = normalizeDate(row.Fecha);
                    return rowDate && rowDate.getDay() === dayOfWeekToFind;
                });
                
                if (dayData.length > 0) {
                    const fechaDia = dayData[0]['Fecha'];
                    const worksheet = workbook.addWorksheet(sheetName);
                    createStyledSheet(worksheet, dayData, fechaDia);
                }
            });
            if (weekSelector && weekSelector.value) {
                const monday = new Date(weekSelector.value);
                const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
                const d1 = normalizeDate(monday), d2 = normalizeDate(sunday);
                const day1 = String(d1.getDate()).padStart(2, '0');
                const day2 = String(d2.getDate()).padStart(2, '0');
                const monthName = d2.toLocaleString('es-ES', { month: 'long' });
                fileName = `Turno diario semana del ${day1} al ${day2} de ${monthName} ${d2.getFullYear()}.xlsx`;
            } else {
                throw new Error("No se pudo determinar el nombre del archivo.");
            }
            generatedWorkbook = workbook;
        }
        
        // ================================================================================================
        // === MOTOR DE ASIGNACIÃ“N DE DESCANSOS (BREAKS Y COLACIONES) ==
        // ================================================================================================
        
        // Esta funciÃ³n serÃ¡ reemplazada mÃ¡s abajo por una versiÃ³n actualizada
        function asignarDescansosSegunPlan(dayData) {
            // Este es un placeholder, la lÃ³gica real estÃ¡ en el bloque (function(){...})() al final del script.
            return dayData;
        }


        function createStyledSheet(worksheet, dayData, fechaDia) {
            
            // NUEVO: LÃ³gica condicional para descansos
            if (generarConDescansos) {
                dayData = asignarDescansosSegunPlan(dayData);
            } else {
                // Modo "sin descansos": solo muestra la duraciÃ³n de la colaciÃ³n
                dayData.forEach(agent => {
                    agent['Break1Str'] = '';
                    agent['Break2Str'] = '';
                    const duracion = getColacionDuration(agent);
                    if (duracion === 30) {
                        agent['Colacion30'] = 30;
                        agent['Colacion60'] = 'x';
                    } else if (duracion === 60) {
                        agent['Colacion30'] = 'x';
                        agent['Colacion60'] = 60;
                    } else {
                        agent['Colacion30'] = 'x';
                        agent['Colacion60'] = 'x';
                    }
                });
            }

            worksheet.columns = [ { width: 39.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10 } ];
            let rowIndex = 1;
            const fechaRow = worksheet.getRow(rowIndex);
            fechaRow.getCell(1).value = 'FECHA';
            fechaRow.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0B3041' } };
            fechaRow.getCell(1).font = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 };
            fechaRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            fechaRow.getCell(2).value = formatDate(fechaDia);
            worksheet.mergeCells(rowIndex, 2, rowIndex, 4);
            fechaRow.getCell(5).value = 'Permanencia';
            worksheet.mergeCells(rowIndex, 5, rowIndex, 6);
            fechaRow.getCell(5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0B3041' } };
            fechaRow.getCell(5).font = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 };
            fechaRow.getCell(5).alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            
            worksheet.mergeCells(rowIndex, 7, rowIndex, 10);
            const permanenciaCell = fechaRow.getCell(7);
            permanenciaCell.value = permanenciaText;
            permanenciaCell.font = { name: 'Calibri', size: 11, bold: true };
            for (let i = 1; i <= 10; i++) { fechaRow.getCell(i).border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } }; if (i !== 1 && i !== 5) { fechaRow.getCell(i).alignment = { horizontal: 'center', vertical: 'middle', wrapText: true }; } }
            
            rowIndex = 2;
            const headers = ['SUPERVISOR / ANALISTA', 'HORA INGRESO', 'FURGON', 'INICIO TURNO', 'Break1', '30 MIN COLACIÃ“N', '60 MIN COLACIÃ“N', 'Break2', 'TERMINO TURNO', 'HORA SALIDA'];
            const processDataRows = (rIndex, data, startCol = 1) => { 
                data.sort((a, b) => { const sA = a['Ini'] instanceof Date ? a['Ini'].getTime() : -1; const sB = b['Ini'] instanceof Date ? b['Ini'].getTime() : -1; if (sA !== sB) return sA - sB; const eA = a['FIN'] instanceof Date ? a['FIN'].getTime() : -1; const eB = b['FIN'] instanceof Date ? b['FIN'].getTime() : -1; return eA - eB; }).forEach(rowData => { const row = worksheet.getRow(rIndex); row.getCell(startCol).value = rowData['Nombre'] || ''; const iniCell = row.getCell(startCol + 3); iniCell.value = formatTime(rowData['Ini']); iniCell.font = { name: 'Calibri', size: 11, bold: true }; row.getCell(startCol + 4).value = rowData['Break1Str'] || ''; row.getCell(startCol + 7).value = rowData['Break2Str'] || ''; 
                row.getCell(startCol + 5).value = rowData['Colacion30'] || ''; 
                row.getCell(startCol + 6).value = rowData['Colacion60'] || ''; 
                const finCell = row.getCell(startCol + 8); finCell.value = formatTime(rowData['FIN']); finCell.font = { name: 'Calibri', size: 11, bold: true }; for (let i = 0; i < 10; i++) { const cell = row.getCell(startCol + i); cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } }; if (!cell.font) cell.font = { name: 'Calibri', size: 11 }; if (i > 0) cell.alignment = { horizontal: 'center', vertical: 'middle' }; } rIndex++; }); return rIndex; 
            };
            const processInactiveDataRows = (rIndex, data, startCol = 1) => {
                data.sort((a, b) => { const sA = a['Ini'] instanceof Date ? a['Ini'].getTime() : -1; const sB = b['Ini'] instanceof Date ? b['Ini'].getTime() : -1; if (sA !== sB) return sA - sB; const eA = a['FIN'] instanceof Date ? a['FIN'].getTime() : -1; const eB = b['FIN'] instanceof Date ? b['FIN'].getTime() : -1; return eA - eB; }).forEach(rowData => { const row = worksheet.getRow(rIndex); row.getCell(startCol).value = rowData['Nombre'] || ''; const iniCell = row.getCell(startCol + 3); iniCell.value = formatTime(rowData['Ini']); iniCell.font = { name: 'Calibri', size: 11, bold: true }; row.getCell(startCol + 4).value = rowData['Break1Str'] || ''; row.getCell(startCol + 7).value = rowData['Break2Str'] || ''; const finCell = row.getCell(startCol + 8); finCell.value = formatTime(rowData['FIN']); finCell.font = { name: 'Calibri', size: 11, bold: true }; row.getCell(startCol + 5).value = 'X'; row.getCell(startCol + 6).value = 'X';
                for (let i = 0; i < 10; i++) { const cell = row.getCell(startCol + i); if (!cell.value && cell.value !== 0) cell.value = ''; cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } }; if (!cell.font) cell.font = { name: 'Calibri', size: 11 }; if (i !== 0) cell.alignment = { horizontal: 'center', vertical: 'middle' }; } rIndex++; }); return rIndex;
            };
            const createHeaderRow = (rIndex, text, fill, startCol = 1) => { 
                const row = worksheet.getRow(rIndex);
                headers.forEach((header, index) => { const cell = row.getCell(startCol + index); cell.value = index === 0 ? text : header; cell.fill = fill; cell.font = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 }; cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true }; cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } }; });
                return rIndex + 1; 
            };
            
            rowIndex = createHeaderRow(rowIndex, 'SUPERVISOR / ANALISTA', { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF104862' } });
            const supervisores = dayData.filter(row => row['Servicio'] === '10_Staff_Inbound' && row['Estado'] === 'Activo');
            rowIndex = processDataRows(rowIndex, supervisores);
            rowIndex = createHeaderRow(rowIndex, 'AGENTE MASIVO', { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F5A87' } });
            const agentesSite = dayData.filter(row => row['Servicio'] === '01_Masivo' && row['Estado'] === 'Activo' && row['Lugar'] === 'Site');
            rowIndex = processDataRows(rowIndex, agentesSite);
            const teletrabajoData = dayData.filter(row => row['Servicio'] === '01_Masivo' && row['Estado'] === 'Activo' && row['Lugar'] === 'TT');
            if (teletrabajoData.length > 0) {
                const teletrabajoHeaderRow = worksheet.getRow(rowIndex);
                worksheet.mergeCells(rowIndex, 1, rowIndex, 10);
                const teletrabajoCell = teletrabajoHeaderRow.getCell(1);
                teletrabajoCell.value = 'TELETRABAJO';
                teletrabajoCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF047857' } };
                teletrabajoCell.font = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 };
                teletrabajoCell.alignment = { horizontal: 'center', vertical: 'middle' };
                for(let i=1; i<=10; i++) teletrabajoHeaderRow.getCell(i).border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                rowIndex++;
                rowIndex = processDataRows(rowIndex, teletrabajoData);
            }
            const inactivos = dayData.filter(row => row['Estado'] !== 'Activo');
            if (inactivos.length > 0) {
                const yellowFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };
                const blackFont = { color: { argb: 'FF000000' }, bold: true, name: 'Calibri', size: 11 };
                const border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                const inactivosHeaderRow = worksheet.getRow(rowIndex);
                worksheet.mergeCells(rowIndex, 1, rowIndex, 10);
                const mainInactiveCell = inactivosHeaderRow.getCell(1);
                mainInactiveCell.value = 'INACTIVO';
                mainInactiveCell.fill = yellowFill;
                mainInactiveCell.font = blackFont;
                mainInactiveCell.alignment = { horizontal: 'center', vertical: 'middle' };
                for(let i=1; i<=10; i++) inactivosHeaderRow.getCell(i).border = border;
                rowIndex++;
                rowIndex = processInactiveDataRows(rowIndex, inactivos);
            }
            
            const nightShiftStartCol = 12;
            worksheet.getColumn(nightShiftStartCol - 1).width = 10;
            worksheet.getColumn(nightShiftStartCol).width = 35;
            worksheet.getColumn(nightShiftStartCol + 1).width = 10;
            worksheet.getColumn(nightShiftStartCol + 2).width = 10;
            worksheet.getColumn(nightShiftStartCol + 3).width = 10;
            worksheet.getColumn(nightShiftStartCol + 4).width = 10;
            const nightShiftAgents = dayData.filter(row => {
                if (!(row['Ini'] instanceof Date)) return false;
                const d = row['Ini'];
                return d.getHours() === 0 && d.getMinutes() === 0;
            });
            if (nightShiftAgents.length > 0) {
                const headerRowIndex1 = 1, headerRowIndex2 = 2;
                const headerRow1 = worksheet.getRow(headerRowIndex1), headerRow2 = worksheet.getRow(headerRowIndex2);
                const headerFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F5A87' } };
                const headerFont = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 };
                const border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                const mainHeaderCell = headerRow1.getCell(nightShiftStartCol);
                const formattedDateHeader = `Turno de madrugada ${formatDate(fechaDia)}`;
                mainHeaderCell.value = formattedDateHeader.replace(/,/g, '');
                mainHeaderCell.fill = headerFill;
                mainHeaderCell.font = headerFont;
                mainHeaderCell.alignment = { horizontal: 'center', vertical: 'middle' };
                worksheet.mergeCells(headerRowIndex1, nightShiftStartCol, headerRowIndex1, nightShiftStartCol + 4);
                for (let i = 0; i < 5; i++) headerRow1.getCell(nightShiftStartCol + i).border = border;
                const headers2 = ['Nombre', 'Break 1', 'ColaciÃ³n 30', 'ColaciÃ³n 60', 'Break 2'];
                headers2.forEach((header, index) => {
                    const cell = headerRow2.getCell(nightShiftStartCol + index);
                    cell.value = header;
                    cell.fill = headerFill;
                    cell.font = headerFont;
                    cell.border = border;
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                });
                let dataRowIndex = headerRowIndex2 + 1;
                nightShiftAgents.forEach(rowData => {
                    const row = worksheet.getRow(dataRowIndex);
                    row.getCell(nightShiftStartCol).value = rowData['Nombre'] || '';
                    row.getCell(nightShiftStartCol + 1).value = rowData['Break1Str'] || '';
                    row.getCell(nightShiftStartCol + 2).value = rowData['Colacion30'] || 'X';
                    row.getCell(nightShiftStartCol + 3).value = rowData['Colacion60'] || 'X';
                    row.getCell(nightShiftStartCol + 4).value = rowData['Break2Str'] || '';
                    for (let i = 0; i < 5; i++) {
                        const cell = row.getCell(nightShiftStartCol + i);
                        cell.border = border;
                        cell.font = { name: 'Calibri', size: 11 };
                        cell.alignment = { horizontal: i === 0 ? 'left' : 'center', vertical: 'middle' };
                    }
                    dataRowIndex++;
                });
            }
        }
        // --- FIN: LÃ“GICA COMPLETA DE GENERACIÃ“N DE EXCEL ---

        document.addEventListener('DOMContentLoaded', loadDataFromFlow);
    </script>

<script>
(function(){
    
    // Sobreescribe la funciÃ³n de asignaciÃ³n para usar la nueva lÃ³gica de colaciones
    window.asignarDescansosSegunPlan = function(dayData){

        // =========================================================================
        // === INICIO: LÃ“GICA DE ASIGNACIÃ“N DE COLACIONES Y BREAKS (INTEGRADA)      ===
        // =========================================================================

        // 1. DefiniciÃ³n de ventanas y capacidades
        const VENTANAS_COLACION = {
            '00:00-08:00': { start: '03:00', end: '05:00' },'00:00-08:30': { start: '03:00', end: '05:00' },'00:00-09:00': { start: '03:00', end: '05:00' },'00:00-09:30': { start: '03:00', end: '05:00' },'00:00-10:00': { start: '03:00', end: '05:00' },'07:00-11:00': { start: '11:30', end: '12:00' },'07:00-14:00': { start: '11:00', end: '12:00' },'07:00-14:30': { start: '11:00', end: '12:00' },'07:00-15:00': { start: '11:00', end: '12:00' },'07:00-16:00': { start: '12:00', end: '13:00' },'07:00-17:00': { start: '12:00', end: '13:00' },'08:00-14:30': { start: '11:00', end: '12:00' },'08:00-16:00': { start: '12:00', end: '13:00' },'08:00-17:00': { start: '12:00', end: '14:00' },'08:00-18:00': { start: '13:00', end: '15:00' },'08:30-17:30': { start: '13:00', end: '15:00' },'08:30-18:30': { start: '13:00', end: '15:30' },'09:00-15:30': { start: '12:00', end: '13:00' },'09:00-17:00': { start: '14:00', end: '15:00' },'09:00-18:00': { start: '14:00', end: '16:00' },'09:00-19:00': { start: '14:00', end: '16:00' },'10:00-16:30': { start: '13:00', end: '14:00' },'10:00-17:00': { start: '13:00', end: '14:00' },'10:00-19:00': { start: '15:00', end: '16:00' },'10:00-20:00': { start: '15:00', end: '17:00' },'11:00-20:00': { start: '15:00', end: '16:00' },'12:00-18:30': { start: '14:00', end: '15:00' },'12:00-20:00': { start: '16:00', end: '17:00' },'12:00-22:00': { start: '16:00', end: '17:00' },'13:00-22:00': { start: '16:00', end: '17:00' },'14:00-00:00': { start: '16:00', end: '18:00' },'15:00-00:00': { start: '17:00', end: '19:00' },'16:00-00:00': { start: '18:00', end: '20:00' },'17:30-00:00': { start: '19:00', end: '20:00' }, '14:00-22:00': { start: '16:00', end: '17:00' }, 'fallback':    { start: '11:00', end: '15:00' }
        };
        const CAPACIDADES_COLACION = { '11': 5, '12': 5, '13': 5, '14': 9, '15': 9, '16': 7, '17': 7, '19': 3, 'madrugada': 1 };
        
        const VENTANAS_BREAKS = {
            '00:00-08:00': { break1: { start: '02:00', end: '03:00' }, break2: { start: '07:00', end: '08:00' } },'00:00-08:30': { break1: { start: '02:00', end: '03:00' }, break2: { start: '07:00', end: '08:00' } },'00:00-09:00': { break1: { start: '02:00', end: '03:00' }, break2: { start: '07:00', end: '08:00' } },'00:00-09:30': { break1: { start: '02:00', end: '03:00' }, break2: { start: '07:00', end: '08:00' } },'00:00-10:00': { break1: { start: '02:00', end: '03:00' }, break2: { start: '07:00', end: '08:00' } },'07:00-11:00': { break1: { start: '08:30', end: '09:00' }, break2: { start: '10:00', end: '10:45' } },'07:00-14:00': { break1: { start: '08:30', end: '09:00' }, break2: { start: '13:00', end: '13:45' } },'07:00-14:30': { break1: { start: '08:30', end: '09:30' }, break2: { start: '13:00', end: '14:00' } },'07:00-15:00': { break1: { start: '08:30', end: '09:30' }, break2: { start: '13:00', end: '14:00' } },'07:00-16:00': { break1: { start: '08:30', end: '10:00' }, break2: { start: '14:30', end: '15:45' } },'07:00-17:00': { break1: { start: '08:30', end: '10:00' }, break2: { start: '14:30', end: '16:30' } },'08:00-12:00': { break1: { start: '09:30', end: '10:00' }, break2: { start: '10:45', end: '11:45' } },'08:00-13:00': { break1: { start: '09:30', end: '10:00' }, break2: { start: '11:45', end: '12:45' } },'08:00-14:30': { break1: { start: '09:30', end: '10:00' }, break2: { start: '13:00', end: '14:00' } },'08:00-16:00': { break1: { start: '09:30', end: '10:00' }, break2: { start: '14:00', end: '15:45' } },'08:00-17:00': { break1: { start: '09:45', end: '11:00' }, break2: { start: '15:45', end: '16:45' } },'08:00-18:00': { break1: { start: '09:45', end: '11:00' }, break2: { start: '15:45', end: '17:45' } },'08:30-17:30': { break1: { start: '10:30', end: '11:30' }, break2: { start: '16:45', end: '17:00' } },'08:30-18:30': { break1: { start: '10:30', end: '11:30' }, break2: { start: '16:45', end: '18:00' } },'09:00-15:30': { break1: { start: '10:45', end: '11:45' }, break2: { start: '14:30', end: '15:30' } },'09:00-17:00': { break1: { start: '10:45', end: '11:45' }, break2: { start: '15:45', end: '16:45' } },'09:00-18:00': { break1: { start: '10:45', end: '11:45' }, break2: { start: '16:45', end: '17:45' } },'09:00-19:00': { break1: { start: '10:45', end: '12:00' }, break2: { start: '16:45', end: '18:45' } },'10:00-16:30': { break1: { start: '11:45', end: '12:45' }, break2: { start: '15:00', end: '16:30' } },'10:00-17:00': { break1: { start: '11:45', end: '12:45' }, break2: { start: '15:00', end: '16:30' } },'10:00-19:00': { break1: { start: '11:45', end: '12:45' }, break2: { start: '17:00', end: '18:30' } },'10:00-20:00': { break1: { start: '11:45', end: '12:45' }, break2: { start: '18:00', end: '19:00' } },'11:00-20:00': { break1: { start: '12:45', end: '13:45' }, break2: { start: '17:30', end: '19:00' } },'12:00-18:30': { break1: { start: '16:30', end: '16:45' }, break2: { start: '16:30', end: '18:00' } },'12:00-20:00': { break1: { start: '13:45', end: '14:45' }, break2: { start: '18:00', end: '19:15' } },'12:00-22:00': { break1: { start: '13:45', end: '14:45' }, break2: { start: '19:00', end: '21:00' } },'13:00-22:00': { break1: { start: '14:45', end: '15:30' }, break2: { start: '19:00', end: '21:00' } },'14:00-00:00': { break1: { start: '19:00', end: '20:00' }, break2: { start: '21:00', end: '22:00' } },'15:00-00:00': { break1: { start: '20:00', end: '21:00' }, break2: { start: '22:00', end: '23:00' } },'16:00-00:00': { break1: { start: '20:00', end: '21:00' }, break2: { start: '22:30', end: '23:00' } },'17:30-00:00': { break1: { start: '21:00', end: '22:00' }, break2: { start: '22:30', end: '23:30' } },'18:00-00:00': { break1: { start: '20:00', end: '21:30' }, break2: { start: '22:00', end: '23:00' } },'19:00-00:00': { break1: { start: '21:00', end: '22:00' }, break2: { start: '22:00', end: '23:30' } },'20:00-00:00': { break1: { start: '21:45', end: '22:15' }, break2: { start: '23:00', end: '23:30' } }, '14:00-22:00': { break1: { start: '19:00', end: '20:00' }, break2: { start: '21:00', end: '22:00' } }
        };

        // 2. Funciones auxiliares
        const addMinutes = (time, mins) => {
            if (!time) return '';
            const [hours, minutes] = time.split(':').map(Number);
            const date = new Date();
            date.setHours(hours, minutes + mins, 0, 0);
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        };
        
        const getCapacityForTime = (time, type) => {
            if (!time) return 99;
            const hour = parseInt(time.split(':')[0], 10);
            if (type === 'colacion') {
                if (hour >= 0 && hour < 7) return CAPACIDADES_COLACION['madrugada'];
                return CAPACIDADES_COLACION[String(hour)] || 99;
            } else { // type === 'break'
                if (hour >= 0 && hour < 7) return 1; // Madrugada
                if (hour >= 21) return 5; // Noche
                return 3; // Dia
            }
        };

        // 3. Inicializar trackers de capacidad
        const colacionCapacityTracker = {};
        const breakCapacityTracker = {};
        for (let h = 0; h < 24; h++) {
            for (let m = 0; m < 60; m += 15) {
                const timeSlot = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                colacionCapacityTracker[timeSlot] = 0;
                breakCapacityTracker[timeSlot] = 0;
            }
        }
        
        // 4. Filtrar agentes del servicio 01_Masivo
        const agentesActivos = dayData.filter(agent => agent['Estado'] === 'Activo' && agent['Servicio'] === '01_Masivo');
        
        // --- PROCESO DE COLACIONES ---
        for (const agent of agentesActivos) {
            const iniTurno = formatTime(agent['Ini']);
            const finTurno = formatTime(agent['FIN']);
            if (!iniTurno || !finTurno) continue;
            const duracionColacion = getColacionDuration(agent);
            if (!duracionColacion) { continue; }

            const turnoKey = `${iniTurno}-${finTurno}`;
            const ventana = VENTANAS_COLACION[turnoKey] || VENTANAS_COLACION['fallback'];
            const candidatos = [];
            let horaCandidata = ventana.start;

            while (horaCandidata < ventana.end) {
                // MEJORA DE SEGURIDAD: Asegura que la colaciÃ³n no sea antes de iniciar el turno
                if (horaCandidata < iniTurno) {
                    horaCandidata = addMinutes(horaCandidata, 15);
                    continue;
                }

                const minutosCandidato = parseInt(horaCandidata.split(':')[1], 10);
                if (duracionColacion === 60) {
                    if (minutosCandidato !== 0) {
                        horaCandidata = addMinutes(horaCandidata, 15);
                        continue;
                    }
                } else {
                    if (minutosCandidato !== 0 && minutosCandidato !== 30) {
                        horaCandidata = addMinutes(horaCandidata, 15);
                        continue;
                    }
                }

                const finColacion = addMinutes(horaCandidata, duracionColacion);
                if (finColacion <= finTurno || finTurno === "00:00") {
                    let congestionTotal = 0;
                    let esValido = true;
                    for (let i = 0; i < duracionColacion; i += 15) {
                        const bloqueActual = addMinutes(horaCandidata, i);
                        congestionTotal += colacionCapacityTracker[bloqueActual] || 0;
                        if ((colacionCapacityTracker[bloqueActual] || 0) >= getCapacityForTime(bloqueActual, 'colacion')) {
                            esValido = false;
                        }
                    }
                    candidatos.push({ hora: horaCandidata, congestion: congestionTotal, valido: esValido });
                }
                horaCandidata = addMinutes(horaCandidata, 15);
            }

            let mejorOpcion = null;
            const candidatosValidos = candidatos.filter(c => c.valido);
            if (candidatosValidos.length > 0) {
                mejorOpcion = candidatosValidos.sort((a, b) => a.congestion - b.congestion)[0];
            } else if (candidatos.length > 0) {
                mejorOpcion = candidatos.sort((a, b) => a.congestion - b.congestion)[0];
            }

            if (mejorOpcion) {
                agent.colacionAsignada = mejorOpcion.hora;
                for (let i = 0; i < duracionColacion; i += 15) {
                    const bloqueAfectado = addMinutes(mejorOpcion.hora, i);
                    if (colacionCapacityTracker.hasOwnProperty(bloqueAfectado)) {
                        colacionCapacityTracker[bloqueAfectado]++;
                    }
                }
            }
        }

        // --- PROCESO DE BREAKS ---
        const assignBreak = (breakType) => {
            for (const agent of agentesActivos) {
                const iniTurno = formatTime(agent['Ini']);
                if (!iniTurno) continue;

                const turnoKey = `${iniTurno}-${formatTime(agent['FIN'])}`;
                const ventanasTurno = VENTANAS_BREAKS[turnoKey];
                if (!ventanasTurno || !ventanasTurno[breakType]) continue;

                const ventana = ventanasTurno[breakType];
                let mejorOpcion = null;
                
                let candidatosBreak = [];
                for (let horaCandidata = ventana.start; horaCandidata < ventana.end; horaCandidata = addMinutes(horaCandidata, 15)) {
                    // MEJORA DE SEGURIDAD: Asegura que el break no sea antes de iniciar el turno
                    if (horaCandidata < iniTurno) {
                        continue;
                    }
                    candidatosBreak.push({ hora: horaCandidata, congestion: breakCapacityTracker[horaCandidata] || 0 });
                }

                if (candidatosBreak.length > 0) {
                    candidatosBreak.sort((a,b) => a.congestion - b.congestion);
                    const opcionMenosCongestionada = candidatosBreak[0].hora;
                    if ((breakCapacityTracker[opcionMenosCongestionada] || 0) < getCapacityForTime(opcionMenosCongestionada, 'break')) {
                        mejorOpcion = opcionMenosCongestionada;
                    }
                }

                if (mejorOpcion) {
                    agent[breakType === 'break1' ? 'break1Asignado' : 'break2Asignado'] = mejorOpcion;
                    breakCapacityTracker[mejorOpcion]++;
                }
            }
        };
        
        assignBreak('break1');
        assignBreak('break2');

        // Volcar todos los resultados al arreglo original
        dayData.forEach(originalAgent => {
            const processedAgent = agentesActivos.find(a => a.Nombre === originalAgent.Nombre);
            if (processedAgent) {
                if(processedAgent.colacionAsignada) {
                    const duracion = getColacionDuration(processedAgent);
                    if (duracion === 30) {
                        originalAgent['Colacion30'] = processedAgent.colacionAsignada;
                        originalAgent['Colacion60'] = 'x';
                    } else if (duracion === 60) {
                        originalAgent['Colacion60'] = processedAgent.colacionAsignada;
                        originalAgent['Colacion30'] = 'x';
                    }
                } else {
                    originalAgent['Colacion30'] = 'x';
                    originalAgent['Colacion60'] = 'x';
                }
                originalAgent['Break1Str'] = processedAgent.break1Asignado || '';
                originalAgent['Break2Str'] = processedAgent.break2Asignado || '';
            }
        });
        
        return dayData;
    };
})();
</script>
</body>
</html>
