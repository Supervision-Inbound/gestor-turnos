<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Turnos Rotativos</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%236a11cb' d='M50 0 L100 25 L100 75 L50 100 L0 75 L0 25 Z'%3E%3C/path%3E%3Cpath fill='%23ffffff' d='M50 20 L75 35 L75 65 L50 80 L25 65 L25 35 Z'%3E%3C/path%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-grad: radial-gradient(circle at 40% 30%, #0d1b2a 0%, #0a1a2a 30%, #11263d 70%, #081420 100%);
            --primary: #ffffff;
            --panel-bg: rgba(8, 20, 32, 0.72);
            --panel-border: rgba(0, 122, 255, 0.5); 
            --text: #ffffff;
            --muted: #9ec1d9;
            --font: 'Manrope', sans-serif;
            --success: #16a34a;
            --accent: #00e5ff; 
            --color-error: #dc3545;
            --transition-speed: 0.3s;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            display: grid;
            place-items: center;
            background: var(--bg-grad);
            font-family: var(--font);
            color: var(--text);
            overflow: auto; /* Allow scrolling */
            min-height: 100vh;
        }

        #neuronCanvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.85;
            pointer-events: none;
        }

        .main-container {
            position: relative; z-index: 2;
            width: min(1200px, 95vw);
            border-radius: 22px;
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            box-shadow: 0 0 40px rgba(66, 133, 244, 0.35), inset 0 0 0 1px rgba(255,255,255,0.04);
            animation: panelIn 700ms ease-out both, shadowPulse 8s ease-in-out infinite;
            overflow: hidden;
            margin: 2rem 0;
        }
        
        .content-panel { padding: 30px; }

        @keyframes panelIn { from { opacity: 0; transform: scale(0.95) translateY(6px);} to { opacity: 1; transform: scale(1) translateY(0);} }
        
        @keyframes shadowPulse {
            0%, 100% { box-shadow: 0 0 35px rgba(66, 133, 244, 0.3), inset 0 0 0 1px rgba(255,255,255,0.04); } /* Blue */
            25% { box-shadow: 0 0 50px rgba(219, 68, 55, 0.4), inset 0 0 0 1px rgba(255,255,255,0.04); } /* Red */
            50% { box-shadow: 0 0 35px rgba(244, 180, 0, 0.3), inset 0 0 0 1px rgba(255,255,255,0.04); } /* Yellow */
            75% { box-shadow: 0 0 50px rgba(15, 157, 88, 0.4), inset 0 0 0 1px rgba(255,255,255,0.04); } /* Green */
        }
        
        /* Upload Area Styling */
        .upload-card-wrapper { 
            display: grid;
            grid-template-columns: 35% 65%;
            gap: 1px;
            background: var(--panel-border);
            border: 1px solid var(--panel-border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .illustration-panel, .upload-content-panel {
             background: var(--panel-bg);
             padding: 40px;
        }
        .illustration-panel { 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center;
        }
        .illustration-panel h2 { color: var(--primary); font-size: 24px; font-weight: 700; margin-bottom: 1rem; }
        .illustration-panel p { font-size: 15px; color: var(--muted); line-height: 1.6; max-width: 300px; }
        .illustration-icon { 
            width: 100px; height: 100px; 
            color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            margin-bottom: 25px;
            animation: pulse 2s infinite; 
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .upload-area {
            border: 2px dashed var(--panel-border); border-radius: 12px; padding: 40px 20px; text-align: center; 
            transition: all 0.3s ease; cursor: pointer; background-color: rgba(0,0,0,0.2);
        }
        .upload-area:hover { border-color: var(--accent); box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); }
        #fileNameDisplay { font-size: 14px; font-weight: 600; color: var(--primary); word-break: break-all; margin-top: 15px; }
        input[type="file"] { display: none; }

        /* General UI Elements */
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--muted); }
        
        input[type="text"], input[type="time"], select {
            font-family: var(--font); font-size: 14px; padding: 10px 15px; border-radius: 8px;
            border: 1px solid var(--panel-border); background-color: rgba(0,0,0,0.2);
            color: var(--text); width: 100%; height: 42px;
            transition: all 0.3s ease;
        }
        input[type="text"]:focus, input[type="time"]:focus, select:focus {
             border-color: var(--accent); box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); outline: none;
        }
        
        .flatpickr-calendar {
            background: var(--panel-bg) !important;
            border: 1px solid var(--panel-border) !important;
        }

        .config-group { 
            margin-bottom: 25px; padding: 25px; background: rgba(0,0,0,0.2); border: 1px solid var(--panel-border); border-radius: 12px;
        }
        .config-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; align-items: start; }
        
        .date-range-group { display: flex; align-items: center; gap: 10px; }
        .week-display-area {
            background-color: transparent; border: 1px solid var(--panel-border);
            border-radius: 8px; padding: 10px; min-height: 42px;
            font-size: 13px; color: var(--muted);
        }
        .week-display-item { padding: 4px 0; font-weight: 600; }

        .shifts-config { border-top: 1px solid var(--panel-border); margin-top: 20px; padding-top: 20px; }
        .shift-list { max-height: 180px; overflow-y: auto; margin-bottom: 15px; padding-right: 10px;}
        .shift-item {
            display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: center;
            padding: 10px 15px; background-color: rgba(0,0,0,0.15); border-radius: 8px;
            border: 1px solid var(--panel-border); margin-bottom: 8px;
        }
        .shift-item.has-weight { grid-template-columns: 1fr 1fr 1fr 80px auto; }
        .shift-item span { font-weight: 600; font-size: 14px; }
        .shift-item .label { font-size: 11px; color: var(--muted); }
        .shift-weight-input { padding: 5px; height: 32px; text-align: center; }
        .remove-shift-btn {
            background: rgba(220, 53, 69, 0.2); border: 1px solid rgba(220, 53, 69, 0.5);
            color: var(--color-error); width: 32px; height: 32px; border-radius: 50%;
            cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
        }
        .remove-shift-btn:hover { background-color: var(--color-error); color: white; transform: scale(1.1); }
        .add-shift-form { display: grid; grid-template-columns: 1fr 1fr 110px auto; gap: 10px; align-items: end; border-top: 1px dashed var(--panel-border); padding-top: 15px; margin-bottom: 15px; }
        .add-shift-btn {
            background: linear-gradient(135deg, #108854, #16a34a);
            color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; height: 42px; transition: all 0.3s ease;
        }
        .add-shift-btn:hover { box-shadow:0 0 15px rgba(22,163,74,.6); transform:translateY(-2px); }

        .config-toggle-btn {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: none; border: 1px solid var(--panel-border); color: var(--muted);
            width: 100%; padding: 8px; border-radius: 8px; cursor: pointer; transition: all var(--transition-speed);
        }
        .config-toggle-btn:hover { background: rgba(0, 122, 255, 0.1); color: var(--primary); }
        .config-toggle-btn.open svg { transform: rotate(180deg); }
        .advanced-config {
            margin-top: 15px; border-top: 1px solid var(--panel-border);
            padding-top: 20px; display: none; flex-direction: column; gap: 25px;
        }
        .strategy-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .config-option h4 { font-size: 14px; margin-bottom: 12px; color: var(--primary); }
        .radio-group label { display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px; font-size: 14px; font-weight: 400; color: var(--muted); }

        /* Buttons */
        .button-row { display: flex; gap: 15px; justify-content: center; align-items: stretch; margin-top: 25px; }
        .btn-action {
            flex: 1; height: 50px; font-size: 16px; font-weight: 600; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; border: none;
            cursor: pointer; transition: all 0.3s ease;
        }
        .generate-btn {
            background: linear-gradient(135deg, #7b2ff7, #f107a3); color: white;
        }
        .generate-btn:hover:not(:disabled) { box-shadow:0 0 20px rgba(241, 7, 163, 0.6); transform:translateY(-2px); }
        .download-btn {
            background: #495057; color: #adb5bd; cursor: not-allowed;
        }
        .download-btn.enabled {
             background: linear-gradient(135deg, #108854, #16a34a); color: white; cursor: pointer;
        }
        .download-btn.enabled:hover { box-shadow:0 0 20px rgba(22,163,74,.6); transform:translateY(-2px); }
        .btn-action:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Generated Schedule Display */
        .agent-section { 
            background: rgba(0,0,0,0.1); border: 1px solid var(--panel-border);
            display: grid; grid-template-columns: 3fr 1fr; gap: 20px; padding: 20px; 
            border-radius: 12px; margin-bottom: 20px;
        }
        .agent-header { margin-bottom: 12px; font-size: 18px; font-weight: 700; color: var(--primary); }
        .table-container { max-height: 400px; overflow-y: auto; }
        .schedule-table { width: 100%; border-collapse: collapse; }
        .schedule-table th, .schedule-table td { padding: 8px 6px; text-align: center; border-bottom: 1px solid var(--panel-border); }
        .schedule-table th { font-size: 10px; text-transform: uppercase; color: var(--muted); }
        .schedule-table td { font-size: 12px; font-weight: 500; }
        .schedule-table .day-name { font-weight: 600; text-align: left; }
        .schedule-table .libre-day td { color: var(--muted); font-style: italic; }
        .validation-sidebar { 
            background: rgba(0,0,0,0.2); border: 1px solid var(--panel-border);
            border-radius: 8px; padding: 15px; height: fit-content; 
        }
        .validation-status { font-size: 14px; font-weight: 600; margin-bottom: 15px; padding: 10px; border-radius: 8px; text-align: center; }
        .validation-status.valid { background: rgba(22, 163, 74, 0.2); color: var(--success); border: 1px solid rgba(22, 163, 74, 0.5); }
        .validation-status.warning { background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.5); color: #f59e0b; }
        .validation-status.error { background: rgba(220, 53, 69, 0.2); color: var(--color-error); border: 1px solid rgba(220, 53, 69, 0.5); }
        .validation-details { list-style-type: none; padding-left: 0; }
        .validation-details li { margin-bottom: 6px; font-weight: 500; font-size: 12px; line-height: 1.4; color: var(--primary); }
        .status-message { text-align: center; margin-top: 20px; padding: 15px; border-radius: 10px; display: none; }
        .status-message.success { background: rgba(22, 163, 74, 0.2); border: 1px solid rgba(22, 163, 74, 0.5); color: var(--success); display: block; }
        .status-message.error { background: rgba(220, 53, 69, 0.2); border: 1px solid rgba(220, 53, 69, 0.5); color: var(--color-error); display: block; }

        /* Responsive */
        @media (max-width: 900px) { .upload-card-wrapper { grid-template-columns: 1fr; } .agent-section { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .config-grid, .add-shift-form, .strategy-grid { grid-template-columns: 1fr; } }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
</head>
<body>
    <canvas id="neuronCanvas"></canvas>
    
    <div class="main-container">
        <div class="content-panel">
            <div id="initial-view-wrapper">
                <div class="upload-view">
                    <div class="upload-card-wrapper">
                         <div class="illustration-panel">
                            <div class="illustration-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                                </svg>
                            </div>
                            <h2>Generación Inteligente de Horarios</h2>
                            <p>Sube tu lista de personal, define el periodo y crea automáticamente horarios de turnos optimizados y en cumplimiento con la normativa legal.</p>
                        </div>
                        <div class="upload-content-panel">
                            <div class="upload-area" id="dropZone">
                                <input type="file" id="fileInput" accept=".xlsx, .xls">
                                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor" viewBox="0 0 16 16" style="color: var(--muted);"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>
                                <p style="font-weight: 600; color: var(--primary); margin-top: 15px;">Arrastra y suelta tu archivo Excel</p>
                                <p style="font-size: 13px; color: var(--muted); margin-top: 5px;">o haz clic para seleccionarlo</p>
                                <div id="fileNameDisplay"></div>
                                <small style="display: block; margin-top: 15px; font-size: 12px; color: var(--muted);">Formato: Columna A: RUT, Columna B: Nombre, Columna C: Horas contractuales</small>
                            </div>
                            <div id="statusMessageContainer" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <main class="generator-view" style="display: none;">
                <h1 style="text-align:center; margin-bottom: 2rem; font-size: 1.8rem;">Configuración de Turnos</h1>
                <div class="config-group">
                    <div class="config-grid">
                        <div>
                            <label>Rango de Fechas</label>
                            <div class="date-range-group">
                                <input type="text" id="startDate" placeholder="Fecha de Inicio">
                                <span style="color: var(--muted);">a</span>
                                <input type="text" id="endDate" placeholder="Fecha de Término">
                            </div>
                        </div>
                        <div>
                            <label>Semanas a Generar</label>
                            <div id="weekDisplayArea" class="week-display-area"></div>
                        </div>
                    </div>
                    <div class="shifts-config">
                        <label>Tipos de Turno para la Generación</label>
                        <div id="shift-list-container" class="shift-list"></div>
                        <div class="add-shift-form">
                            <div>
                                <label style="font-size: 12px;">Inicio</label>
                                <input type="time" id="newShiftStart" value="08:00">
                            </div>
                            <div>
                                <label style="font-size: 12px;">Término</label>
                                <input type="time" id="newShiftEnd" value="17:00">
                            </div>
                            <div>
                                <label style="font-size: 12px;">Colación (min)</label>
                                <select id="newShiftBreak">
                                    <option value="60">60</option>
                                    <option value="30">30</option>
                                    <option value="0">0</option>
                                </select>
                            </div>
                            <button id="addShiftBtn" class="add-shift-btn">Agregar</button>
                        </div>

                        <button class="config-toggle-btn" id="config-toggle-btn">
                            <span>Configuración Avanzada</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                        </button>

                        <div class="advanced-config" id="advanced-config">
                            <div class="config-option">
                                <h4>Aplicar configuración a:</h4>
                                <select id="weekSelector"></select>
                                <small id="current-config-info" style="display: block; margin-top: 10px; font-size: 12px; color: var(--muted);"></small>
                            </div>
                            <div class="per-week-config" id="per-week-config">
                                <div class="strategy-grid">
                                    <div class="config-option">
                                        <h4>Estrategia de Distribución de Turnos</h4>
                                        <div class="radio-group" id="distributionGroup">
                                            <label><input type="radio" name="distribution" value="equitable" checked> Distribuir equitativamente</label>
                                            <label><input type="radio" name="distribution" value="weighted"> Distribuir por peso</label>
                                        </div>
                                    </div>
                                    <div class="config-option">
                                        <h4>Estrategia de Días Libres</h4>
                                        <div class="radio-group" id="dayOffGroup">
                                            <label><input type="radio" name="dayOff" value="equitable_off" checked> Equitativo (1 día en sem. + 1 en finde)</label>
                                            <label><input type="radio" name="dayOff" value="weekend"> Libre Sábado y Domingo</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="button-row">
                        <button class="btn-action generate-btn" id="generateBtn" disabled>Generar Horarios</button>
                        <button class="btn-action download-btn" id="downloadBtn" disabled>Descargar Horario</button>
                    </div>
                </div>
                <div id="generationArea" style="display: none; margin-top: 2rem;">
                    <div id="generationContainer"></div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- ANIMACIÓN DE FONDO ---
        const canvas = document.getElementById('neuronCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particlesArray;

        class Particle {
             constructor(x, y, size, speedX, speedY) {
                this.x = x; this.y = y; this.size = size;
                this.speedX = speedX; this.speedY = speedY;
                this.pulseSpeed = Math.random() * 0.02 + 0.005;
                this.pulseOffset = Math.random() * Math.PI * 2;
            }
            draw() {
                const pulse = Math.abs(Math.sin(this.pulseOffset + Date.now() * this.pulseSpeed));
                const alpha = 0.5 + pulse * 0.5;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
                ctx.shadowBlur = 10;
                ctx.shadowColor = `rgba(0, 122, 255, ${alpha})`;
                ctx.fillStyle = `rgba(200, 225, 255, ${alpha})`;
                ctx.fill();
                ctx.shadowBlur = 0;
            }
            update() {
                if (this.x > canvas.width || this.x < 0) this.speedX = -this.speedX;
                if (this.y > canvas.height || this.y < 0) this.speedY = -this.speedY;
                this.x += this.speedX; this.y += this.speedY;
            }
        }

        function initParticles() {
            particlesArray = [];
            let numberOfParticles = (canvas.height * canvas.width) / 12000;
            for (let i = 0; i < numberOfParticles; i++) {
                let size = (Math.random() * 1.5) + 0.8;
                let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
                let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
                let speedX = (Math.random() * 0.4) - 0.2;
                let speedY = (Math.random() * 0.4) - 0.2;
                particlesArray.push(new Particle(x, y, size, speedX, speedY));
            }
        }

        function connectParticles() {
             let opacityValue = 1;
            for (let a = 0; a < particlesArray.length; a++) {
                for (let b = a; b < particlesArray.length; b++) {
                    let distance = ((particlesArray[a].x - particlesArray[b].x) ** 2) + ((particlesArray[a].y - particlesArray[b].y) ** 2);
                    if (distance < (canvas.width / 10) * (canvas.height / 10)) {
                        opacityValue = 1 - (distance / 20000);
                        ctx.strokeStyle = `rgba(0, 122, 255, ${opacityValue * 0.25})`;
                        ctx.lineWidth = 0.8;
                        ctx.beginPath();
                        ctx.moveTo(particlesArray[a].x, particlesArray[a].y);
                        ctx.lineTo(particlesArray[b].x, particlesArray[b].y);
                        ctx.stroke();
                    }
                }
            }
        }

        function animateParticles() {
            requestAnimationFrame(animateParticles);
            ctx.clearRect(0, 0, innerWidth, innerHeight);
            particlesArray.forEach(p => { p.update(); p.draw(); });
            connectParticles();
        }

        window.addEventListener('resize', () => {
            canvas.width = innerWidth;
            canvas.height = innerHeight;
            initParticles();
        });

        initParticles();
        animateParticles();
        
        // --- INICIALIZACIÓN DE CALENDARIOS ---
        let weeklyConfigurations = new Map();
        const weekSelector = document.getElementById('weekSelector');
        const perWeekConfig = document.getElementById('per-week-config');
        const currentConfigInfo = document.getElementById('current-config-info');
        
        function updateWeekDisplay() {
            const weekDisplayArea = document.getElementById('weekDisplayArea');
            const startDatePicker = document.getElementById('startDate')._flatpickr;
            const endDatePicker = document.getElementById('endDate')._flatpickr;
            
            weekDisplayArea.innerHTML = '';
            weekSelector.innerHTML = '<option value="all-weeks" selected>Todas las Semanas</option>';
            perWeekConfig.style.display = 'none';
            currentConfigInfo.textContent = 'Configuración por defecto: Equitativa y Libre Sáb+Dom.';
            
            if (startDatePicker.selectedDates.length === 0 || endDatePicker.selectedDates.length === 0) {
                return;
            }

            let startDate = new Date(startDatePicker.selectedDates[0]);
            startDate.setHours(0,0,0,0);
            const endDate = new Date(endDatePicker.selectedDates[0]);
            endDate.setHours(0,0,0,0);
            
            if (startDate > endDate) return;

            weeklyConfigurations.clear();
            let currentWeekStart = getMonday(startDate);

            while (currentWeekStart <= endDate) {
                let currentWeekEnd = new Date(currentWeekStart);
                currentWeekEnd.setDate(currentWeekEnd.getDate() + 6);
                
                const weekKey = currentWeekStart.toISOString().split('T')[0];
                
                const options = { day: 'numeric', month: 'long' };
                const formattedStart = currentWeekStart.toLocaleDateString('es-ES', options);
                const formattedEnd = currentWeekEnd > endDate ? endDate.toLocaleDateString('es-ES', options) : currentWeekEnd.toLocaleDateString('es-ES', options);

                const weekLabel = `del ${formattedStart} al ${formattedEnd}`;
                
                const weekElement = document.createElement('div');
                weekElement.className = 'week-display-item';
                weekElement.textContent = weekLabel;
                weekDisplayArea.appendChild(weekElement);
                
                const option = document.createElement('option');
                option.value = weekKey;
                option.textContent = weekLabel;
                weekSelector.appendChild(option);
                
                weeklyConfigurations.set(weekKey, { distribution: 'equitable', dayOffStrategy: 'weekend' });
                
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            }
            
            updateConfigDisplay(weeklyConfigurations.get(weekSelector.value) || { distribution: 'equitable', dayOffStrategy: 'weekend' });
        }
        
        function updateConfigDisplay(config) {
            document.querySelector(`input[name="distribution"][value="${config.distribution}"]`).checked = true;
            document.querySelector(`input[name="dayOff"][value="${config.dayOffStrategy}"]`).checked = true;
            renderShiftPool();
        }
        
        weekSelector.addEventListener('change', (e) => {
            const selectedWeekKey = e.target.value;
            if (selectedWeekKey === 'all-weeks') {
                perWeekConfig.style.display = 'none';
                currentConfigInfo.textContent = 'Configuración por defecto: Equitativa y Libre Sáb+Dom.';
            } else {
                perWeekConfig.style.display = 'block'; // Changed to block
                const config = weeklyConfigurations.get(selectedWeekKey);
                updateConfigDisplay(config);
                currentConfigInfo.textContent = 'Modificando la configuración para la semana seleccionada.';
            }
        });
        
        document.querySelectorAll('input[name="distribution"], input[name="dayOff"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const selectedWeekKey = weekSelector.value;
                if (selectedWeekKey !== 'all-weeks') {
                    const config = weeklyConfigurations.get(selectedWeekKey);
                    config.distribution = document.querySelector('input[name="distribution"]:checked').value;
                    config.dayOffStrategy = document.querySelector('input[name="dayOff"]:checked').value;
                    weeklyConfigurations.set(selectedWeekKey, config);
                    renderShiftPool(); // Vuelve a renderizar los pesos si la estrategia cambia
                }
            });
        });

        flatpickr("#startDate, #endDate", { 
            altInput: true, 
            altFormat: "j F, Y", 
            dateFormat: "Y-m-d", 
            "locale": "es",
            onClose: function(selectedDates, dateStr, instance) {
                updateWeekDisplay();
            }
        });

        // --- LÓGICA DEL GENERADOR ---
        let employeeList = [];
        let generatedSchedules = new Map();
        let shiftPool = [
            { start: "08:00", end: "18:00", break: 60, worked: 9, weight: 1 },
            { start: "10:00", end: "20:00", break: 60, worked: 9, weight: 1 },
            { start: "14:00", end: "00:00", break: 60, worked: 9, weight: 5 }
        ];

        const dropZone = document.getElementById('dropZone'), fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay'), statusMessageContainer = document.getElementById('statusMessageContainer');
        const generateBtn = document.getElementById('generateBtn');
        const generationArea = document.getElementById('generationArea'), generationContainer = document.getElementById('generationContainer');
        const downloadBtn = document.getElementById('downloadBtn'), addShiftBtn = document.getElementById('addShiftBtn');
        const shiftListContainer = document.getElementById('shift-list-container');
        const configToggleBtn = document.getElementById('config-toggle-btn');
        const advancedConfigPanel = document.getElementById('advanced-config');
        
        // --- GESTIÓN DE TURNOS Y CONFIG AVANZADA ---
        function renderShiftPool() {
            shiftListContainer.innerHTML = '';
            const isWeighted = document.querySelector('input[name="distribution"]:checked').value === 'weighted';
            
            shiftPool.forEach((shift, index) => {
                const item = document.createElement('div');
                item.className = 'shift-item' + (isWeighted ? ' has-weight' : '');
                item.innerHTML = `
                    <div><div class="label">Inicio</div><span>${shift.start}</span></div>
                    <div><div class="label">Término</div><span>${shift.end}</span></div>
                    <div><div class="label">Colación</div><span>${shift.break} min</span></div>
                    ${isWeighted ? `<div><div class="label">Peso</div><input type="number" class="shift-weight-input" data-index="${index}" value="${shift.weight || 1}" min="1"></div>` : ''}
                    <button class="remove-shift-btn" data-index="${index}">&times;</button>
                `;
                shiftListContainer.appendChild(item);
            });
        }
        configToggleBtn.addEventListener('click', () => {
            const isOpen = advancedConfigPanel.style.display === 'block'; // Changed to block
            advancedConfigPanel.style.display = isOpen ? 'none' : 'block'; // Changed to block
            configToggleBtn.classList.toggle('open', !isOpen);
        });
        document.querySelectorAll('input[name="distribution"]').forEach(radio => {
            radio.addEventListener('change', renderShiftPool);
        });
        shiftListContainer.addEventListener('input', (e) => {
            if (e.target.classList.contains('shift-weight-input')) {
                const index = parseInt(e.target.dataset.index);
                shiftPool[index].weight = parseInt(e.target.value) || 1;
            }
        });
        addShiftBtn.addEventListener('click', () => {
            const startEl = document.getElementById('newShiftStart'), endEl = document.getElementById('newShiftEnd'), breakEl = document.getElementById('newShiftBreak');
            if (!startEl.value || !endEl.value || !breakEl.value) { alert("Completa todos los campos para agregar un turno."); return; }
            const startMinutes = timeToMinutes(startEl.value), endMinutes = timeToMinutes(endEl.value);
            const durationMinutes = endMinutes < startMinutes ? (1440 - startMinutes) + endMinutes : endMinutes - startMinutes;
            const workedHours = (durationMinutes - parseInt(breakEl.value)) / 60;
            shiftPool.push({ start: startEl.value, end: endEl.value, break: parseInt(breakEl.value), worked: workedHours, weight: 1 });
            renderShiftPool();
        });
        shiftListContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-shift-btn')) {
                shiftPool.splice(parseInt(e.target.dataset.index), 1);
                renderShiftPool();
            }
        });
        renderShiftPool();

        // --- LÓGICA DE ARCHIVOS Y GENERACIÓN ---
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => e.target.files.length && handleFileSelect(e.target.files[0]));
        function handleFileSelect(file) {
            if (!file) return; 
            fileNameDisplay.textContent = `Archivo: ${file.name}`;
            showStatus('Procesando archivo...', 'success');
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type:'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, {header:1});
                    if (json.length < 2) throw new Error("Archivo vacío.");
                    employeeList = json.slice(1).map(r=>({rut:String(r[0]||'').trim(),nombre:String(r[1]||'').trim(),contractHours: parseFloat(r[2]) || 44})).filter(e=>e.rut&&e.nombre);
                    if (employeeList.length === 0) throw new Error("No se encontraron empleados válidos.");
                    showStatus(`Se cargaron ${employeeList.length} ejecutivos.`, 'success');
                    
                    // Hide initial view and show generator view
                    document.getElementById('initial-view-wrapper').style.display = 'none';
                    document.querySelector('.generator-view').style.display = 'block';

                    generateBtn.disabled = false;
                } catch (error) { showStatus(`Error: ${error.message}`, 'error'); }
            };
            reader.readAsArrayBuffer(file);
        }

        generateBtn.addEventListener('click', async () => {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const contractHours = null; // per-employee from file
            
            if (!startDate || !endDate) { alert("Selecciona un rango de fechas."); return; }
            if (new Date(startDate) >= new Date(endDate)) { alert("La fecha de inicio debe ser anterior a la de término."); return; }
            if (shiftPool.length === 0) { alert("Debes tener al menos un tipo de turno."); return; }
            
            const allWeeksMode = weekSelector.value === 'all-weeks';
            const globalOptions = allWeeksMode ? {
                distribution: document.querySelector('input[name="distribution"]:checked').value,
                dayOffStrategy: document.querySelector('input[name="dayOff"]:checked').value
            } : null;

            generateBtn.disabled = true; generateBtn.innerHTML = '⏳ Generando...';
            await new Promise(resolve => setTimeout(resolve, 250));
            try {
                generatedSchedules = scheduleGenerator(employeeList, startDate, endDate, contractHours, shiftPool, globalOptions);
                displaySchedules(generatedSchedules);
                generationArea.style.display = 'block'; downloadBtn.disabled = false; downloadBtn.classList.add('enabled');
            } catch (error) { alert(`Ocurrió un error: ${error.message}`); }
            finally { generateBtn.disabled = false; generateBtn.innerHTML = 'Generar Horarios'; }
        });

        function scheduleGenerator(employees, startDateStr, endDateStr, contractHours, shifts, globalOptions) {
            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');
            endDate.setHours(23, 59, 59, 999); 

            const schedules = new Map();
            const employeeShiftAssignments = employees.map(() => ({
                shiftCycle: [...shifts].sort(() => 0.5 - Math.random()),
                cycleIndex: 0
            }));
            
            // Re-render shifts with correct weights based on global config if applicable
            if (globalOptions) {
                document.querySelector(`input[name="distribution"][value="${globalOptions.distribution}"]`).checked = true;
                renderShiftPool();
            }

            for (const [employeeIndex, employee] of employees.entries()) {
                let schedule = [],
                    weeklyData = { hours: 0, workedDays: 0, sundays: 0 },
                    lastShiftEnd = null,
                    currentMonth = -1,
                    shiftOfTheWeek = null,
                    weeklyOffDays = [],
                    shortShiftDay = -1,
                    lastWeeksShift = null;

                for (let day = new Date(startDate); day <= endDate; day.setDate(day.getDate() + 1)) {
                    const dayOfWeek = day.getDay();
                    const isFirstDay = day.getTime() === startDate.getTime();
                    
                    const currentWeekKey = getMonday(day).toISOString().split('T')[0];
                    const weekOptions = globalOptions || weeklyConfigurations.get(currentWeekKey) || { distribution: 'equitable', dayOffStrategy: 'weekend' };


                    if (day.getMonth() !== currentMonth) {
                        currentMonth = day.getMonth();
                        weeklyData.sundays = 0;
                    }
                    
                    if (dayOfWeek === 1 || (isFirstDay && schedule.length === 0) ) {
                        weeklyData = { hours: 0, workedDays: 0, sundays: weeklyData.sundays };
                        
                        if (weekOptions.dayOffStrategy === 'equitable_off') {
                            const weekdays = [1, 2, 3, 4, 5]; 
                            const weekendDays = [0, 6];
                            
                            const randomWeekdayOff = weekdays[Math.floor(Math.random() * weekdays.length)];
                            const potentialShortDays = weekdays.filter(d => d !== randomWeekdayOff);
                            
                            shortShiftDay = potentialShortDays[Math.floor(Math.random() * potentialShortDays.length)];
                            
                            const randomWeekendOff = weekendDays[Math.floor(Math.random() * weekendDays.length)];
                            
                            weeklyOffDays = [randomWeekdayOff, randomWeekendOff];

                        } else if (weekOptions.dayOffStrategy === 'weekend') {
                            weeklyOffDays = [6, 0];
                            const weekdays = [1, 2, 3, 4, 5];
                            shortShiftDay = weekdays[Math.floor(Math.random() * weekdays.length)];
                        }

                        if (weekOptions.distribution === 'equitable') {
                            const assignment = employeeShiftAssignments[employeeIndex];
                            const shiftCycle = assignment.shiftCycle;
                            let newShift = null;
                            
                            for (let i = 0; i < shiftCycle.length; i++) {
                                let potentialShift = shiftCycle[(assignment.cycleIndex + i) % shiftCycle.length];
                                if (shiftCycle.length <= 1 || potentialShift !== lastWeeksShift) {
                                    newShift = potentialShift;
                                    assignment.cycleIndex = (assignment.cycleIndex + i + 1) % shiftCycle.length;
                                    break;
                                }
                            }
                            if (!newShift) {
                                newShift = shiftCycle[assignment.cycleIndex];
                                assignment.cycleIndex = (assignment.cycleIndex + 1) % shiftCycle.length;
                            }
                            shiftOfTheWeek = newShift;
                            lastWeeksShift = shiftOfTheWeek;
                        }
                    }

                    const daySch = { date: new Date(day), dayName: day.toLocaleDateString('es-ES', { weekday: 'long' }), isWorkDay: false };
                    let forceFree = false;

                    if (weeklyOffDays.includes(dayOfWeek)) {
                        forceFree = true;
                    }
                    
                    if (dayOfWeek === 0) {
                        const maxSundays = getSundaysInMonth(day.getFullYear(), day.getMonth()).length - 2;
                        if (weeklyData.sundays >= maxSundays) forceFree = true;
                    }

                    if (forceFree) {
                        schedule.push(daySch);
                        continue;
                    }

                    let shiftToAssign = null;
                    let start = null;
                    let potentialShifts = [];

                    if (weekOptions.distribution === 'equitable' && shiftOfTheWeek) {
                        potentialShifts.push(shiftOfTheWeek);
                        shifts.forEach(s => { if (s !== shiftOfTheWeek) potentialShifts.push(s); });
                    } else {
                        potentialShifts = [...shifts].sort(() => 0.5 - Math.random());
                    }

                    for (const potentialShift of potentialShifts) {
                        const tempStart = new Date(day);
                        const [h, m] = potentialShift.start.split(':');
                        tempStart.setHours(h, m, 0, 0);

                        if (!lastShiftEnd || (tempStart.getTime() - lastShiftEnd.getTime()) / 36e5 >= 12) {
                            shiftToAssign = potentialShift;
                            start = tempStart;
                            break; 
                        }
                    }

                    if (shiftToAssign) {
                        let end = new Date(start.getTime() + (shiftToAssign.worked * 60 + shiftToAssign.break) * 60000);
                        let finalWorkedHours = shiftToAssign.worked;

                        if (dayOfWeek === shortShiftDay) {
                           finalWorkedHours -= 1;
                           end.setHours(end.getHours() - 1);
                        }

                        Object.assign(daySch, {
                            isWorkDay: true, start, end, 
                            colacion: shiftToAssign.break, workedHours: finalWorkedHours
                        });
                        weeklyData.hours += finalWorkedHours;
                        weeklyData.workedDays++;
                        if (dayOfWeek === 0) weeklyData.sundays++;
                        lastShiftEnd = end;
                    }
                    schedule.push(daySch);
                }
                schedules.set(employee.rut, { nombre: employee.nombre, schedule, contractHours: employee.contractHours || 44 });
            }
            return schedules;
        }

        function displaySchedules(schedules) {
            generationContainer.innerHTML = '';
            schedules.forEach((data) => {
                const section = document.createElement('div');
                section.className = 'agent-section';
                section.innerHTML = `
                    <div class="shifts-section">
                        <div class="agent-header">${data.nombre}</div>
                        <div class="table-container">
                            <table class="schedule-table">
                                <thead><tr><th>Día</th><th>Inicio</th><th>Término</th><th>Colación (min)</th><th>HH. Trab.</th></tr></thead>
                                <tbody>${data.schedule.map(day => `
                                    <tr class="${day.isWorkDay ? '' : 'libre-day'}">
                                        <td class="day-name">${day.dayName.charAt(0).toUpperCase() + day.dayName.slice(1)}</td>
                                        <td>${day.isWorkDay ? formatTime(day.start) : 'LIBRE'}</td>
                                        <td>${day.isWorkDay ? formatTime(day.end) : '--'}</td>
                                        <td>${day.isWorkDay ? day.colacion : '--'}</td>
                                        <td class="worked-hours">${day.isWorkDay ? day.workedHours.toFixed(1) : '--'}</td>
                                    </tr>`).join('')}</tbody>
                            </table>
                        </div>
                    </div>
                    <div class="validation-sidebar"><div class="validation-status"></div><ul class="validation-details"></ul></div>`;
                generationContainer.appendChild(section);
                validateGeneratedSchedule(section, data.schedule, data.contractHours);
            });
        }
        function validateGeneratedSchedule(agentSection, schedule, contractHours) {
            let messages = [], status = 'valid', weeklyTotals = new Map(), monthlyTotals = new Map();
            
            schedule.forEach(day => {
                const monday = getMonday(day.date).toISOString().split('T')[0];
                const monthKey = `${day.date.getFullYear()}-${day.date.getMonth()}`;

                if (!weeklyTotals.has(monday)) {
                    weeklyTotals.set(monday, { hours: 0, workedDays: 0 });
                }
                if (!monthlyTotals.has(monthKey)) {
                    monthlyTotals.set(monthKey, { sundaysWorked: 0, monthName: day.date.toLocaleDateString('es-ES', {month: 'long'}) });
                }

                if (day.isWorkDay) {
                    const d = weeklyTotals.get(monday);
                    d.hours += parseFloat(day.workedHours) || 0;
                    d.workedDays++;
                    if (day.date.getDay() === 0) {
                        monthlyTotals.get(monthKey).sundaysWorked++;
                    }
                }
            });

            weeklyTotals.forEach((week, weekId) => {
                const weekStart = new Date(weekId + 'T00:00:00');
                const weekName = `Semana del ${weekStart.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit'})}`;
                if (week.hours > contractHours) { status = 'error'; messages.push(`⛔ Horas excedidas (${weekName}): ${week.hours.toFixed(1)}h.`); }
                else if (week.hours < contractHours && week.workedDays > 0) { if (status !== 'error') status = 'warning'; messages.push(`⚠️ Horas insuficientes (${weekName}): ${week.hours.toFixed(1)}h.`); }
                if (week.workedDays > 6) { status = 'error'; messages.push(`⛔ Sin día libre (${weekName}): ${week.workedDays} días.`); }
            });
            
            monthlyTotals.forEach((month, monthId) => {
                 messages.push(`ℹ️ Domingos trabajados en ${month.monthName}: ${month.sundaysWorked}`);
            });

            let restOk = true;
            for (let i = 1; i < schedule.length; i++) {
                if (schedule[i-1].isWorkDay && schedule[i].isWorkDay && (schedule[i].start.getTime() - schedule[i-1].end.getTime())/36e5 < 12) {
                    status = 'error'; messages.push(`⛔ Descanso < 12h entre ${schedule[i-1].dayName} y ${schedule[i].dayName}.`); restOk = false;
                }
            }
            if (restOk) messages.push(`✅ Descanso entre turnos cumplido.`);
            
            if (status === 'valid' && messages.every(m => !m.startsWith('⛔'))) {
                 messages.unshift('✅ Todas las reglas cumplidas.');
            }
            const s = agentSection.querySelector('.validation-status'), d = agentSection.querySelector('.validation-details');
            s.className = `validation-status ${status}`; s.textContent = status === 'valid' ? 'Cumple Normativa' : status === 'warning' ? 'Advertencia' : 'No Cumple';
            d.innerHTML = [...new Set(messages)].map(m => `<li>${m}</li>`).join('');
        }
        
        downloadBtn.addEventListener('click', handleDownload);

        async function handleDownload() {
            if (generatedSchedules.size === 0) return;

            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '⚙️ Preparando...';

            try {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Carga de Turnos');

                const headerStyle = {
                    fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0B3041' } },
                    font: { bold: true, color: { argb: 'FFFFFFFF' }, name: 'Calibri', size: 11 },
                    border: { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } },
                    alignment: { horizontal: 'center' }
                };
                
                const dataBorder = {
                    top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' }
                };
                
                const columns = [
                    { header: 'Rut', key: 'Rut', width: 15 },
                    { header: 'Lugar', key: 'Lugar', width: 10 },
                    { header: 'Nombre', key: 'Nombre', width: 30 },
                    { header: 'Estado', key: 'Estado', width: 15 },
                    { header: 'Fecha', key: 'Fecha', width: 15, style: { numFmt: 'dd-mm-yyyy' } },
                    { header: 'Día', key: 'Dia', width: 15 },
                    { header: 'Ini', key: 'Ini', width: 10 },
                    { header: 'FIN', key: 'FIN', width: 10 },
                    { header: 'Dur_Tur', key: 'Dur_Tur', width: 12 },
                    { header: 'Desc_1', key: 'Desc_1', width: 12 },
                    { header: 'Ini_Colac', key: 'Ini_Colac', width: 12 },
                    { header: 'Fin_Colac', key: 'Fin_Colac', width: 12 },
                    { header: 'Dur_Colac', key: 'Dur_Colac', width: 10 },
                    { header: 'HC', key: 'HC', width: 10 },
                    { header: 'Encargado', key: 'Encargado', width: 15 },
                    { header: 'Servicio', key: 'Servicio', width: 15 },
                ];
                
                worksheet.columns = columns;
                worksheet.getRow(1).eachCell(cell => {
                    Object.assign(cell, headerStyle);
                });
                
                generatedSchedules.forEach((data, rut) => {
                    data.schedule.forEach(day => {
                        const shiftData = {
                            Rut: rut,
                            Lugar: 'Site',
                            Nombre: data.nombre,
                            Estado: 'Activo',
                            Fecha: day.date,
                            Dia: day.dayName.charAt(0).toUpperCase() + day.dayName.slice(1),
                            Ini: day.isWorkDay ? formatTime(day.start) : 'LIBRE',
                            FIN: day.isWorkDay ? formatTime(day.end) : 'LIBRE',
                            Dur_Tur: day.isWorkDay ? day.workedHours : '',
                            Desc_1: '', 
                            Ini_Colac: day.isWorkDay && day.colacion > 0 ? formatTime(new Date(day.start.getTime() + day.workedHours * 60 * 60000)) : '',
                            Fin_Colac: day.isWorkDay && day.colacion > 0 ? formatTime(new Date(day.start.getTime() + day.workedHours * 60 * 60000 + day.colacion * 60000)) : '',
                            Dur_Colac: day.isWorkDay ? day.colacion : '',
                            HC: data.contractHours,
                            Encargado: '',
                            Servicio: '01_Masivo'
                        };
                        
                        const newRow = worksheet.addRow(shiftData);
                        newRow.eachCell({ includeEmpty: true }, (cell, colNumber) => {
                            cell.border = dataBorder;
                            cell.font = { name: 'Calibri', size: 11 };
                            cell.alignment = { vertical: 'middle', horizontal: colNumber === 3 ? 'left' : 'center' };
                        });
                    });
                });

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const formattedStartDate = document.getElementById('startDate').value;
                const formattedEndDate = document.getElementById('endDate').value;
                link.download = `Carga de turnos agente nuevos ${formattedStartDate} al ${formattedEndDate}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

            } catch (err) {
                console.error(err);
                alert('Ocurrió un error al generar el archivo Excel.');
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = 'Descargar Horario';
            }
        }
        
        function timeToMinutes(time) { const [h, m] = time.split(':'); return parseInt(h) * 60 + parseInt(m); }
        function showStatus(message, type) { statusMessageContainer.innerHTML = `<div class="status-message ${type}">${message}</div>`; }
        function formatTime(date) { return date ? `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}` : ''; }
        function getMonday(d) { d = new Date(d); d.setHours(0,0,0,0); const day = d.getDay(), diff = d.getDate()-day+(day===0?-6:1); return new Date(d.setDate(diff)); }
        function getSundaysInMonth(year, month) { const d = new Date(year, month, 1), sundays = []; while(d.getMonth()===month){if(d.getDay()===0)sundays.push(new Date(d)); d.setDate(d.getDate()+1);} return sundays; }
    });
    </script>
</body>
</html>
