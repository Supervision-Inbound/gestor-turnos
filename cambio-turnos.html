<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor y Simulador de Turnos</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23007bff' d='M50 0 L100 25 L100 75 L50 100 L0 75 L0 25 Z'%3E%3C/path%3E%3Cpath fill='%23ffffff' d='M50 20 L75 35 L75 65 L50 80 L25 65 L25 35 Z'%3E%3C/path%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-grad: radial-gradient(circle at 40% 30%, #0d1b2a 0%, #0a1a2a 30%, #11263d 70%, #081420 100%);
            --panel-bg: rgba(8, 20, 32, 0.75);
            --panel-bg-subtle: rgba(8, 20, 32, 0.5);
            --panel-border: rgba(0, 122, 255, 0.5);
            --text: #ffffff;
            --text-medium: #9ec1d9;
            --font: 'Inter', sans-serif;
            --success: #16a34a;
            --success-dark: #15803d;
            --accent: #00e5ff;
            --color-error: #dc3545;
            --color-warning: #f59e0b;
            --transition-speed: 0.6s;
            --transition-timing: cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font); 
            background: var(--bg-grad);
            color: var(--text);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        #neuronCanvas {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0; opacity: 0.85;
            pointer-events: none;
        }
        
        .app-wrapper { min-height: 100vh; position: relative; z-index: 10; }
        .app-header { width: 100%; z-index: 100; }
        .app-header-content { padding: 12px 20px; max-width: 1200px; margin: 0 auto; text-align: left; }
        #appTitle { margin: 0; color: var(--text); font-weight: 700; transition: font-size var(--transition-speed) var(--transition-timing), transform var(--transition-speed) var(--transition-timing), margin-bottom var(--transition-speed) var(--transition-timing); }
        .file-info-header { display: inline-block; padding: 6px 12px; background: rgba(0, 122, 255, 0.2); border: 1px solid var(--panel-border); border-radius: 6px; font-size: 12px; font-weight: 600; color: var(--text); opacity: 0; transition: opacity var(--transition-speed) ease; }
        
        .initial-view-wrapper { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; transition: opacity 0.4s ease, visibility 0.4s; }
        .initial-view-content { display: flex; flex-direction: column; align-items: center; width: 100%; }
        body.state-simulator .initial-view-wrapper { opacity: 0; visibility: hidden; pointer-events: none; display: none; }
        .app-header-initial #appTitle { font-size: 28px; margin-bottom: 25px; }
        .upload-view { max-width: 900px; width: 100%; }
        
        .app-header-simulator { 
            position: sticky; top: 0; 
            background: var(--panel-bg); 
            backdrop-filter: blur(15px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.4); 
            border-bottom: 1px solid var(--panel-border); 
            opacity: 0; 
            transition: opacity var(--transition-speed) ease; 
        }
        body.state-simulator .app-header-simulator { opacity: 1; }
        .app-header-simulator #appTitle { font-size: 18px; margin-bottom: 8px; }
        body.state-simulator .file-info-header { opacity: 1; }
        .simulator-view { display: none; width: 100%; max-width: 1200px; margin: 0 auto; padding: 30px 20px; opacity: 0; transform: translateY(20px); transition: opacity 0.6s ease 0.3s, transform 0.6s ease 0.3s; }
        body.state-simulator .simulator-view { display: block; opacity: 1; transform: translateY(0); }
        
        .upload-card-wrapper { 
            display: grid; 
            grid-template-columns: 35% 65%; 
            background: var(--panel-bg); 
            border: 1px solid var(--panel-border);
            backdrop-filter: blur(15px);
            border-radius: 22px; 
            box-shadow: 0 0 40px rgba(66, 133, 244, 0.35), inset 0 0 0 1px rgba(255,255,255,0.04);
            animation: shadowPulse 8s ease-in-out infinite;
            overflow: hidden; 
        }
        @keyframes shadowPulse {
            0%, 100% { box-shadow: 0 0 35px rgba(66, 133, 244, 0.3), inset 0 0 0 1px rgba(255,255,255,0.04); } /* Azul */
            25% { box-shadow: 0 0 50px rgba(219, 68, 55, 0.4), inset 0 0 0 1px rgba(255,255,255,0.04); } /* Rojo */
            50% { box-shadow: 0 0 35px rgba(244, 180, 0, 0.3), inset 0 0 0 1px rgba(255,255,255,0.04); } /* Amarillo */
            75% { box-shadow: 0 0 50px rgba(15, 157, 88, 0.4), inset 0 0 0 1px rgba(255,255,255,0.04); } /* Verde */
        }
        @media (max-width: 900px) { .upload-card-wrapper { grid-template-columns: 1fr; } }
        
        .illustration-panel { 
            background: rgba(0, 0, 0, 0.2); 
            border-right: 1px solid var(--panel-border);
            padding: 40px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            text-align: center; 
        }
        .illustration-panel h2 {
            color: var(--text);
            font-size: 24px;
            font-weight: 700;
        }
        .illustration-panel p {
            font-size: 15px;
            color: var(--text-medium);
            line-height: 1.6;
            max-width: 300px;
        }
        .illustration-icon { 
            width: 120px; 
            height: 120px; 
            background-image: linear-gradient(45deg, #00aaff 0%, #007bff 100%);
            color: white; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 25px; 
            box-shadow: 0 10px 30px -10px rgba(0, 122, 255, 0.4); 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .upload-content-panel { padding: 40px; }
        
        #fileNameDisplay { font-size: 18px; font-weight: 600; color: var(--text); word-break: break-all; padding: 0 15px; }
        input[type="file"] { display: none; }
        .status-message { text-align: center; margin-top: 20px; padding: 15px; border-radius: 10px; display: none; }
        .status-message.success { background: rgba(22, 163, 74, 0.2); border: 1px solid rgba(22, 163, 74, 0.5); color: var(--success); display: block; }
        .status-message.error { background: rgba(220, 53, 69, 0.2); border: 1px solid rgba(220, 53, 69, 0.5); color: var(--color-error); display: block; }
        
        .config-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-medium); }
        .custom-select-wrapper { position: relative; }
        .custom-select-trigger { 
            width: 100%; padding: 12px 15px; border-radius: 8px; 
            border: 1px solid var(--panel-border); 
            background-color: var(--panel-bg-subtle); 
            font-size: 16px; cursor: pointer; 
            display: flex; justify-content: space-between; 
            align-items: center; 
            transition: all 0.2s ease; 
            height: 44px;
            color: var(--text);
        }
        .custom-select-trigger:hover {
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.3);
        }
        .custom-select-trigger::after { content: '▼'; font-size: 12px; color: var(--text-medium); transition: transform 0.3s ease; }
        .custom-select-wrapper.open .custom-select-trigger::after { transform: rotate(180deg); }
        .custom-options { 
            position: absolute; top: 105%; left: 0; right: 0; 
            background: var(--panel-bg); backdrop-filter: blur(10px); 
            border-radius: 8px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); 
            z-index: 100; max-height: 300px; 
            overflow-y: auto; 
            opacity: 0; visibility: hidden; 
            transform: translateY(-10px); 
            transition: all 0.3s ease;
            border: 1px solid var(--panel-border);
        }
        .custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; transform: translateY(0); }
        .search-input { 
            width: 100%; padding: 10px 15px; border: none; 
            border-bottom: 2px solid var(--panel-border); 
            background: var(--panel-bg); 
            font-size: 14px; 
            outline: none; position: sticky; top: 0; z-index: 1;
            color: var(--text);
        }
        .search-input:focus { border-bottom-color: var(--accent); background: var(--panel-bg-subtle); }
        .custom-option { padding: 12px 15px; cursor: pointer; transition: background-color 0.2s ease; border-bottom: 1px solid rgba(0, 122, 255, 0.1); color: var(--text); }
        .custom-option:last-child { border-bottom: none; }
        .custom-option:hover { background-color: rgba(0, 122, 255, 0.2); }
        .custom-option.selected { background-color: rgba(0, 122, 255, 0.3); font-weight: 600; color: #fff; }
        .custom-option.hidden { display: none; }
        
        .week-selector-group { display: flex; align-items: flex-start; gap: 10px; }
        
        .actions-menu-wrapper { position: relative; }
        .actions-menu-btn {
            background-image: linear-gradient(45deg, #00aaff 0%, #007bff 100%);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .actions-menu-btn svg { width: 22px; height: 22px; }
        .actions-menu-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 122, 255, 0.4); }
        .actions-menu-dropdown {
            position: absolute;
            top: 110%;
            right: 0;
            background: var(--panel-bg); backdrop-filter: blur(10px);
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border: 1px solid var(--panel-border);
            z-index: 200;
            width: 220px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s var(--transition-timing);
            color: var(--text);
        }
        .actions-menu-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .actions-menu-item {
            padding: 12px 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid rgba(0, 122, 255, 0.1);
        }
        .actions-menu-item:last-child { border-bottom: none; }
        .actions-menu-item:hover { background-color: rgba(0, 122, 255, 0.2); color: var(--text); }
        .actions-menu-header {
            padding: 10px 15px;
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            background-color: rgba(8, 20, 32, 0.4);
            border-bottom: 1px solid var(--panel-border);
            cursor: pointer;
        }
        .service-list {
            max-height: 250px;
            overflow-y: auto;
        }
        .service-item label {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background-color 0.2s ease;
            color: var(--text-medium);
        }
         .service-item:hover { background-color: rgba(0, 122, 255, 0.2); color: var(--text); }
         .service-item input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .custom-select-wrapper > select { display: none; }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            position: relative;
        }
        .agent-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }
        .agent-header-buttons { display: flex; gap: 8px; }
        .swap-agent-btn, .smart-swap-agent-btn {
            width: 32px;
            height: 32px;
            background: rgba(0, 122, 255, 0.2);
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-medium);
            transition: all 0.3s ease;
        }
        .swap-agent-btn:hover, .smart-swap-agent-btn:hover {
            background: #007bff;
            color: white;
            transform: translateY(-1px);
        }
        .swap-agent-btn svg, .smart-swap-agent-btn svg {
            width: 18px;
            height: 18px;
        }
        .smart-swap-agent-btn { background: rgba(22, 163, 74, 0.2); }
        .smart-swap-agent-btn:hover { background: var(--success); }

        .swap-agent-popup {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--panel-bg); backdrop-filter: blur(10px);
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border: 1px solid var(--panel-border);
            z-index: 300;
            width: 250px;
            margin-top: 5px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .swap-agent-popup-header {
            padding: 8px;
            border-bottom: 1px solid var(--panel-border);
        }
        .swap-search-input {
            width: 100%;
            padding: 6px 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--panel-border);
            border-radius: 4px;
            color: var(--text);
            font-family: var(--font);
        }
        .swap-agent-popup-header-title {
            padding: 10px 15px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-medium);
            border-bottom: 1px solid var(--panel-border);
        }
        .swap-agent-list {
            max-height: 250px;
            overflow-y: auto;
        }
        .swap-agent-item {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
        .swap-agent-item.hidden { display: none; }
        .swap-agent-item:hover {
            background-color: rgba(0, 122, 255, 0.2);
        }
        .no-compatible-agents {
             padding: 15px;
             text-align: center;
             color: var(--text-medium);
             font-style: italic;
        }
        
        .simulation-container { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
        
        .agent-section { 
            display: grid; 
            grid-template-columns: 3fr 1fr; 
            gap: 20px; 
            padding: 15px; 
            background: var(--panel-bg); 
            border: 1px solid var(--panel-border);
            backdrop-filter: blur(15px);
            border-radius: 12px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.3); 
            position: relative; 
        }

        .remove-agent-btn { 
            position: absolute; top: 8px; right: 8px; 
            width: 28px; height: 28px; 
            background: rgba(220, 53, 69, 0.2); 
            border: 1px solid rgba(220, 53, 69, 0.5); 
            border-radius: 50%; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: var(--color-error); 
            transition: all 0.3s ease; 
            z-index: 5; 
        }
        .remove-agent-btn:hover { 
            background: var(--color-error); 
            color: white; 
            border-color: var(--color-error); 
            transform: scale(1.1); 
        }
        @media (max-width: 1100px) { .agent-section { grid-template-columns: 1fr; } }
        .shifts-section { min-width: 0; }
        .validation-sidebar { 
            background: rgba(8, 20, 32, 0.4); 
            border: 1px solid var(--panel-border);
            border-radius: 8px; 
            padding: 15px; 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); 
            height: fit-content; 
        }
        
        .tables-wrapper { display: flex; gap: 15px; align-items: flex-start; }
        .table-container { flex: 1; min-width: 0; display: flex; flex-direction: column; }
        .table-container:first-child { padding-right: 15px; border-right: 1px solid var(--panel-border); }
        .table-title { font-size: 13px; font-weight: 600; color: var(--text-medium); margin-bottom: 8px; }
        .schedule-table { width: 100%; border-collapse: collapse; }
        .schedule-table th, .schedule-table td { padding: 8px 6px; border-bottom: 1px solid var(--panel-border); vertical-align: middle; text-align: center; }
        .schedule-table th { font-size: 10px; text-transform: uppercase; color: var(--text-medium); text-align: center; }
        .schedule-table tbody tr:nth-child(even) { background-color: rgba(8, 20, 32, 0.1); }
        .schedule-table tbody tr.error-row { background-color: rgba(220, 53, 69, 0.2); }
        .schedule-table tbody tr.error-row td { color: var(--color-error); font-weight: 600; }
        .schedule-table td { font-size: 12px; font-weight: 500; height: 44px; color: var(--text); }
        .schedule-table .day-name { font-weight: 600; text-align: left; }
        .schedule-table .libre-day td { color: var(--text-medium); }
        .schedule-table .libre-day .time-input { color: var(--text-medium); background-color: rgba(8, 20, 32, 0.2); }
        .schedule-table .worked-hours { font-weight: 600; color: var(--text); text-align: center; }
        
        .custom-time-input {
            position: relative;
            width: 100%;
        }
        .time-input { 
            font-family: var(--font); font-size: 12px; 
            padding: 4px 24px 4px 8px; border: 1px solid var(--panel-border); 
            border-radius: 4px; background-color: rgba(8, 20, 32, 0.4); 
            width: 100%; transition: all 0.2s ease; box-sizing: border-box;
            color: var(--text);
            text-align: center;
        }
        .time-input:hover { background-color: rgba(8, 20, 32, 0.6); }
        .time-input:focus { 
            background-color: var(--panel-bg); 
            border-color: var(--accent); 
            outline: none; 
            box-shadow: 0 0 5px rgba(0, 229, 255, 0.3);
        }
        .time-input-trigger {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            fill: var(--text-medium);
            cursor: pointer;
        }
        .time-popup {
            display: none;
            position: absolute;
            top: 105%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 500;
            background: rgba(13, 27, 42, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--panel-border);
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform: translate(-50%, -10px);
        }
        .custom-time-input.open .time-popup {
            display: flex;
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, 0);
        }
        .time-column {
            display: flex;
            flex-direction: column;
            max-height: 200px;
            overflow-y: auto;
            border-right: 1px solid var(--panel-border);
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .time-column::-webkit-scrollbar { display: none; }
        .time-column:last-child { border-right: none; }
        .time-option {
            padding: 8px 12px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            transition: background-color 0.2s ease;
        }
        .time-option:hover { background-color: rgba(0, 122, 255, 0.2); }
        .time-option.selected { background-color: rgba(0, 122, 255, 0.4); font-weight: bold; }

        .schedule-table select { 
            font-family: var(--font); font-size: 12px; 
            padding: 4px; border: 1px solid var(--panel-border); 
            border-radius: 4px; background-color: rgba(8, 20, 32, 0.4); 
            width: 100%; transition: all 0.2s ease; box-sizing: border-box; cursor: pointer;
            color: var(--text);
        }
        .schedule-table select:hover { background-color: rgba(8, 20, 32, 0.6); }
        .schedule-table select:focus { 
            background-color: var(--panel-bg); 
            border-color: var(--accent); 
            outline: none; 
            box-shadow: 0 0 5px rgba(0, 229, 255, 0.3);
        }

        .add-agent-section { 
            margin-top: 20px; 
            padding: 20px; 
            background: var(--panel-bg-subtle); 
            border: 1px solid var(--panel-border); 
            border-radius: 12px; 
            text-align: left; 
        }
        .add-agent-btn { 
            background-image: linear-gradient(45deg, #00aaff 0%, #007bff 100%);
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }
        .add-agent-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 122, 255, 0.4);
        }
        
        .global-actions { 
            margin-top: 30px; 
            padding: 20px; 
            background: var(--panel-bg); 
            border: 1px solid var(--panel-border);
            border-radius: 12px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .validation-status { 
            font-size: 14px; 
            font-weight: 600; 
            margin-bottom: 15px; 
            padding: 10px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .validation-status.original { background: rgba(0, 122, 255, 0.2); color: var(--text); border: 1px solid var(--panel-border); }
        .validation-status.valid { background: rgba(22, 163, 74, 0.2); color: var(--success); border: 1px solid rgba(22, 163, 74, 0.5); }
        .validation-status.warning { background: rgba(245, 158, 11, 0.2); color: var(--color-warning); border: 1px solid rgba(245, 158, 11, 0.5); }
        .validation-status.error { background: rgba(220, 53, 69, 0.2); color: var(--color-error); border: 1px solid rgba(220, 53, 69, 0.5); }
        .validation-details { display: none; }
        .validation-details.show { display: block; }
        .validation-details ul { list-style-type: none; padding-left: 0; }
        .validation-details li { margin-bottom: 6px; display: flex; align-items: flex-start; gap: 8px; font-weight: 500; font-size: 12px; line-height: 1.4; color: var(--text); }
        .validation-details li.precaution {
            background-color: rgba(0, 122, 255, 0.2);
            color: var(--text);
            padding: 6px 10px;
            border-radius: 6px;
            border-left: 4px solid var(--accent);
        }

        .download-btn {
            background: var(--success);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .download-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(22, 163, 74, 0.6);
        }
        .download-btn:disabled {
             opacity: 0.6;
             cursor: not-allowed;
             transform: none;
             box-shadow: none;
        }
        
        .download-btn.apply {
             background-image: linear-gradient(45deg, #00aaff 0%, #007bff 100%);
        }
        .download-btn.apply:hover:not(:disabled) {
             box-shadow: 0 5px 15px rgba(0, 122, 255, 0.4);
        }

        .schedule-table { table-layout: fixed; }
        .schedule-table th:nth-child(1), .schedule-table td:nth-child(1) { width: 22%; }
        .schedule-table th:nth-child(2), .schedule-table td:nth-child(2) { width: 26%; }
        .schedule-table th:nth-child(3), .schedule-table td:nth-child(3) { width: 26%; }
        .schedule-table th:nth-child(4), .schedule-table td:nth-child(4) { width: 14%; }
        .schedule-table th:nth-child(5), .schedule-table td:nth-child(5) { width: 12%; }

        .status-area {
            border-radius: 12px; background: rgba(0, 0, 0, 0.2);
            display: flex; align-items: center; justify-content: center;
            min-height: 160px; margin-bottom: 25px;
            position: relative; overflow: hidden; border: 1px solid var(--panel-border); transition: all 0.3s ease;
        }
        .status-content { display: none; }
        .status-area.is-loading .loading-content, .status-area.is-success .success-content, .status-area.is-error .error-content {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 15px; z-index: 10; width: 100%;
        }
        .techno-loader { position: relative; width: 80px; height: 80px; }
        .core-pulse {
            width: 20%; height: 20%; background: #fff; border-radius: 50%;
            box-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px var(--accent);
            position: absolute; top: 40%; left: 40%; animation: corePulse 1.5s ease-in-out infinite;
        }
        @keyframes corePulse { 0%, 100% { transform: scale(0.8); opacity: 0.7; } 50% { transform: scale(1.2); opacity: 1; } }
        
        .circuit-flow { 
            fill: none; stroke-width: 1.5; 
            stroke-dasharray: 100; stroke-dashoffset: 100; 
            animation: flow 3s linear infinite, colorCycle 6s linear infinite;
        }
        @keyframes flow { to { stroke-dashoffset: -100; } }
        @keyframes colorCycle {
            0%, 100% { stroke: #00e5ff; } /* Cian */
            33%      { stroke: #ff00e5; } /* Magenta */
            66%      { stroke: #a8ff00; } /* Verde Lima */
        }

        .status-text-dynamic { font-size: 16px; font-weight: 600; color: var(--text-medium); text-align: center; transition: opacity 0.3s ease; margin-top: 10px; }
        .success-icon svg path { stroke: var(--success); stroke-dasharray: 29; stroke-dashoffset: 29; animation: drawCheck 0.4s 0.2s cubic-bezier(0.76, 0, 0.24, 1) forwards; }
        @keyframes drawCheck { to { stroke-dashoffset: 0; } }
        .status-area.is-success { border-color: rgba(22, 163, 74, 0.5); box-shadow: 0 0 20px rgba(22, 163, 74, 0.4); }
        .success-text { color: var(--success); font-size: 16px; font-weight: 600; }
        .error-icon { height: 40px; width: 40px; color: var(--color-error); }
        .status-area.is-error { border-color: rgba(220, 53, 69, 0.5); box-shadow: 0 0 20px rgba(220, 53, 69, 0.4); }
        .error-text { color: var(--color-error); font-size: 16px; font-weight: 600; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="state-upload">
    <canvas id="neuronCanvas"></canvas>
    <div class="app-wrapper">
        <div class="initial-view-wrapper">
            <div class="initial-view-content">
                <header class="app-header app-header-initial"><h1 id="appTitle">Gestor de Cambios de Turnos</h1></header>
                <main class="upload-view"><div class="upload-card-wrapper">
                    <div class="illustration-panel">
                        <div class="illustration-icon"><svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg></div>
                        <h2>Gestión Inteligente</h2>
                        <p>Modifica, simula y valida los cambios de turno de tu equipo con una interfaz ágil y potente.</p>
                    </div>
                    <div class="upload-content-panel">
                        <div class="status-area is-loading" id="statusContainer">
                            <div class="status-content loading-content">
                                <div class="techno-loader">
                                    <svg viewBox="0 0 100 100">
                                        <path class="circuit-flow" id="flow-1" d="M 50,50 m -25,0 a 25,25 0 1,1 50,0 a 25,25 0 1,1 -50,0"></path>
                                        <path class="circuit-flow" id="flow-2" d="M 50,50 m -35,0 a 35,35 0 1,0 70,0 a 35,35 0 1,0 -70,0" style="animation-delay:.5s"></path>
                                        <path class="circuit-flow" id="flow-3" d="M 50,10 V 90 M 10,50 H 90" style="animation-delay:1s"></path>
                                    </svg>
                                    <div class="core-pulse"></div>
                                </div>
                                <div class="status-text-dynamic" id="dynamicStatusText"></div>
                            </div>
                            <div class="status-content success-content">
                                <div class="success-icon"><svg viewBox="0 0 24 24"><path fill="none" stroke-width="2.5" stroke="currentColor" d="M5,13 l4,4 l10,-10" /></svg></div>
                                <div class="success-text">Sincronización completa</div>
                             </div>
                             <div class="status-content error-content">
                                <div class="status-icon error-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg></div>
                                <div class="error-text" id="errorText"></div>
                            </div>
                        </div>
                    </div>
                </div></main>
            </div>
        </div>
        <header class="app-header app-header-simulator"><div class="app-header-content"><h1 id="appTitleSimulator">Gestor de Cambios de Turnos</h1><div class="file-info-header" id="fileInfoHeader"></div></div></header>
        <main class="simulator-view">
            <div class="config-group">
                <label>Selecciona la semana a simular</label>
                <div class="week-selector-group">
                    <div class="custom-select-wrapper" id="simCustomSelectWeek" style="flex: 1;">
                        <select id="simWeekSelector"></select>
                        <div class="custom-select-trigger" id="simWeekTrigger">-- Selecciona una semana --</div>
                        <div class="custom-options" id="simWeekOptions"></div>
                    </div>
                    <div class="actions-menu-wrapper">
                        <button class="actions-menu-btn" id="actionsMenuBtn" title="Opciones">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c-1.4-.413-1.4-2.397 0-2.81l.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/></svg>
                        </button>
                        <div class="actions-menu-dropdown" id="actionsMenuDropdown">
                            <div id="mainMenuView">
                                <div class="actions-menu-item" id="simulateAllBtnMenu">Simular Todo</div>
                                <div class="actions-menu-item" id="serviceFilterBtn">Servicio ▸</div>
                            </div>
                            <div id="serviceMenuView" style="display: none;">
                                <div class="actions-menu-header" id="backToMainMenuBtn">◂ Volver</div>
                                <div class="service-list" id="serviceList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="simulationArea" style="display: none;">
                <div class="simulation-container" id="simulationContainer"></div>
                <div class="add-agent-section">
                    <p style="margin-bottom: 10px; color: var(--text-medium);">Agregar ejecutivo a la simulación</p>
                    <div class="custom-select-wrapper" id="addAgentCustomSelect" style="max-width: 500px; margin-bottom: 15px;">
                        <select id="addAgentSelector"></select>
                        <div class="custom-select-trigger" id="addAgentTrigger">-- Selecciona un ejecutivo --</div>
                        <div class="custom-options" id="addAgentOptions">
                            <input type="text" class="search-input" id="agentSearchInput" placeholder="Buscar ejecutivo..."/>
                            <div id="agentOptionsList"></div>
                        </div>
                    </div>
                    <button class="add-agent-btn" id="addAgentBtn">Agregar Ejecutivo</button>
                </div>
                <div class="global-actions">
                    <button id="downloadBtn" class="download-btn" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>
                        Descargar Simulación
                    </button>
                    <button id="applyDownloadBtn" class="download-btn apply" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2-square" viewBox="0 0 16 16"><path d="M3 14.5A1.5 1.5 0 0 1 1.5 13V3A1.5 1.5 0 0 1 3 1.5h8a.5.5 0 0 1 0 1H3a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h10a.5.5 0 0 0 .5-.5V8a.5.5 0 0 1 1 0v5a1.5 1.5 0 0 1-1.5 1.5z"/><path d="m8.354 10.354 7-7a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0"/></svg>
                        Aplicar y Descargar
                    </button>
                </div>
            </div>
            <div id="invalidAgentsSection" style="display: none; margin-top: 30px; padding: 20px; background: var(--panel-bg-subtle); border: 1px solid var(--panel-border); border-radius: 12px;">
                <h3 style="color: var(--text); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--panel-border);">Análisis de Turnos Originales</h3>
                <div id="invalidAgentsList"></div>
            </div>
        </main>
    </div>
    
    <script>
    // === Fecha helpers (local, sin desfase) ===
    function normalizeDate(d) {
        if (!d) return null;
        const x = new Date(d);
        return new Date(x.getFullYear(), x.getMonth(), x.getDate());
    }
    function isoDateLocal(d) {
        d = normalizeDate(d);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    
    // --- ANIMACIÓN DE FONDO ---
    const canvas = document.getElementById('neuronCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    let particlesArray;
    class Particle {
        constructor(x, y, size, speedX, speedY) {
            this.x = x; this.y = y; this.size = size;
            this.speedX = speedX; this.speedY = speedY;
            this.pulseSpeed = Math.random() * 0.02 + 0.005;
            this.pulseOffset = Math.random() * Math.PI * 2;
        }
        draw() {
            const pulse = Math.abs(Math.sin(this.pulseOffset + Date.now() * this.pulseSpeed));
            const alpha = 0.5 + pulse * 0.5;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
            ctx.shadowBlur = 10;
            ctx.shadowColor = `rgba(0, 122, 255, ${alpha})`;
            ctx.fillStyle = `rgba(200, 225, 255, ${alpha})`;
            ctx.fill();
            ctx.shadowBlur = 0;
        }
        update() {
            if (this.x > canvas.width || this.x < 0) this.speedX = -this.speedX;
            if (this.y > canvas.height || this.y < 0) this.speedY = -this.speedY;
            this.x += this.speedX; this.y += this.speedY;
        }
    }
    function initParticles() {
        particlesArray = [];
        let numberOfParticles = (canvas.height * canvas.width) / 12000;
        for (let i = 0; i < numberOfParticles; i++) {
            let size = (Math.random() * 1.5) + 0.8;
            let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
            let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
            let speedX = (Math.random() * 0.4) - 0.2;
            let speedY = (Math.random() * 0.4) - 0.2;
            particlesArray.push(new Particle(x, y, size, speedX, speedY));
        }
    }
    function connectParticles() {
        let opacityValue = 1;
        for (let a = 0; a < particlesArray.length; a++) {
            for (let b = a; b < particlesArray.length; b++) {
                let distance = ((particlesArray[a].x - particlesArray[b].x) ** 2) + ((particlesArray[a].y - particlesArray[b].y) ** 2);
                if (distance < (canvas.width / 10) * (canvas.height / 10)) {
                    opacityValue = 1 - (distance / 20000);
                    ctx.strokeStyle = `rgba(0, 122, 255, ${opacityValue * 0.25})`;
                    ctx.lineWidth = 0.8;
                    ctx.beginPath();
                    ctx.moveTo(particlesArray[a].x, particlesArray[a].y);
                    ctx.lineTo(particlesArray[b].x, particlesArray[b].y);
                    ctx.stroke();
                }
            }
        }
    }
    function animateParticles() {
        requestAnimationFrame(animateParticles);
        ctx.clearRect(0, 0, innerWidth, innerHeight);
        for (let i = 0; i < particlesArray.length; i++) {
            particlesArray[i].update();
            particlesArray[i].draw();
        }
        connectParticles();
    }
    window.addEventListener('resize', () => {
        canvas.width = innerWidth;
        canvas.height = innerHeight;
        initParticles();
    });
    initParticles();
    animateParticles();

    // Lógica del simulador
    document.addEventListener('DOMContentLoaded', function() {
        let allData = [], availableAgents = [], addedAgents = new Set(), fullAgentList = [];
        let selectedServices = ['01_Masivo', '10_Staff_Inbound'];
        let statusInterval;

        const statusContainer = document.getElementById('statusContainer');
        const dynamicStatusText = document.getElementById('dynamicStatusText');
        const errorText = document.getElementById('errorText');
        const fileInfoHeader = document.getElementById('fileInfoHeader');
        const simulationArea = document.getElementById('simulationArea');
        const simulationContainer = document.getElementById('simulationContainer');
        const simWeekSelector = document.getElementById('simWeekSelector');
        const simCustomSelectWeek = document.getElementById('simCustomSelectWeek');
        const simWeekTrigger = document.getElementById('simWeekTrigger');
        const simWeekOptions = document.getElementById('simWeekOptions');
        const addAgentSelector = document.getElementById('addAgentSelector');
        const addAgentCustomSelect = document.getElementById('addAgentCustomSelect');
        const addAgentTrigger = document.getElementById('addAgentTrigger');
        const addAgentOptions = document.getElementById('addAgentOptions');
        const agentOptionsList = document.getElementById('agentOptionsList');
        const agentSearchInput = document.getElementById('agentSearchInput');
        const addAgentBtn = document.getElementById('addAgentBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const applyDownloadBtn = document.getElementById('applyDownloadBtn');
        const actionsMenuBtn = document.getElementById('actionsMenuBtn');
        const actionsMenuDropdown = document.getElementById('actionsMenuDropdown');
        const mainMenuView = document.getElementById('mainMenuView');
        const serviceMenuView = document.getElementById('serviceMenuView');
        const simulateAllBtnMenu = document.getElementById('simulateAllBtnMenu');
        const serviceFilterBtn = document.getElementById('serviceFilterBtn');
        const backToMainMenuBtn = document.getElementById('backToMainMenuBtn');
        const serviceList = document.getElementById('serviceList');

        simWeekSelector.addEventListener('change', handleWeekSelect);
        addAgentBtn.addEventListener('click', handleAddAgent);
        
        simulationContainer.addEventListener('input', handleTableInput);
        simulationContainer.addEventListener('change', handleTableChange);
        simulationContainer.addEventListener('focusin', handleTableFocusIn);
        simulationContainer.addEventListener('focusout', handleTableFocusOut);
        
        simulationContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-agent-btn')) {
                handleRemoveAgent(e);
            } else if (e.target.closest('.swap-agent-btn')) {
                handleSwapButtonClick(e);
            } else if (e.target.closest('.smart-swap-agent-btn')) {
                handleSmartSwapButtonClick(e);
            } else {
                handleCustomTimePickerClick(e);
            }
        });
        
        agentSearchInput.addEventListener('input', handleAgentSearch);
        setupCustomSelect(simCustomSelectWeek, simWeekTrigger, simWeekOptions, simWeekSelector);
        setupCustomSelectWithSearch(addAgentCustomSelect, addAgentTrigger, addAgentOptions, addAgentSelector);

        downloadBtn.addEventListener('click', handleDownloadWithTemplate);
        applyDownloadBtn.addEventListener('click', handleMasterDownload);

        actionsMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            mainMenuView.style.display = 'block';
            serviceMenuView.style.display = 'none';
            actionsMenuDropdown.classList.toggle('show');
        });
        document.addEventListener('click', (e) => {
            if (!actionsMenuBtn.contains(e.target) && !actionsMenuDropdown.contains(e.target)) {
                actionsMenuDropdown.classList.remove('show');
            }
            if (!e.target.closest('.agent-header') && !e.target.closest('.swap-agent-popup')) {
                closeAllSwapPopups();
            }
            if (!e.target.closest('.custom-time-input')) {
                closeAllTimePopups();
            }
        });

        simulateAllBtnMenu.addEventListener('click', () => {
            handleSimulateAll();
            actionsMenuDropdown.classList.remove('show');
        });

        serviceFilterBtn.addEventListener('click', () => {
            mainMenuView.style.display = 'none';
            serviceMenuView.style.display = 'block';
        });
        
        backToMainMenuBtn.addEventListener('click', () => {
            mainMenuView.style.display = 'block';
            serviceMenuView.style.display = 'none';
        });
        
        serviceList.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                const serviceName = e.target.value;
                if (e.target.checked) {
                    if (!selectedServices.includes(serviceName)) selectedServices.push(serviceName);
                } else {
                    selectedServices = selectedServices.filter(s => s !== serviceName);
                }
                updateAvailableAgentsAndFilters();
            }
        });

        async function loadDataFromURL() {
            statusContainer.className = 'status-area is-loading';
            const statusMessages = ["Iniciando conexión segura...", "Analizando topología...", "Enviando solicitud al núcleo...", "Recibiendo streams de datos...", "Decodificando paquetes...", "Procesando registros...", "Optimizando resultados..."];
            let messageIndex = 0;
            dynamicStatusText.textContent = statusMessages[messageIndex];
            statusInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % statusMessages.length;
                dynamicStatusText.style.opacity = '0';
                setTimeout(() => { dynamicStatusText.textContent = statusMessages[messageIndex]; dynamicStatusText.style.opacity = '1'; }, 300);
            }, 1800);
            
            const flowUrl = "https://default136d6ab55b55496f97cb2424247715.ed.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a6c5e734ae1d4bc8a2da0972cf1ed1e0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=iQVhRZddVOE3RtVzIpkGkzu9MI1bAzp0vmUWiJtcuIw";

            try {
                const response = await fetch(flowUrl, { method: "POST" });
                if (!response.ok) throw new Error("Respuesta de red no fue exitosa: " + response.status);
                const rawData = await response.json();
                if (!Array.isArray(rawData) || rawData.length === 0) throw new Error("No se recibieron datos.");

                allData = rawData.map(row => { 
                    const newRow = { ...row };
                    const fechaKey = findKey(newRow, ['Fecha', 'fecha', 'Date']);
                    const dateComponent = fechaKey ? excelSerialToDate(parseFloat(newRow[fechaKey])) : null;
                    newRow.Fecha = dateComponent;
                    
                    const timeKeys = ['Ini', 'FIN', 'Desc_1', 'Ini_ Colac', 'Fin_ Colac', 'Desc_2', 'INICIO TURNO', 'FIN DEL TURNO'];
                    timeKeys.forEach(key => {
                        const foundKey = findKey(newRow, [key]);
                        if (foundKey) {
                            newRow[foundKey] = parseDateTime(parseFloat(newRow[foundKey]), dateComponent);
                        }
                    });
                    return newRow;
                });

                clearInterval(statusInterval);
                statusContainer.className = 'status-area is-success';
                initializeControls();
                setTimeout(() => transformToSimulatorMode('Datos de la Nube'), 1000);

            } catch (error) {
                console.error("Error al cargar datos:", error);
                clearInterval(statusInterval);
                statusContainer.className = 'status-area is-error';
                errorText.textContent = error.message;
            }
        }
        
        function transformToSimulatorMode(sourceName) {
            document.body.classList.add('state-simulator');
            fileInfoHeader.textContent = sourceName;
        }

        function initializeControls() {
            const agentSet = new Map();
            allData.forEach(row => {
                const rut = findVal(row, ['rut', 'id']);
                const nombre = findVal(row, ['nombre', 'nombre completo']);
                if (nombre && rut && !agentSet.has(rut)) agentSet.set(rut, { nombre: nombre.trim(), rut: rut.toString() });
            });
            fullAgentList = [...agentSet.values()].sort((a, b) => a.nombre.localeCompare(b.nombre));
            
            populateWeekSelector();
            updateAvailableAgentsAndFilters();
        }
        
        function setupCustomSelect(wrapper, trigger, optionsContainer, realSelect) {
            trigger.addEventListener('click', () => wrapper.classList.toggle('open'));
            optionsContainer.addEventListener('click', (e) => {
                if(e.target.classList.contains('custom-option')) {
                    trigger.textContent = e.target.textContent;
                    realSelect.value = e.target.dataset.value;
                    realSelect.dispatchEvent(new Event('change'));
                    optionsContainer.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
                    e.target.classList.add('selected');
                    wrapper.classList.remove('open');
                }
            });
            document.addEventListener('click', (e) => { if (!wrapper.contains(e.target)) wrapper.classList.remove('open'); });
        }

        function setupCustomSelectWithSearch(wrapper, trigger, optionsContainer, realSelect) {
            trigger.addEventListener('click', () => wrapper.classList.toggle('open'));
            agentOptionsList.addEventListener('click', (e) => {
                if(e.target.classList.contains('custom-option')) {
                    trigger.textContent = e.target.textContent;
                    realSelect.value = e.target.dataset.value;
                    realSelect.dispatchEvent(new Event('change'));
                    agentOptionsList.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
                    e.target.classList.add('selected');
                    wrapper.classList.remove('open');
                    agentSearchInput.value = '';
                }
            });
            document.addEventListener('click', (e) => { 
                if (!wrapper.contains(e.target)) {
                    wrapper.classList.remove('open');
                    agentSearchInput.value = '';
                    handleAgentSearch();
                }
            });
        }

        function handleAgentSearch() {
            const searchTerm = agentSearchInput.value.toLowerCase();
            const options = agentOptionsList.querySelectorAll('.custom-option');
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    option.classList.remove('hidden');
                } else {
                    option.classList.add('hidden');
                }
            });
        }
        
        function populateWeekSelector() {
            const weekSet = new Set(allData.map(row => {
                const fecha = findVal(row, ['Fecha']);
                return fecha instanceof Date ? getMonday(fecha).toISOString() : null;
            }).filter(Boolean));
            
            const allWeeks = [...weekSet].sort((a, b) => new Date(b) - new Date(a));
            
            simWeekSelector.innerHTML = ''; 
            simWeekOptions.innerHTML = '';
            simWeekTrigger.textContent = '-- Selecciona una semana --';
            
            allWeeks.forEach(iso => {
                const monday = new Date(iso);
                const sunday = new Date(new Date(monday).setDate( monday.getDate() + 6));
                const text = `Semana del ${monday.getDate()} al ${sunday.getDate()} de ${sunday.toLocaleDateString('es-ES',{month:'long', year:'numeric'})}`;
                simWeekSelector.add(new Option(text, iso));
                simWeekOptions.innerHTML += `<div class="custom-option" data-value="${iso}">${text}</div>`;
            });
        }
    
        function populateAgentSelector(selector, optionsContainer, agents) {
            selector.innerHTML = '';
            agentOptionsList.innerHTML = '';
            agents.forEach(a => {
                selector.add(new Option(a.nombre, a.rut));
                agentOptionsList.innerHTML += `<div class="custom-option" data-value="${a.rut}">${a.nombre}</div>`;
            });
        }

        function handleWeekSelect() {
            const weekStartISO = simWeekSelector.value;
            simulationArea.style.display = weekStartISO ? 'block' : 'none';
            document.getElementById('invalidAgentsSection').style.display = 'none';

            if(weekStartISO){
                populateServiceFilter();
                updateAvailableAgentsAndFilters();
            }
        }
        
        function populateServiceFilter() {
            const weekStartISO = simWeekSelector.value;
            if (!weekStartISO) return;

            const weekStart = new Date(weekStartISO);
            const weekEnd = new Date(new Date(weekStart).setDate(weekStart.getDate() + 6));
            
            const weekData = allData.filter(row => {
                const fecha = findVal(row, ['Fecha']);
                return fecha instanceof Date && fecha >= weekStart && fecha <= weekEnd;
            });
            
            const services = [...new Set(weekData.map(row => findVal(row, ['Servicio'])).filter(Boolean))].sort();

            serviceList.innerHTML = '';
            services.forEach(service => {
                const isChecked = selectedServices.includes(service);
                serviceList.innerHTML += `
                    <div class="service-item">
                        <label>
                            <input type="checkbox" value="${service}" ${isChecked ? 'checked' : ''}>
                            ${service}
                        </label>
                    </div>`;
            });
        }

        function updateAvailableAgentsAndFilters() {
            simulationContainer.innerHTML = '';
            addedAgents.clear();
            downloadBtn.disabled = true;
            applyDownloadBtn.disabled = true;

            const weekStartISO = simWeekSelector.value;
            if (weekStartISO) {
                const weekStart = new Date(weekStartISO);
                const weekEnd = new Date(new Date(weekStart).setDate(weekStart.getDate() + 6));
                
                const filteredData = allData.filter(row => {
                    const fecha = findVal(row, ['Fecha']);
                    if (!(fecha instanceof Date && fecha >= weekStart && fecha <= weekEnd)) return false;
                    
                    const service = findVal(row, ['Servicio']);
                    return selectedServices.includes(service);
                });

                const agentSetForWeek = new Map();
                filteredData.forEach(row => {
                    const rut = findVal(row, ['rut', 'id']);
                    const nombre = findVal(row, ['nombre', 'nombre completo']);
                    if (nombre && rut && !agentSetForWeek.has(rut)) {
                        agentSetForWeek.set(rut, { nombre: nombre.trim(), rut: rut.toString() });
                    }
                });
                availableAgents = [...agentSetForWeek.values()].sort((a, b) => a.nombre.localeCompare(b.nombre));
                
                displayInvalidAgents();
            } else {
                availableAgents = [];
            }
            updateAddAgentSelector();
        }


        function handleSimulateAll() {
            if (!simWeekSelector.value || availableAgents.length === 0) return;
            
            simulationContainer.innerHTML = '';
            addedAgents.clear();
            
            availableAgents.forEach(agent => {
                const newSection = createAgentSection(agent.rut, simWeekSelector.value);
                if(newSection) {
                    simulationContainer.appendChild(newSection);
                    addedAgents.add(agent.rut);
                }
            });
            
            updateAddAgentSelector();
            const hasAgents = addedAgents.size > 0;
            downloadBtn.disabled = !hasAgents;
            applyDownloadBtn.disabled = !hasAgents;
        }

        function handleAddAgent() {
            const agentRut = addAgentSelector.value;
            if (!agentRut || !simWeekSelector.value || addedAgents.has(agentRut)) return;
            const newSection = createAgentSection(agentRut, simWeekSelector.value);
            if(newSection) simulationContainer.appendChild(newSection);
            addedAgents.add(agentRut);
            updateAddAgentSelector();
            const hasAgents = addedAgents.size > 0;
            downloadBtn.disabled = !hasAgents;
            applyDownloadBtn.disabled = !hasAgents;
        }

        function createCustomTimeInput(initialValue, inputClass) {
            const hours = Array.from({length: 24}, (_, i) => String(i).padStart(2, '0'));
            const minutes = ['00', '30'];
            
            let hoursHtml = hours.map(h => `<div class="time-option" data-type="hour" data-value="${h}">${h}</div>`).join('');
            let minutesHtml = minutes.map(m => `<div class="time-option" data-type="minute" data-value="${m}">${m}</div>`).join('');

            return `
                <div class="custom-time-input">
                    <input type="text" class="time-input ${inputClass}" value="${initialValue}" maxlength="5" placeholder="--:--" />
                    <svg class="time-input-icon time-input-trigger" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg>
                    <div class="time-popup">
                        <div class="time-column hours-column">${hoursHtml}</div>
                        <div class="time-column minutes-column">${minutesHtml}</div>
                    </div>
                </div>
            `;
        }
        
        function createAgentSection(agentRut, weekStartISO) {
            try {
                const agent = availableAgents.find(a => a.rut === agentRut) || fullAgentList.find(a => a.rut === agentRut);
                if (!agent) return null;
                
                const section = document.createElement('div');
                section.className = 'agent-section';
                section.dataset.agentRut = agentRut;
                let originalTableRowsHTML = '';
                let modifiableTableRowsHTML = '';
                const tableHeaders = `<tr><th>Día</th><th>Inicio</th><th>Término</th><th>Colación</th><th>HH. Trab.</th></tr>`;

                for (let i = 0; i < 7; i++) {
                    const day = new Date(new Date(weekStartISO).setDate(new Date(weekStartISO).getDate() + i));
                    const dayName = day.toLocaleDateString('es-ES', { weekday: 'long' });
                    const dayData = allData.find(row => {
                        const rowRut = findVal(row, ['rut', 'id'])?.toString();
                        const rowDate = findVal(row, ['Fecha']);
                        return rowRut === agentRut && rowDate instanceof Date && rowDate.toDateString() === day.toDateString();
                    });
                    
                    const iniVal = findVal(dayData, ['Ini', 'inicio', 'inicio turno']);
                    const finVal = findVal(dayData, ['FIN', 'termino', 'fin del turno']);
                    const colacionVal = parseInt(findVal(dayData, ['Dur_ Colac', 'dur_colac', 'colacion', 'descanso'])) || 0;
                    
                    const isLibre = !dayData || !iniVal || !finVal || (typeof iniVal === 'string' && iniVal.toUpperCase().includes('LIBRE'));
                    let workedHours = NaN;
                    if (!isLibre) {
                        const totalMinutes = calculateMinutes(formatTime(iniVal), formatTime(finVal));
                        if (!isNaN(totalMinutes)) workedHours = (totalMinutes - colacionVal) / 60;
                    }

                    originalTableRowsHTML += `<tr class="${isLibre ? 'libre-day' : ''}">
                        <td class="day-name">${dayName}</td>
                        <td>${isLibre ? '--:--' : formatTime(iniVal)}</td>
                        <td>${isLibre ? '--:--' : formatTime(finVal)}</td>
                        <td>${isLibre ? '--' : colacionVal}</td>
                        <td class="worked-hours">${isLibre || isNaN(workedHours) ? '--' : workedHours.toFixed(1)}</td>
                    </tr>`;

                    modifiableTableRowsHTML += `<tr class="${isLibre ? 'libre-day' : ''}" data-day="${i}">
                        <td class="day-name">${dayName}</td>
                        <td>${createCustomTimeInput(isLibre ? '' : formatTime(iniVal), 'start-time')}</td>
                        <td>${createCustomTimeInput(isLibre ? '' : formatTime(finVal), 'end-time')}</td>
                        <td><select class="colacion-select"><option value="0" ${colacionVal === 0 ? 'selected' : ''}>0</option><option value="30" ${colacionVal === 30 ? 'selected' : ''}>30</option><option value="60" ${colacionVal === 60 ? 'selected' : ''}>60</option></select></td>
                        <td class="worked-hours">${isLibre || isNaN(workedHours) ? '--' : workedHours.toFixed(1)}</td>
                    </tr>`;
                }

                section.innerHTML = `
                    <button class="remove-agent-btn" title="Quitar Ejecutivo"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>
                    <div class="shifts-section">
                        <div class="agent-header">
                            <div class="agent-name">${agent.nombre}</div>
                            <div class="agent-header-buttons">
                                <button class="swap-agent-btn" title="Intercambiar Turnos">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5m14-7a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5"/>
                                    </svg>
                                </button>
                                <button class="smart-swap-agent-btn" title="Buscar Intercambio Compatible">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/>
                                        <path d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5m14-7a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="tables-wrapper">
                            <div class="table-container"><div class="table-title">Turno Original</div><table class="schedule-table original-schedule"><thead>${tableHeaders}</thead><tbody>${originalTableRowsHTML}</tbody></table></div>
                            <div class="table-container"><div class="table-title">Turno Modificado</div><table class="schedule-table modifiable-schedule"><thead>${tableHeaders}</thead><tbody>${modifiableTableRowsHTML}</tbody></table></div>
                        </div>
                    </div>
                    <div class="validation-sidebar"><div class="validation-status original">Análisis Semanal</div><div class="validation-details"></div></div>`;
                
                setTimeout(() => updateAndValidateAgent(section), 100);
                return section;
            } catch (error) {
                console.error("Error al crear la sección del agente:", error);
                return null;
            }
        }
        
        function handleTableFocusIn(e) {
            if (e.target.classList.contains('time-input')) {
                e.target.select();
            }
        }

        function handleTableFocusOut(e) {
            if (e.target.classList.contains('time-input')) {
                const input = e.target;
                let value = input.value;

                if (value.match(/^\d{1,2}:\d{2}$/)) {
                    let [hours, minutes] = value.split(':');
                    hours = Math.min(parseInt(hours, 10), 23);
                    minutes = (minutes < 15 || minutes > 45) ? 0 : 30;
                    input.value = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                } else if (value.match(/^\d{3,4}$/)) {
                    const hoursStr = value.length === 3 ? `0${value.slice(0, 1)}` : value.slice(0, 2);
                    const minutesStr = value.slice(-2);
                    input.value = `${hoursStr}:${minutesStr}`;
                } else if (value) {
                    input.value = '';
                }
                updateAndValidateAgent(input.closest('.agent-section'));
            }
        }
        
        function handleTableInput(e) {
            if (e.target.classList.contains('time-input')) {
                const input = e.target;
                const value = input.value;
                if (value.length === 2 && !value.includes(':')) {
                    input.value = value + ':';
                }
                if (value.length === 2 && value.includes(':')) {
                    input.value = value.replace(':', '');
                }
            }
        }
        
        function handleTableChange(e) {
            const agentSection = e.target.closest('.agent-section');
            if (agentSection && e.target.classList.contains('colacion-select')) {
                updateAndValidateAgent(agentSection);
            }
        }

        function closeAllTimePopups() {
            document.querySelectorAll('.custom-time-input.open').forEach(picker => {
                picker.classList.remove('open');
            });
        }

        function handleCustomTimePickerClick(e) {
            const timeOption = e.target.closest('.time-option');
            if (timeOption) {
                const timeInputContainer = e.target.closest('.custom-time-input');
                const input = timeInputContainer.querySelector('.time-input');
                const [hour, minute] = input.value.split(':');
                
                if (timeOption.dataset.type === 'hour') {
                    input.value = `${timeOption.dataset.value}:${minute || '00'}`;
                } else {
                    input.value = `${hour || '00'}:${timeOption.dataset.value}`;
                }
                
                timeInputContainer.classList.remove('open');
                updateAndValidateAgent(timeInputContainer.closest('.agent-section'));
                return;
            }

            if (e.target.closest('.time-input-trigger')) {
                const timeInputContainer = e.target.closest('.custom-time-input');
                 if (!timeInputContainer.classList.contains('open')) {
                    closeAllTimePopups();
                }
                timeInputContainer.classList.toggle('open');
            }
        }
        
        function handleRemoveAgent(e) {
            const removeBtn = e.target.closest('.remove-agent-btn');
            if (removeBtn) {
                const agentSection = removeBtn.closest('.agent-section');
                addedAgents.delete(agentSection.dataset.agentRut);
                agentSection.remove();
                updateAddAgentSelector();
                const hasAgents = addedAgents.size > 0;
                downloadBtn.disabled = !hasAgents;
                applyDownloadBtn.disabled = !hasAgents;
            }
        }

        function updateAddAgentSelector() {
            const agentsToShow = availableAgents.filter(a => !addedAgents.has(a.rut));
            populateAgentSelector(addAgentSelector, addAgentOptions, agentsToShow);
            addAgentTrigger.textContent = agentsToShow.length > 0 ? '-- Selecciona un ejecutivo --' : 'No hay más ejecutivos';
            addAgentBtn.disabled = agentsToShow.length === 0;
        }

        function updateAndValidateAgent(agentSection) {
            agentSection.querySelectorAll('.modifiable-schedule tbody tr').forEach(recalculateRowHours);
            const validationResult = getFullValidationResult(agentSection);
            showValidationResult(agentSection, validationResult);
            agentSection.querySelectorAll('.modifiable-schedule tbody tr').forEach(row => row.classList.remove('error-row'));
            validationResult.errorDays.forEach(dayIdx => {
                const row = agentSection.querySelectorAll('.modifiable-schedule tbody tr')[dayIdx];
                if (row) row.classList.add('error-row');
            });
        }

        function recalculateRowHours(row) {
            const workedHoursCell = row.querySelector('.worked-hours');
            const start = row.querySelector('.start-time').value;
            const end = row.querySelector('.end-time').value;
            const breakMinutes = parseInt(row.querySelector('.colacion-select').value) || 0;

            if (!start || !end) {
                workedHoursCell.textContent = '--';
                return;
            }
            const totalMinutes = calculateMinutes(start, end);
            const workedHours = (totalMinutes - breakMinutes) / 60;
            workedHoursCell.textContent = (isNaN(workedHours) || workedHours < 0) ? 'Error' : workedHours.toFixed(1);
        }

        function getFullValidationResult(agentSectionOrRut, scheduleData = null) {
            const isElement = agentSectionOrRut instanceof HTMLElement;
            const agentRut = isElement ? agentSectionOrRut.dataset.agentRut : agentSectionOrRut;
            const weekStartISO = simWeekSelector.value;
            const weekStart = new Date(weekStartISO);
            
            const schedule = scheduleData || getModifiableScheduleData(agentSectionOrRut);

            let messages = [];
            let status = 'valid';
            let errorDays = [];

            // Calculate target hours from the agent's original schedule for this week
            let originalTargetHours = 0;
            const originalSchedule = getScheduleForAgent(agentRut, weekStartISO, true); // Force original
            originalSchedule.forEach(day => {
                if (day.startTime && day.endTime) {
                    const minutes = calculateMinutes(day.startTime, day.endTime);
                    const colacion = parseInt(day.colacion) || 0;
                    const hours = (minutes - colacion) / 60;
                    if (!isNaN(hours) && hours > 0) {
                        originalTargetHours += hours;
                    }
                }
            });
            const targetHours = originalTargetHours > 0 ? originalTargetHours : 44; // Fallback to 44
            
            let weekShifts = [];
            schedule.forEach((day, idx) => {
                if ((day.startTime && !day.endTime) || (!day.startTime && day.endTime)) { status = 'error'; errorDays.push(idx); }
                if (day.startTime && day.endTime) {
                    const workedHours = (calculateMinutes(day.startTime, day.endTime) - parseInt(day.colacion)) / 60;
                    const dayDate = new Date(new Date(weekStart).setDate(weekStart.getDate() + idx));
                    let startDt = new Date(`${isoDateLocal(dayDate)}T${day.startTime}`);
                    let endDt = new Date(`${isoDateLocal(dayDate)}T${day.endTime}`);
                    if (endDt <= startDt) endDt.setDate(endDt.getDate() + 1);
                    weekShifts.push({ start: startDt, end: endDt, dayIndex: idx, dayDate: dayDate, workedHours: workedHours, dayName: dayDate.toLocaleDateString('es-ES', { weekday: 'long' }) });
                }
            });

            if (status === 'error') {
                messages.push('⛔ Hay campos de hora vacíos en turnos activos.');
                return { status: 'error', statusText: 'Campos incompletos', messages, errorDays };
            }

            weekShifts.forEach(shift => {
                if (shift.workedHours > 10) { status = 'error'; messages.push(`⛔ Jornada Excesiva (${shift.dayName}): ${shift.workedHours.toFixed(1)}h (Máx: 10h).`); errorDays.push(shift.dayIndex); }
                else if (shift.workedHours > 0 && shift.workedHours < 4) { status = 'error'; messages.push(`⛔ Jornada Reducida (${shift.dayName}): ${shift.workedHours.toFixed(1)}h (Mín: 4h).`); errorDays.push(shift.dayIndex); }
            });

            const { workedSundays, totalSundaysInMonth } = countWorkedSundaysInMonth(agentRut, weekStart, schedule);
            if (totalSundaysInMonth > 0) {
                const maxWorkedSundays = totalSundaysInMonth === 5 ? 3 : 2;
                if (workedSundays > maxWorkedSundays) { if(status !== 'error') status = 'warning'; messages.push(`⚠️ Domingos trabajados en el mes: ${workedSundays} de ${totalSundaysInMonth} (Máx: ${maxWorkedSundays}).`); }
                else { messages.push(`✅ Domingos trabajados en el mes: ${workedSundays} de ${totalSundaysInMonth}.`); }
            }
            
            let totalHours = weekShifts.reduce((acc, shift) => acc + shift.workedHours, 0);
            const tolerance = 0.5;
            if (totalHours > targetHours + tolerance) { status = 'error'; messages.push(`⛔ Horas Semanales Excedidas: ${totalHours.toFixed(1)}h de ${targetHours.toFixed(1)}h.`); }
            else if (totalHours < targetHours - tolerance) { if (status !== 'error') status = 'warning'; messages.push(`⚠️ Horas Semanales Insuficientes: ${totalHours.toFixed(1)}h de ${targetHours.toFixed(1)}h.`); }
            else { messages.push(`✅ Horas Semanales: ${totalHours.toFixed(1)}h / ${targetHours.toFixed(1)}h.`); }
            
            if (weekShifts.length > 6) { status = 'error'; messages.push(`⛔ Sin Día Libre: Se debe tener al menos 1 día libre.`); }
            else { messages.push(`✅ Días Libres: Se cumple con el mínimo.`); }
            
            let allShiftsToCheck = [...weekShifts];
            const prevSunday = new Date(weekStart.getTime() - (24 * 60 * 60 * 1000));
            const prevSundayShiftData = allData.find(row => findVal(row, ['rut', 'id'])?.toString() === agentRut && findVal(row, ['Fecha']) instanceof Date && findVal(row, ['Fecha']).toDateString() === prevSunday.toDateString());
            if (prevSundayShiftData) { const prevFinVal = findVal(prevSundayShiftData, ['FIN', 'termino']); if (prevFinVal instanceof Date) { allShiftsToCheck.unshift({ start: null, end: prevFinVal, dayIndex: -1 }); } }
            
            allShiftsToCheck.sort((a, b) => (a.start?.getTime() || a.end?.getTime()) - (b.start?.getTime() || b.end?.getTime()));
            let descansoMessageAdded = false;
            for (let i = 1; i < allShiftsToCheck.length; i++) {
                if (allShiftsToCheck[i].start && allShiftsToCheck[i-1].end) {
                    if ((allShiftsToCheck[i].start - allShiftsToCheck[i-1].end) / 36e5 < 12) {
                        status = 'error';
                        messages.push(`⛔ Descanso <12h para el ${allShiftsToCheck[i].dayName || 'lunes'}.`);
                        errorDays.push(allShiftsToCheck[i].dayIndex);
                        descansoMessageAdded = true;
                    }
                }
            }
            if (!descansoMessageAdded) { messages.push(`✅ Descanso entre turnos: Mínimo 12h cumplido.`); }
            
            return {
                status,
                statusText: status === 'valid' ? 'Cumple Normativa' : status === 'warning' ? 'Advertencia' : 'No Cumple Normativa',
                messages,
                errorDays: [...new Set(errorDays)]
            };
        }


        function countWorkedSundaysInMonth(agentRut, weekStartDate, schedule) {
            const year = weekStartDate.getFullYear();
            const month = weekStartDate.getMonth();
            let sundaysInMonth = [];
            let date = new Date(year, month, 1);
            while (date.getMonth() === month) {
                if (date.getDay() === 0) { sundaysInMonth.push(new Date(date)); }
                date.setDate(date.getDate() + 1);
            }

            let workedSundays = 0;
            const currentSundayShift = schedule[6];
            const weekSundayDate = new Date(weekStartDate.getTime() + 6 * 24 * 60 * 60 * 1000);

            for (const sunday of sundaysInMonth) {
                if (sunday.toDateString() === weekSundayDate.toDateString()) {
                    if (currentSundayShift && currentSundayShift.startTime) {
                        workedSundays++;
                    }
                } else {
                    const hasShift = allData.some(row => {
                        const rowRut = findVal(row, ['rut', 'id'])?.toString();
                        const rowDate = findVal(row, ['Fecha']);
                        if (rowRut !== agentRut || !(rowDate instanceof Date) || rowDate.toDateString() !== sunday.toDateString()) return false;
                        const iniVal = findVal(row, ['Ini', 'inicio']);
                        return (iniVal instanceof Date) || (typeof iniVal === 'string' && !String(iniVal).toUpperCase().includes('LIBRE'));
                    });
                    if (hasShift) { workedSundays++; }
                }
            }
            return { workedSundays, totalSundaysInMonth: sundaysInMonth.length };
        }
        
        function showValidationResult(agentSection, validationResult) {
            const statusEl = agentSection.querySelector('.validation-status');
            const detailsEl = agentSection.querySelector('.validation-details');
            statusEl.className = `validation-status ${validationResult.status}`;
            statusEl.textContent = validationResult.statusText;
            detailsEl.className = 'validation-details show';
            const uniqueMessages = [];
            validationResult.messages.forEach(m => {
                const mText = typeof m === 'object' ? m.text : m;
                if (!uniqueMessages.some(u => (typeof u === 'object' ? u.text : u) === mText)) {
                    uniqueMessages.push(m);
                }
            });

            detailsEl.innerHTML = `<ul>${uniqueMessages.map(m => {
                if (typeof m === 'object' && m.type === 'precaution') {
                    return `<li class="precaution">${m.text}</li>`;
                }
                return `<li>${m}</li>`;
            }).join('')}</ul>`;
        }

        function handleSwapButtonClick(e) {
            const swapBtn = e.target.closest('.swap-agent-btn');
            if (!swapBtn) return;
        
            closeAllSwapPopups();
        
            const sourceSection = swapBtn.closest('.agent-section');
            const sourceAgentRut = sourceSection.dataset.agentRut;
        
            const agentsForSwapping = availableAgents.filter(agent => agent.rut !== sourceAgentRut);
        
            const popup = document.createElement('div');
            popup.className = 'swap-agent-popup';
            
            let agentItemsHTML = '';
            agentsForSwapping.forEach(agent => {
                agentItemsHTML += `<div class="swap-agent-item" data-rut="${agent.rut}">${agent.nombre}</div>`;
            });

            popup.innerHTML = `
                <div class="swap-agent-popup-header">
                    <input type="text" class="swap-search-input" placeholder="Buscar ejecutivo...">
                </div>
                <div class="swap-agent-list">
                    ${agentItemsHTML}
                </div>`;
            
            sourceSection.querySelector('.agent-header').appendChild(popup);
            const searchInput = popup.querySelector('.swap-search-input');
            const agentList = popup.querySelector('.swap-agent-list');

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                agentList.querySelectorAll('.swap-agent-item').forEach(item => {
                    const agentName = item.textContent.toLowerCase();
                    item.classList.toggle('hidden', !agentName.includes(searchTerm));
                });
            });
            
            popup.addEventListener('click', (event) => {
                const selectedItem = event.target.closest('.swap-agent-item');
                if (selectedItem) {
                    const destinationRut = selectedItem.dataset.rut;
                    if (!addedAgents.has(destinationRut)) {
                        const newSection = createAgentSection(destinationRut, simWeekSelector.value);
                        if (newSection) {
                            simulationContainer.appendChild(newSection);
                            addedAgents.add(destinationRut);
                            updateAddAgentSelector();
                        }
                    }
                    setTimeout(() => performAgentSwap(sourceSection, destinationRut), 50);
                    closeAllSwapPopups();
                }
            });
        
            e.stopPropagation();
        }

        function getScheduleForAgent(agentRut, weekStartISO, forceOriginal = false) {
            if (!forceOriginal) {
                const agentSection = document.querySelector(`.agent-section[data-agent-rut="${agentRut}"]`);
                if (agentSection) {
                    return getModifiableScheduleData(agentSection);
                }
            }
            // If not in DOM or forced, build from original data
            const schedule = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(new Date(weekStartISO).setDate(new Date(weekStartISO).getDate() + i));
                const dayData = allData.find(row => findVal(row, ['rut', 'id'])?.toString() === agentRut && findVal(row, ['Fecha']) instanceof Date && findVal(row, ['Fecha']).toDateString() === day.toDateString());
                
                const iniVal = findVal(dayData, ['Ini', 'inicio']);
                const finVal = findVal(dayData, ['FIN', 'termino']);
                const colacionVal = findVal(dayData, ['Dur_ Colac', 'colacion']);
                const isLibre = !dayData || !iniVal || !finVal || (typeof iniVal === 'string' && iniVal.toUpperCase().includes('LIBRE'));

                schedule.push({
                    startTime: isLibre ? '' : formatTime(iniVal),
                    endTime: isLibre ? '' : formatTime(finVal),
                    colacion: isLibre ? '0' : (parseInt(colacionVal) || 0).toString()
                });
            }
            return schedule;
        }
        
        async function handleSmartSwapButtonClick(e) {
            const smartSwapBtn = e.target.closest('.smart-swap-agent-btn');
            if (!smartSwapBtn) return;

            closeAllSwapPopups();
            const sourceSection = smartSwapBtn.closest('.agent-section');
            const sourceAgentRut = sourceSection.dataset.agentRut;
            const sourceSchedule = getModifiableScheduleData(sourceSection);

            const otherAgents = availableAgents.filter(agent => agent.rut !== sourceAgentRut);
            const compatibleAgents = [];

            for (const targetAgent of otherAgents) {
                const targetAgentRut = targetAgent.rut;
                const targetSchedule = getScheduleForAgent(targetAgentRut, simWeekSelector.value, true); // Use original schedule for potential targets
                
                const sourceValidation = getFullValidationResult(sourceAgentRut, targetSchedule);
                if (sourceValidation.status === 'error') continue;

                const targetValidation = getFullValidationResult(targetAgentRut, sourceSchedule);
                if (targetValidation.status === 'error') continue;
                
                compatibleAgents.push(targetAgent);
            }

            const popup = document.createElement('div');
            popup.className = 'swap-agent-popup';
            let popupContent = '';

            if (compatibleAgents.length > 0) {
                popupContent = compatibleAgents.map(agent => 
                    `<div class="swap-agent-item" data-rut="${agent.rut}">${agent.nombre}</div>`
                ).join('');
            } else {
                popupContent = `<div class="no-compatible-agents">No se encontraron intercambios compatibles.</div>`;
            }
            
            popup.innerHTML = `
                <div class="swap-agent-popup-header-title">Intercambios Compatibles</div>
                <div class="swap-agent-list">${popupContent}</div>
            `;
            
            sourceSection.querySelector('.agent-header').appendChild(popup);

             popup.addEventListener('click', (event) => {
                const selectedItem = event.target.closest('.swap-agent-item');
                if (selectedItem) {
                    const destinationRut = selectedItem.dataset.rut;
                    if (!addedAgents.has(destinationRut)) {
                        const newSection = createAgentSection(destinationRut, simWeekSelector.value);
                        if (newSection) {
                            simulationContainer.appendChild(newSection);
                            addedAgents.add(destinationRut);
                            updateAddAgentSelector();
                        }
                    }
                    setTimeout(() => performAgentSwap(sourceSection, destinationRut), 50);
                    closeAllSwapPopups();
                }
            });

            e.stopPropagation();
        }
        
        function closeAllSwapPopups() {
            document.querySelectorAll('.swap-agent-popup').forEach(p => p.remove());
        }
        
        function getModifiableScheduleData(agentSection) {
            const schedule = [];
            agentSection.querySelectorAll('.modifiable-schedule tbody tr').forEach(row => {
                schedule.push({
                    startTime: row.querySelector('.start-time').value,
                    endTime: row.querySelector('.end-time').value,
                    colacion: row.querySelector('.colacion-select').value
                });
            });
            return schedule;
        }
        
        function setModifiableScheduleData(agentSection, scheduleData) {
            agentSection.querySelectorAll('.modifiable-schedule tbody tr').forEach((row, index) => {
                const dayData = scheduleData[index];
                if (dayData) {
                    row.querySelector('.start-time').value = dayData.startTime;
                    row.querySelector('.end-time').value = dayData.endTime;
                    row.querySelector('.colacion-select').value = dayData.colacion;
                }
            });
        }

        function performAgentSwap(sourceSection, destinationAgentRut) {
            let destinationSection = document.querySelector(`.agent-section[data-agent-rut="${destinationAgentRut}"]`);
            if (!destinationSection) return;
            
            const sourceScheduleData = getModifiableScheduleData(sourceSection);
            const destinationScheduleData = getModifiableScheduleData(destinationSection);
            
            setModifiableScheduleData(sourceSection, destinationScheduleData);
            setModifiableScheduleData(destinationSection, sourceScheduleData);
            
            updateAndValidateAgent(sourceSection);
            updateAndValidateAgent(destinationSection);
        }
        
        // --- INICIO: NUEVA FUNCIÓN ---
        function displayInvalidAgents() {
            const invalidAgentsSection = document.getElementById('invalidAgentsSection');
            const invalidAgentsList = document.getElementById('invalidAgentsList');
            const weekStartISO = simWeekSelector.value;

            if (!weekStartISO) {
                invalidAgentsSection.style.display = 'none';
                return;
            }

            invalidAgentsList.innerHTML = '<p style="color: var(--text-medium);">Analizando turnos originales...</p>';
            invalidAgentsSection.style.display = 'block';
            
            setTimeout(() => {
                const invalidAgents = [];
                for (const agent of availableAgents) {
                    const originalSchedule = getScheduleForAgent(agent.rut, weekStartISO, true);
                    const validationResult = getFullValidationResult(agent.rut, originalSchedule);

                    if (validationResult.status === 'error' || validationResult.status === 'warning') {
                        invalidAgents.push({
                            name: agent.nombre,
                            status: validationResult.status,
                            messages: validationResult.messages
                        });
                    }
                }

                invalidAgentsList.innerHTML = ''; 

                if (invalidAgents.length > 0) {
                    invalidAgents.forEach(agent => {
                        const uniqueMessages = [...new Set(agent.messages)];
                        const messagesHTML = uniqueMessages.map(m => `<li>${m}</li>`).join('');
                        const borderColor = agent.status === 'error' ? 'var(--color-error)' : 'var(--color-warning)';
                        
                        const agentItemHTML = `
                            <div class="invalid-agent-item" style="background: var(--panel-bg); border: 1px solid var(--panel-border); border-left: 4px solid ${borderColor}; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                                <div class="agent-name" style="font-weight: 700; color: var(--text); margin-bottom: 8px;">${agent.name}</div>
                                <ul style="list-style-type: none; padding-left: 0; font-size: 12px; color: var(--text-medium); display: flex; flex-direction: column; gap: 5px;">
                                    ${messagesHTML}
                                </ul>
                            </div>
                        `;
                        invalidAgentsList.insertAdjacentHTML('beforeend', agentItemHTML);
                    });
                } else {
                    invalidAgentsList.innerHTML = '<p style="color: var(--success);">✅ Todos los turnos originales para los servicios seleccionados cumplen la normativa.</p>';
                }
            }, 50);
        }
        // --- FIN: NUEVA FUNCIÓN ---

        function excelSerialToDate(serial) { if (typeof serial !== 'number' || serial < 1) return null; const utcDate = new Date((serial - 25569) * 86400 * 1000); return new Date(utcDate.getTime() + (utcDate.getTimezoneOffset() * 60000)); }
        function parseDateTime(value, dateRef) { if (value === null || typeof value !== 'number') return null; if (value > 1) return excelSerialToDate(value); if (value >= 0 && value < 1 && dateRef instanceof Date) { const totalMs = Math.round(value * 24 * 60 * 60 * 1000); const combined = new Date(dateRef); combined.setHours(0,0,0,0); combined.setTime(combined.getTime() + totalMs); return combined; } return null; }

        function formatTime(t) {
            if (t === null || t === undefined || t === '') return '';
            if (t instanceof Date) return `${String(t.getHours()).padStart(2, '0')}:${String(t.getMinutes()).padStart(2, '0')}`;
            if (typeof t === 'number' && t >= 0 && t < 1) {
                const totalMinutes = Math.round(t * 1440);
                const hours = Math.floor(totalMinutes / 60).toString().padStart(2, '0');
                const minutes = (totalMinutes % 60).toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            }
            let timeStr = String(t).trim();
            if (timeStr.match(/^\d{1,2}:\d{2}/)) {
                const [h, m] = timeStr.split(':');
                return `${h.padStart(2, '0')}:${m.padStart(2, '0')}`;
            }
            return '';
        }

        function calculateMinutes(start, end) {
            if (!start || !end) return NaN;
            let st = new Date(`1970-01-01T${start}`);
            let et = new Date(`1970-01-01T${end}`);
            if (isNaN(st.getTime()) || isNaN(et.getTime())) return NaN;
            if (et <= st) et.setDate(et.getDate() + 1);
            return (et - st) / 60000;
        }

        function findKey(o, names) { 
            if (!o || !names) return null;
            const keys = Object.keys(o);
            const lowerCaseNames = names.map(n => String(n).replace(/[\s_]+/g,'').toLowerCase());
            return keys.find(k => lowerCaseNames.includes(String(k).replace(/[\s_]+/g,'').toLowerCase()));
        }

        function findVal(o, names) { 
            const key = findKey(o, names); 
            return key ? o[key] : null; 
        }
        
        function getMonday(date) { 
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }
        
        async function handleDownloadWithTemplate() {
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '⏳ Generando...';

            try {
                const weekStartISO = simWeekSelector.value;
                if (!weekStartISO) throw new Error("Por favor, selecciona una semana para descargar.");

                const agentSections = document.querySelectorAll('.agent-section');
                if (agentSections.length === 0) throw new Error("No hay ejecutivos en la simulación para descargar.");

                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Cambios de Turno');

                worksheet.columns = [ { width: 10.26 }, { width: 10.26 }, { width: 10.26 }, { width: 10.26 }, { width: 10.26 }, { width: 10.26 }, { width: 10.26 }, { width: 10.26 }, { width: 10.26 }, { width: 10.26 }, { width: 10.26 }, { width: 10.26 }, { width: 10.26 }, { width: 10.26 }, { width: 2 }, { width: 30 } ];

                const weekStart = new Date(weekStartISO);
                const weekEnd = new Date(new Date(weekStart).setDate(weekStart.getDate() + 6));
                const startDay = String(weekStart.getDate()).padStart(2, '0');
                const endDay = String(weekEnd.getDate()).padStart(2, '0');
                const monthName = weekEnd.toLocaleDateString('es-ES', { month: 'long' });
                const mainTitleText = `CAMBIOS TURNO DEL ${startDay} AL ${endDay} ${monthName.toUpperCase()}`;
                
                const titleRow = worksheet.getRow(3);
                const titleCell = titleRow.getCell(2);
                titleCell.value = mainTitleText;
                worksheet.mergeCells('B3:N3');
                
                titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF002060' } };
                titleCell.font = { color: { argb: 'FFFFFFFF' }, bold: true, size: 12, name: 'Calibri' };
                titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
                titleCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                const applySubtitleStyle = (cell) => { cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0A3041' } }; cell.font = { color: { argb: 'FFFFFFFF' }, bold: true, size: 11, name: 'Calibri' }; cell.alignment = { horizontal: 'center', vertical: 'middle' }; cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } }; };
                const applyHeaderStyle = (cell, text) => { cell.value = text; cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF83CAEB' } }; cell.font = { color: { argb: 'FF000000' }, bold: true, size: 10, name: 'Calibri' }; cell.alignment = { horizontal: 'center', vertical: 'middle' }; cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } }; };
                const applyDataStyle = (cell) => { cell.font = { color: { argb: 'FF000000' }, size: 10, name: 'Calibri' }; cell.alignment = { horizontal: 'center', vertical: 'middle' }; cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } }; };
                
                let currentRowIndex = 5;
                const headers = ['RUT', 'FECHA', 'INICIO', 'TERMINO', 'JORNADA', 'COLACION'];

                agentSections.forEach((section) => {
                    const agentRut = section.dataset.agentRut;
                    const agent = fullAgentList.find(a => a.rut === agentRut);
                    const agentName = agent ? agent.nombre : '';

                    const subtitleRow = worksheet.getRow(currentRowIndex);
                    const subLeft = subtitleRow.getCell(2);
                    subLeft.value = 'TURNO ORIGINAL';
                    const subRight = subtitleRow.getCell(9);
                    subRight.value = 'TURNO A MODIFICAR';
                    worksheet.mergeCells(`B${currentRowIndex}:G${currentRowIndex}`);
                    worksheet.mergeCells(`I${currentRowIndex}:N${currentRowIndex}`);
                    applySubtitleStyle(subLeft);
                    applySubtitleStyle(subRight);
                    currentRowIndex++;

                    const headerRow = worksheet.getRow(currentRowIndex);
                    headers.forEach((header, index) => { applyHeaderStyle(headerRow.getCell(2 + index), header); applyHeaderStyle(headerRow.getCell(9 + index), header); });
                    currentRowIndex++;
                    
                    const modifiedRows = section.querySelectorAll('.modifiable-schedule tbody tr');
                    for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                        const dataRow = worksheet.getRow(currentRowIndex + dayIndex);
                        const dayDate = new Date(new Date(weekStartISO).setDate(weekStart.getDate() + dayIndex));
                        const formattedDate = formatDateForExcel(dayDate);

                        let oIni = '', oFin = '', oCol = '', oJor = '';
                        const originalDayData = allData.find(row => findVal(row, ['rut', 'id'])?.toString() === agentRut && findVal(row, ['Fecha']) instanceof Date && findVal(row, ['Fecha']).toDateString() === dayDate.toDateString());
                        if (originalDayData) { oIni = formatTime(findVal(originalDayData, ['Ini', 'inicio'])); oFin = formatTime(findVal(originalDayData, ['FIN', 'termino'])); oCol = findVal(originalDayData, ['Dur_ Colac', 'colacion']) || '0'; if (oIni && oFin) oJor = ((calculateMinutes(oIni, oFin) - (parseInt(oCol) || 0)) / 60); }

                        const originalValues = [agentRut, formattedDate, oIni || 'LIBRE', oFin || 'LIBRE', (typeof oJor === 'number') ? oJor.toFixed(1) : '', oIni ? oCol : ''];
                        originalValues.forEach((val, i) => dataRow.getCell(2 + i).value = val);
                        
                        const mRow = modifiedRows[dayIndex];
                        const mIni = mRow.querySelector('.start-time').value;
                        const mFin = mRow.querySelector('.end-time').value;
                        const mCol = mRow.querySelector('.colacion-select').value;
                        const mJorText = mRow.querySelector('.worked-hours').textContent;
                        const mJor = isNaN(parseFloat(mJorText)) ? "" : parseFloat(mJorText);

                        const modifiedValues = [agentRut, formattedDate, mIni || 'LIBRE', mFin || 'LIBRE', (typeof mJor === 'number') ? mJor.toFixed(1) : '', mIni ? mCol : ''];
                        modifiedValues.forEach((val, i) => dataRow.getCell(9 + i).value = val);

                        for (let col = 2; col <= 7; col++) applyDataStyle(dataRow.getCell(col));
                        for (let col = 9; col <= 14; col++) applyDataStyle(dataRow.getCell(col));
                        
                        if (dayIndex === 0) { const nameCell = dataRow.getCell('P'); nameCell.value = agentName; applyDataStyle(nameCell); nameCell.alignment = { horizontal: 'left', vertical: 'middle' }; }
                    }
                    currentRowIndex += 7; 
                });

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Cambios Turnos ${startDay} al ${endDay} ${monthName}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                downloadBtn.innerHTML = '✅ Descargado';
            } catch(err) {
                console.error("Error al descargar el archivo:", err);
                alert("Ocurrió un error al generar el archivo de Excel: " + err.message);
                downloadBtn.innerHTML = '❌ Error';
            } finally {
                setTimeout(() => {
                    downloadBtn.disabled = false;
                    downloadBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg> Descargar Simulación`;
                }, 3000);
            }
        }
        
        async function handleMasterDownload() {
            applyDownloadBtn.disabled = true;
            applyDownloadBtn.innerHTML = '⏳ Aplicando...';

            try {
                const weekStartISO = simWeekSelector.value;
                if (!weekStartISO) throw new Error("Por favor, selecciona una semana para procesar.");

                const weekStart = new Date(weekStartISO);
                const weekEnd = new Date(new Date(weekStart).setDate(weekStart.getDate() + 6));
                
                const startDay = String(weekStart.getDate()).padStart(2, '0');
                const endDay = String(weekEnd.getDate()).padStart(2, '0');
                const monthName = weekEnd.toLocaleDateString('es-ES', { month: 'long' });

                let weekData = allData.filter(row => { const fecha = findVal(row, ['Fecha']); return fecha instanceof Date && fecha >= weekStart && fecha <= weekEnd; });
                weekData = weekData.filter(row => selectedServices.includes(findVal(row, ['Servicio'])));

                const modifications = new Map();
                document.querySelectorAll('.agent-section').forEach(section => {
                    const agentRut = section.dataset.agentRut;
                    const dailyChanges = [];
                    section.querySelectorAll('.modifiable-schedule tbody tr').forEach((row) => { dailyChanges.push({ startTime: row.querySelector('.start-time').value, endTime: row.querySelector('.end-time').value, colacion: row.querySelector('.colacion-select').value }); });
                    modifications.set(agentRut, dailyChanges);
                });

                const finalData = weekData.map(originalRow => {
                    const rowRut = findVal(originalRow, ['Rut', 'id'])?.toString();
                    const rowDate = findVal(originalRow, ['Fecha']);
                    
                    if (rowDate instanceof Date && modifications.has(rowRut)) {
                        const dayIndex = (rowDate.getDay() + 6) % 7;
                        const change = modifications.get(rowRut)[dayIndex];
                        const newRow = { ...originalRow };
                        const iniKey = findKey(newRow, ['ini', 'inicio', 'INICIO TURNO']);
                        const finKey = findKey(newRow, ['fin', 'termino', 'FIN DEL TURNO']);
                        const colacionKey = findKey(newRow, ['dur_ colac', 'dur_colac', 'colacion', 'descanso']);
                        if(change.startTime) { if(iniKey) newRow[iniKey] = change.startTime; if(finKey) newRow[finKey] = change.endTime; if(colacionKey) newRow[colacionKey] = change.colacion; } 
                        else { if(iniKey) newRow[iniKey] = 'LIBRE'; if(finKey) newRow[finKey] = 'LIBRE'; if(colacionKey) newRow[colacionKey] = 0; }
                        return newRow;
                    }
                    return originalRow;
                });
                
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Turnos Aplicados');
                worksheet.columns = [ { width: 10.27 }, { width: 10.27 }, { width: 35.55 }, { width: 10.27 }, { width: 10.27 }, { width: 10.27 }, { width: 10.27 }, { width: 10.27 }, { width: 10.27 }, { width: 10.27 }, { width: 10.27 }, { width: 10.27 }, { width: 10.27 }, { width: 10.27 }, { width: 10.27 }, { width: 11.73 }, { width: 20.09 } ];
                
                const headers = ['Rut','Lugar','Nombre','Estado','Fecha','Dia  ','INI','FIN','Dur_Tur  ','Desc_1','Ini_ Colac','Fin_ Colac','Desc_2','Dur_ Colac','HC','Encargado','Servicio'];
                const headerRow = worksheet.getRow(1);
                headerRow.height = 20;
                headerRow.customHeight = true;
                headers.forEach((header, index) => { const cell = headerRow.getCell(index + 1); cell.value = header; cell.font = { name: 'Calibri', size: 11, bold: true, color: { argb: 'FFC00000' } }; cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD0CECE' } }; cell.alignment = { horizontal: 'center', vertical: 'middle' }; cell.border = { top: { style: 'dotted' }, left: { style: 'dotted' }, bottom: { style: 'dotted' }, right: { style: 'dotted' } }; });

                finalData.forEach((dataRow, rowIndex) => {
                    const row = worksheet.getRow(rowIndex + 2);
                    row.height = 14.50;
                    row.customHeight = true;
                    const currentRut = findVal(dataRow, ['Rut', 'id']);
                    const previousRut = rowIndex > 0 ? findVal(finalData[rowIndex - 1], ['Rut', 'id']) : null;
                    const isNewAgent = (rowIndex === 0) || (currentRut !== previousRut);
                    headers.forEach((header, colIndex) => { const cell = row.getCell(colIndex + 1); const originalHeaderKey = findKey(dataRow, [header.trim()]); let value = originalHeaderKey ? dataRow[originalHeaderKey] : ''; if (header.toLowerCase().trim() === 'fecha' && value instanceof Date) { cell.value = value; cell.numFmt = 'dd-mm-yyyy'; } else { cell.value = value; } cell.font = { name: 'Calibri', size: 11, color: { argb: 'FF000000' } }; cell.alignment = { horizontal: 'left', vertical: 'middle' }; cell.border = { top: { style: isNewAgent ? 'thin' : 'dotted' }, left: { style: 'dotted' }, bottom: { style: 'dotted' }, right: { style: 'dotted' } }; });
                });
                
                worksheet.properties.defaultRowHeight = 14.50;

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Turnos_Aplicados_Semana_${startDay}-${endDay}_${monthName}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                applyDownloadBtn.innerHTML = '✅ Aplicado';
            } catch(err) {
                console.error("Error en la descarga maestra:", err);
                alert("Ocurrió un error: " + err.message);
                applyDownloadBtn.innerHTML = '❌ Error';
            } finally {
                setTimeout(() => {
                    applyDownloadBtn.disabled = false;
                    applyDownloadBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2-square" viewBox="0 0 16 16"><path d="M3 14.5A1.5 1.5 0 0 1 1.5 13V3A1.5 1.5 0 0 1 3 1.5h8a.5.5 0 0 1 0 1H3a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h10a.5.5 0 0 0 .5-.5V8a.5.5 0 0 1 1 0v5a1.5 1.5 0 0 1-1.5 1.5z"/><path d="m8.354 10.354 7-7a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0"/></svg> Aplicar y Descargar`;
                }, 3000);
            }
        }

        function formatDateForExcel(date) {
            if (!date) return "";
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        loadDataFromURL();
    });
    </script>
</body>
</html>
