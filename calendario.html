<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generador de Calendario de Presencialidad IA</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<style>
  :root {
    --bg-grad: radial-gradient(circle at 40% 30%, #0d1b2a 0%, #0a1a2a 30%, #11263d 70%, #081420 100%);
    --primary: #ffffff;
    --panel-bg: rgba(8, 20, 32, 0.72);
    --panel-border: rgba(0, 122, 255, 0.5);
    --text: #ffffff;
    --muted: #9ec1d9;
    --font: 'Inter', sans-serif;
    --success: #16a34a;
    --accent: #00e5ff;
    --color-error: #dc3545;
  }

  html, body { height: 100%; margin: 0; }
  body {
    display: grid;
    place-items: center;
    background: var(--bg-grad);
    font-family: var(--font);
    color: var(--text);
    overflow: hidden;
  }

  #neuronCanvas {
    position: fixed; inset: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.85;
    pointer-events: none;
  }

  .main-container {
    position: relative; z-index: 2;
    width: min(900px, 90vw);
    border-radius: 22px;
    background: var(--panel-bg);
    border: 1px solid var(--panel-border);
    box-shadow: 0 0 40px rgba(66, 133, 244, 0.35), inset 0 0 0 1px rgba(255,255,255,0.04);
    animation: panelIn 700ms ease-out both, shadowPulse 8s ease-in-out infinite;
    display: grid; grid-template-columns: 1fr; overflow: hidden;
  }
  @media (min-width: 800px) { .main-container { grid-template-columns: 38% 62%; } }

  @keyframes panelIn { from { opacity: 0; transform: scale(0.95) translateY(6px);} to { opacity: 1; transform: scale(1) translateY(0);} }
  
  @keyframes shadowPulse {
      0%, 100% { box-shadow: 0 0 35px rgba(66, 133, 244, 0.3), inset 0 0 0 1px rgba(255,255,255,0.04); } /* Azul */
      25% { box-shadow: 0 0 50px rgba(219, 68, 55, 0.4), inset 0 0 0 1px rgba(255,255,255,0.04); } /* Rojo */
      50% { box-shadow: 0 0 35px rgba(244, 180, 0, 0.3), inset 0 0 0 1px rgba(255,255,255,0.04); } /* Amarillo */
      75% { box-shadow: 0 0 50px rgba(15, 157, 88, 0.4), inset 0 0 0 1px rgba(255,255,255,0.04); } /* Verde */
  }

  .illustration-panel { padding: 30px; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; border-right:1px solid var(--panel-border); }
  .illustration-panel h2 { color: var(--primary); margin-bottom: .5rem; font-size: 24px; }
  .illustration-panel p { color: var(--muted); line-height: 1.6; max-width: 300px; }

  .content-panel { padding: 30px; }
  .header h1 { font-size: 1.5rem; color: var(--primary); margin-bottom: 20px; text-align: center;}

  .upload-area { /* Renamed from status-area for style consistency */
    border-radius: 12px; background: rgba(0,0,0,0.2);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    min-height:160px;margin-bottom:25px;border:1px solid var(--panel-border); transition: all 0.3s ease;
  }
  .status-content { display: none; }
    .upload-area.is-loading .loading-content,
    .upload-area.is-success .success-content,
    .upload-area.is-error .error-content {
        display: flex; flex-direction: column; align-items: center;
        justify-content: center; gap: 15px; z-index: 10;
        width: 100%;
    }
  .upload-area.is-success { border-color: rgba(22, 163, 74, 0.5); box-shadow: 0 0 20px rgba(22, 163, 74, 0.4); }
  .upload-area.is-error { border-color: rgba(220, 53, 69, 0.5); box-shadow: 0 0 20px rgba(220, 53, 69, 0.4); }

  .techno-loader { position: relative; width: 80px; height: 80px; }
  .core-pulse {
    width: 20%; height: 20%; background: #fff; border-radius: 50%;
    box-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px var(--accent);
    position: absolute; top: 40%; left: 40%; animation: corePulse 1.5s ease-in-out infinite;
  }
  @keyframes corePulse { 0%,100%{transform:scale(0.8);opacity:0.7;} 50%{transform:scale(1.2);opacity:1;} }
  
  .circuit-flow { 
    fill:none; stroke-width:1.5; stroke-dasharray:100; stroke-dashoffset:100; 
    animation: flow 3s linear infinite, colorCycle 6s linear infinite;
  }
  @keyframes flow { to{stroke-dashoffset:-100;} }
  @keyframes colorCycle {
      0%, 100% { stroke: #00e5ff; } /* Cian */
      33%      { stroke: #ff00e5; } /* Magenta */
      66%      { stroke: #a8ff00; } /* Verde Lima */
  }

  #dynamicStatusText, .status-text-dynamic { margin-top: 10px; font-size: 14px; text-align: center; color: var(--muted); }
    .success-icon svg path {
        stroke: var(--success); stroke-dasharray: 29; stroke-dashoffset: 29;
        animation: drawCheck 0.4s 0.2s cubic-bezier(0.76, 0, 0.24, 1) forwards;
    }
    @keyframes drawCheck { to { stroke-dashoffset: 0; } }
    .success-text { color: var(--success); font-size: 16px; font-weight: 600; }
    .error-icon { height: 40px; width: 40px; color: var(--color-error); }
    .error-text { color: var(--color-error); font-size: 16px; font-weight: 600; }

    #weekSelectorContainer { display: none; margin-top: 20px; animation: fadeIn 0.5s; }
    #weekSelectorContainer label { display: block; margin-bottom: 10px; font-weight: 600; color: var(--muted); }
    
    .custom-select-wrapper { position: relative; }
    .custom-select-trigger {
        width: 100%; padding: 12px 15px; border-radius: 8px;
        background: rgba(0, 0, 0, 0.2); border: 1px solid var(--panel-border);
        color: var(--text); font-family: var(--font); font-size: 16px;
        cursor: pointer; display: flex;
        justify-content: space-between; align-items: center;
        transition: all 0.3s ease;
    }
    .custom-select-trigger:hover, .custom-select-wrapper.open .custom-select-trigger {
        border-color: var(--panel-border);
        box-shadow: 0 0 15px rgba(0, 122, 255, 0.3);
    }
    .custom-select-trigger::after { content: '▼'; font-size: 12px; color: var(--muted); transition: transform 0.3s ease; }
    .custom-select-wrapper.open .custom-select-trigger::after { transform: rotate(180deg); }
    
    .custom-options {
        position: absolute; top: 105%; left: 0; right: 0;
        background: var(--panel-bg); backdrop-filter: blur(10px);
        border-radius: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        z-index: 100; max-height: 200px; overflow-y: auto;
        border: 1px solid var(--panel-border);
        opacity: 0; visibility: hidden; transform: translateY(-10px);
        transition: all 0.3s ease;
    }
    .custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; transform: translateY(0); }
    .custom-option { padding: 12px 15px; cursor: pointer; transition: background-color 0.2s ease; border-bottom: 1px solid rgba(0, 122, 255, 0.1); }
    .custom-option:last-child { border-bottom: none; }
    .custom-option:hover { background-color: rgba(0, 122, 255, 0.1); }
    .custom-option.selected { background-color: rgba(0, 122, 255, 0.2); font-weight: 600; color: #fff; }
    #weekSelector { display: none; }

  .button-container { text-align:center; margin-top:25px; }
  .button { background: var(--success); color:#fff; padding:12px 28px; border:none; border-radius:10px; font-weight:bold; cursor:pointer; transition:.3s; font-size: 16px; }
  .button:hover:not(:disabled) { box-shadow:0 0 20px rgba(22,163,74,.6); transform:translateY(-2px); }
  .button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
    
    .status-message {
        text-align: center; margin-top: 20px; padding: 15px; border-radius: 10px;
        display: none; animation: slideDown 0.5s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .status-message.success { background: rgba(22, 163, 74, 0.2); border: 1px solid rgba(22, 163, 74, 0.5); color: var(--success); display: block; }
    .status-message.error { background: rgba(220, 53, 69, 0.2); border: 1px solid rgba(220, 53, 69, 0.5); color: var(--color-error); display: block; }

    /* --- ESTILOS PARA PANELES DE CONFIGURACIÓN --- */
    #agentConfigContainer { display: none; margin-top: 20px; animation: fadeIn 0.5s; }
    .config-header { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px; }
    .config-btn {
        background: transparent; border: none; cursor: pointer;
        color: var(--muted); padding: 5px; border-radius: 50%;
        transition: all 0.2s ease;
        display: inline-flex; justify-content: center; align-items: center;
        width: 36px; height: 36px;
    }
    .config-btn:hover { background-color: rgba(0, 122, 255, 0.15); color: var(--text); }
    .config-btn.is-active { color: var(--accent); animation: blink-active 1.5s infinite; }
    @keyframes blink-active { 50% { opacity: 0.4; } }

    .config-panel {
        display: none; margin-top: 15px; animation: fadeIn 0.5s;
        background: var(--panel-bg); backdrop-filter: blur(10px);
        border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        padding: 0; z-index: 100; text-align: left;
        border: 1px solid var(--panel-border);
    }
    .config-panel h4 {
        padding: 15px 20px; margin: 0; font-size: 16px;
        color: var(--text); border-bottom: 1px solid var(--panel-border);
    }
    .agents-list, .service-list { max-height: 40vh; overflow-y: auto; padding: 10px; }
    .agent-item { padding: 15px; border-bottom: 1px solid rgba(0, 122, 255, 0.1); display: grid; grid-template-columns: 2fr 1fr 2fr auto; gap: 15px; align-items: start; }
    .agent-item:last-child { border-bottom: none; }
    .agent-item:hover { background-color: rgba(0, 122, 255, 0.1); }
    .agent-name { font-weight: 600; color: var(--text); margin-bottom: 2px; }
    .agent-config { display: flex; flex-direction: column; gap: 5px; }
    .config-select {
        padding: 8px; border: 1px solid var(--panel-border); border-radius: 6px;
        font-size: 14px; background: rgba(0,0,0,0.3); color: var(--text); width: 100%;
    }
    .day-checkboxes { display: flex; gap: 5px; flex-wrap: wrap; }
    .day-checkbox-label { display: flex; align-items: center; gap: 3px; font-size: 12px; color: var(--muted); }
    .view-special-btn { padding: 6px 10px; font-size: 12px; margin-bottom: 10px; width: fit-content; background: rgba(0,0,0,0.3); color: var(--text); border: 1px solid var(--panel-border); border-radius: 6px; cursor: pointer; }
    .special-config { display: none; margin-top: 10px; padding: 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--panel-border); border-radius: 6px; max-height: 50vh; overflow-y: auto; }
    .special-config.active { display: block; }
    .special-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px; align-items: center; }
    .special-option label { display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer; color: var(--muted); }
    .remove-btn { padding: 8px 12px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s; }
    .remove-btn:hover { background: #b91c1c; }
    .add-agent-section { padding: 15px; background: rgba(0,0,0,0.1); border-top: 1px solid var(--panel-border); }
    .add-agent-controls { display: flex; gap: 10px; align-items: center; }
    .add-agent-select { flex: 1; padding: 10px; border: 1px solid var(--panel-border); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--text); }
    .add-btn { background-image: linear-gradient(45deg, #00aaff 0%, #007bff 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
    .add-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4); }
    .service-item label { display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer; padding: 5px; border-radius: 4px; transition: background-color 0.2s ease; color: var(--muted); }
    .service-item label:hover { background-color: rgba(0, 122, 255, 0.1); }
</style>
</head>
<body>
<canvas id="neuronCanvas"></canvas>
<div class="main-container">
  <div class="illustration-panel">
    <h2>Calendario Inteligente</h2>
    <p>Genera automáticamente la distribución de Site y Teletrabajo basado en patrones personalizables por agente, sincronizado desde la nube.</p>
  </div>
  <div class="content-panel">
    <div class="header"><h1>Generador de Calendario de Presencialidad</h1></div>

    <div class="upload-area" id="statusContainer">
         <div class="status-content loading-content">
            <div class="techno-loader">
                <svg viewBox="0 0 100 100">
                    <path class="circuit-flow" id="flow-1" d="M 50,50 m -25,0 a 25,25 0 1,1 50,0 a 25,25 0 1,1 -50,0"></path>
                    <path class="circuit-flow" id="flow-2" d="M 50,50 m -35,0 a 35,35 0 1,0 70,0 a 35,35 0 1,0 -70,0" style="animation-delay:.5s"></path>
                    <path class="circuit-flow" id="flow-3" d="M 50,10 V 90 M 10,50 H 90" style="animation-delay:1s"></path>
                </svg>
                <div class="core-pulse"></div>
            </div>
            <div class="status-text-dynamic" id="dynamicStatusText"></div>
         </div>
         <div class="status-content success-content">
            <div class="success-icon"><svg viewBox="0 0 24 24"><path fill="none" stroke-width="2.5" stroke="currentColor" d="M5,13 l4,4 l10,-10" /></svg></div>
            <div class="success-text">Sincronización completa</div>
         </div>
         <div class="status-content error-content">
            <div class="status-icon error-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg></div>
            <div class="error-text" id="errorText"></div>
         </div>
    </div>

    <div id="weekSelectorContainer">
        <label for="weekSelector">1. Selecciona la semana a procesar</label>
        <div class="custom-select-wrapper" id="customSelect">
            <select id="weekSelector"></select>
            <div class="custom-select-trigger" id="customSelectTrigger">-- Esperando datos --</div>
            <div class="custom-options" id="customOptions"></div>
        </div>
    </div>

    <div id="agentConfigContainer">
        <div class="config-header">
            <button class="config-btn" id="toggleAgentConfigBtn" title="Configurar Agentes">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M19.82 10.99 21 12l-1.18 1.01-.01.01c-.47 2.09-2.32 3.65-4.54 3.86l-.01.01L14 18.04V19a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.96l-1.25-1.17-.01-.01c-2.22-.21-4.07-1.77-4.54-3.86l-.01-.01L3 12l1.18-1.01.01-.01c.47-2.09 2.32-3.65 4.54-3.86l.01-.01L10 5.96V5a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.96l1.25 1.17.01.01c2.22.21 4.07 1.77 4.54 3.86l.01.01ZM12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/></svg>
            </button>
            <button class="config-btn" id="toggleServiceConfigBtn" title="Filtrar Servicios">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M3 4h18v2H3V4Zm2 7h14v2H5v-2Zm4 7h6v2H9v-2Z"/></svg>
            </button>
        </div>
        <div class="config-panel" id="serviceConfigPanel">
            <h4>Servicios a Incluir</h4>
            <div class="service-list" id="serviceList"></div>
        </div>
        <div class="config-panel" id="agentsConfigPanel">
             <h4>Configuración de Agentes</h4>
            <div class="agents-list" id="agentsList"></div>
            <div class="add-agent-section" id="addAgentSection">
                <div class="add-agent-controls">
                    <select class="add-agent-select" id="addAgentSelect">
                        <option value="">Seleccionar agente para agregar...</option>
                    </select>
                    <button class="add-btn" id="addAgentBtn">+ Agregar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="button-container" id="actionsContainer" style="display: none;">
        <button class="button" id="generateBtn" disabled>Generar Calendario</button>
    </div>
    <div class="status-message" id="statusMessage"></div>
  </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let allData = null, turnosData = null, generatedWorkbook = null, fileName = '';
        let availableAgents = [], configuredAgents = new Map();
        let uniqueServices = new Set();
        let calendarResults = new Map();
        let statusInterval;

        // --- ELEMENTOS DEL DOM ---
        const statusContainer = document.getElementById('statusContainer');
        const dynamicStatusText = document.getElementById('dynamicStatusText');
        const errorText = document.getElementById('errorText');
        const generateBtn = document.getElementById('generateBtn');
        const statusMessage = document.getElementById('statusMessage');
        const weekSelectorContainer = document.getElementById('weekSelectorContainer');
        const weekSelector = document.getElementById('weekSelector');
        const customSelect = document.getElementById('customSelect');
        const customSelectTrigger = document.getElementById('customSelectTrigger');
        const customOptions = document.getElementById('customOptions');
        const agentConfigContainer = document.getElementById('agentConfigContainer');
        const toggleAgentConfigBtn = document.getElementById('toggleAgentConfigBtn');
        const agentsConfigPanel = document.getElementById('agentsConfigPanel');
        const agentsList = document.getElementById('agentsList');
        const addAgentSection = document.getElementById('addAgentSection');
        const addAgentSelect = document.getElementById('addAgentSelect');
        const addAgentBtn = document.getElementById('addAgentBtn');
        const actionsContainer = document.getElementById('actionsContainer');
        const serviceConfigPanel = document.getElementById('serviceConfigPanel');
        const serviceList = document.getElementById('serviceList');
        const toggleServiceConfigBtn = document.getElementById('toggleServiceConfigBtn');
        
        // --- ANIMACIÓN DE FONDO ---
        const canvas = document.getElementById('neuronCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particlesArray;
        class Particle {
            constructor(x, y, size, speedX, speedY) {
                this.x = x; this.y = y; this.size = size;
                this.speedX = speedX; this.speedY = speedY;
                this.pulseSpeed = Math.random() * 0.02 + 0.005;
                this.pulseOffset = Math.random() * Math.PI * 2;
            }
            draw() {
                const pulse = Math.abs(Math.sin(this.pulseOffset + Date.now() * this.pulseSpeed));
                const alpha = 0.5 + pulse * 0.5;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
                ctx.shadowBlur = 10;
                ctx.shadowColor = `rgba(0, 122, 255, ${alpha})`;
                ctx.fillStyle = `rgba(200, 225, 255, ${alpha})`;
                ctx.fill();
                ctx.shadowBlur = 0;
            }
            update() {
                if (this.x > canvas.width || this.x < 0) this.speedX = -this.speedX;
                if (this.y > canvas.height || this.y < 0) this.speedY = -this.speedY;
                this.x += this.speedX; this.y += this.speedY;
            }
        }
        function initParticles() {
            particlesArray = [];
            let numberOfParticles = (canvas.height * canvas.width) / 12000;
            for (let i = 0; i < numberOfParticles; i++) {
                let size = (Math.random() * 1.5) + 0.8;
                let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
                let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
                let speedX = (Math.random() * 0.4) - 0.2;
                let speedY = (Math.random() * 0.4) - 0.2;
                particlesArray.push(new Particle(x, y, size, speedX, speedY));
            }
        }
        function connectParticles() {
            let opacityValue = 1;
            for (let a = 0; a < particlesArray.length; a++) {
                for (let b = a; b < particlesArray.length; b++) {
                    let distance = ((particlesArray[a].x - particlesArray[b].x) ** 2) + ((particlesArray[a].y - particlesArray[b].y) ** 2);
                    if (distance < (canvas.width / 10) * (canvas.height / 10)) {
                        opacityValue = 1 - (distance / 20000);
                        ctx.strokeStyle = `rgba(0, 122, 255, ${opacityValue * 0.25})`;
                        ctx.lineWidth = 0.8;
                        ctx.beginPath();
                        ctx.moveTo(particlesArray[a].x, particlesArray[a].y);
                        ctx.lineTo(particlesArray[b].x, particlesArray[b].y);
                        ctx.stroke();
                    }
                }
            }
        }
        function animateParticles() {
            requestAnimationFrame(animateParticles);
            ctx.clearRect(0, 0, innerWidth, innerHeight);
            for (let i = 0; i < particlesArray.length; i++) {
                particlesArray[i].update();
                particlesArray[i].draw();
            }
            connectParticles();
        }
        window.addEventListener('resize', () => { canvas.width = innerWidth; canvas.height = innerHeight; initParticles(); });
        initParticles();
        animateParticles();

        // --- EVENT LISTENERS ---
        customSelectTrigger.addEventListener('click', () => customSelect.classList.toggle('open'));
        window.addEventListener('click', (e) => { if (!customSelect.contains(e.target)) customSelect.classList.remove('open'); });
        
        toggleAgentConfigBtn.addEventListener('click', () => {
            const isVisible = agentsConfigPanel.style.display !== 'none';
            agentsConfigPanel.style.display = isVisible ? 'none' : 'block';
            toggleAgentConfigBtn.classList.toggle('is-active', !isVisible);
        });
        
        toggleServiceConfigBtn.addEventListener('click', () => {
            const isVisible = serviceConfigPanel.style.display !== 'none';
            serviceConfigPanel.style.display = isVisible ? 'none' : 'block';
            toggleServiceConfigBtn.classList.toggle('is-active', !isVisible);
        });

        addAgentBtn.addEventListener('click', addAgent);
        weekSelector.addEventListener('change', filterTurnosData);
        generateBtn.addEventListener('click', generateCalendar);

        // --- LÓGICA DE DATOS ---

        function processAndSetAgentConfigurations(rawAgentConfigs) {
            configuredAgents.clear();
            if (!Array.isArray(rawAgentConfigs)) return;

            rawAgentConfigs.forEach(agent => {
                const rut = String(agent.Rut).trim();
                if (!rut || !agent.Nombre) return;

                let conditions = [];
                const modalidad = agent.Modalidad ? String(agent.Modalidad).trim() : '';

                if (modalidad.toLowerCase() === 'especial') {
                    if (agent['Condicion Especial']) {
                        conditions = String(agent['Condicion Especial']).split(',').map(c => c.trim()).filter(Boolean);
                    }
                } else {
                    ['Condicion 1', 'Condicion 2', 'Condicion 3'].forEach(key => {
                        if (agent[key]) {
                            conditions.push(String(agent[key]).toLowerCase().trim());
                        }
                    });
                }

                const key = `${String(agent.Nombre).trim()}_${rut}`;
                configuredAgents.set(key, {
                    nombre: String(agent.Nombre).trim(),
                    rut: rut,
                    modalidad: modalidad,
                    condicion: conditions
                });
            });
        }
        
        async function loadInitialData() {
            statusContainer.className = 'upload-area is-loading';
            const statusMessages = ["Sincronizando turnos...", "Cargando configuración de agentes...", "Analizando topología...", "Enviando solicitud al núcleo...", "Recibiendo streams de datos...", "Decodificando paquetes...", "Optimizando resultados..."];
            let messageIndex = 0;
            dynamicStatusText.textContent = statusMessages[messageIndex];
            statusInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % statusMessages.length;
                dynamicStatusText.style.opacity = '0';
                setTimeout(() => { dynamicStatusText.textContent = statusMessages[messageIndex]; dynamicStatusText.style.opacity = '1'; }, 300);
            }, 1800);

            const turnosUrl = "https://prod-31.westus.logic.azure.com:443/workflows/a6c5e734ae1d4bc8a2da0972cf1ed1e0/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=mMrr6cxbsMA-cVu8pBVkiaDbJ2oMTJPBKx3MB_QPmyQ";
            const agentConfigUrl = "https://default136d6ab55b55496f97cb2424247715.ed.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/0b55d2b2572f4d9d91f6c05ef2d27a87/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=YlSXOemptuJKoxcaVwig40-UAl0oW1fnohSZbxFez6o";

            try {
                const [turnosResponse, agentConfigResponse] = await Promise.all([
                    fetch(turnosUrl, { method: "POST" }),
                    fetch(agentConfigUrl, { method: "POST" })
                ]);

                if (!turnosResponse.ok) throw new Error(`Error al cargar turnos: ${turnosResponse.statusText}`);
                if (!agentConfigResponse.ok) throw new Error(`Error al cargar configuración de agentes: ${agentConfigResponse.statusText}`);

                const rawTurnosData = await turnosResponse.json();
                const rawAgentConfigs = await agentConfigResponse.json();

                if (!Array.isArray(rawTurnosData) || rawTurnosData.length === 0) throw new Error("No se recibieron datos de turnos.");
                if (!Array.isArray(rawAgentConfigs)) throw new Error("No se recibieron datos de configuración de agentes.");

                allData = rawTurnosData.map(row => { 
                    const newRow = { ...row };
                    const fechaKey = findKey(newRow, ['Fecha', 'fecha', 'Date']);
                    const dateComponent = fechaKey ? excelSerialToDate(parseFloat(newRow[fechaKey])) : null;
                    newRow.Fecha = dateComponent;
                    
                    const timeKeys = ['Ini', 'FIN', 'Desc_1', 'Ini_ Colac', 'Fin_ Colac', 'Desc_2', 'INICIO TURNO', 'FIN DEL TURNO'];
                    timeKeys.forEach(key => {
                        const foundKey = findKey(newRow, [key]);
                        if (foundKey) newRow[foundKey] = parseDateTime(parseFloat(newRow[foundKey]), dateComponent);
                    });
                    return newRow;
                });
                
                processAndSetAgentConfigurations(rawAgentConfigs);
                
                clearInterval(statusInterval);
                statusContainer.className = 'upload-area is-success';

                extractAvailableAgents(allData);
                populateWeekSelector(allData);
                populateServiceFilter(allData);
                updateAgentsList();
                updateAddAgentSelect();
                weekSelectorContainer.style.display = 'block';
                agentConfigContainer.style.display = 'block';
                actionsContainer.style.display = 'flex';

            } catch (error) {
                console.error("Error al cargar datos:", error);
                clearInterval(statusInterval);
                statusContainer.className = 'upload-area is-error';
                errorText.textContent = error.message;
            }
        }
        
        function populateServiceFilter(data) {
            uniqueServices.clear();
            serviceList.innerHTML = '';
            const serviceKey = findKey(data[0] || {}, ['Servicio']);
            if (!serviceKey) return;
            data.forEach(row => { if (row[serviceKey]) uniqueServices.add(row[serviceKey]); });
            const sortedServices = Array.from(uniqueServices).sort();
            sortedServices.forEach(service => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'service-item';
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = service;
                if (service === '01_Masivo' || service === '10_Staff_Inbound') checkbox.checked = true;
                checkbox.addEventListener('change', filterTurnosData);
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(` ${service}`));
                itemDiv.appendChild(label);
                serviceList.appendChild(itemDiv);
            });
        }

        function extractAvailableAgents(data) {
            const agentsInTurnos = new Map();
            data.forEach(row => {
                const rut = findVal(row, ['Rut', 'id']);
                const nombre = row.Nombre ? String(row.Nombre).trim() : null;
                if (nombre && rut && !agentsInTurnos.has(rut)) {
                    agentsInTurnos.set(String(rut).trim(), { nombre, rut: String(rut).trim() });
                }
            });

            availableAgents = Array.from(agentsInTurnos.values());
        }

        function updateAgentsList() {
            agentsList.innerHTML = '';
            const sortedAgents = Array.from(configuredAgents.values()).sort((a,b) => a.nombre.localeCompare(b.nombre));
            sortedAgents.forEach((config) => {
                agentsList.appendChild(createAgentItem(config));
            });
        }

        function createAgentItem(config) {
            const div = document.createElement('div');
            div.className = 'agent-item';
            const isSpecial = config.modalidad.toLowerCase() === 'especial';
            const key = `${config.nombre}_${config.rut}`;

            div.innerHTML = `
                <div class="agent-info"><div class="agent-name">${config.nombre}</div></div>
                <div class="agent-config">
                    <select class="config-select modalidad-select">
                        <option value="4x1" ${config.modalidad === '4x1' ? 'selected' : ''}>4x1</option>
                        <option value="3x2" ${config.modalidad === '3x2' ? 'selected' : ''}>3x2</option>
                        <option value="especial" ${isSpecial ? 'selected' : ''}>Especial</option>
                    </select>
                </div>
                <div class="agent-config">
                    <button class="view-special-btn" style="display: ${isSpecial ? 'block' : 'none'};">Detalles</button>
                    <div class="day-checkboxes" style="display: ${isSpecial ? 'none' : 'flex'};">
                        ${['primer', 'segundo', 'tercer', 'cuarto', 'quinto'].map(day => `<label class="day-checkbox-label"><input type="checkbox" value="${day}" ${config.condicion?.includes(day) ? 'checked' : ''}>${day.charAt(0).toUpperCase() + day.slice(1, 3)}</label>`).join('')}
                    </div>
                    <div class="special-config">
                        ${['am', 'pm', 'noche', 'weekend_festivos'].map(type => `
                        <div class="special-row">
                            <div class="special-option"><label><input type="checkbox" class="special-checkbox" value="${type}_tt" ${config.condicion?.includes(`${type}_tt`) ? 'checked' : ''}> 🏠 ${type.replace('weekend_festivos', 'FDS/Fest.')}</label></div>
                            <div class="special-option"><label><input type="checkbox" class="special-checkbox" value="${type}_site" ${config.condicion?.includes(`${type}_site`) ? 'checked' : ''}> 🏢 ${type.replace('weekend_festivos', 'FDS/Fest.')}</label></div>
                        </div>`).join('')}
                    </div>
                </div>
                <button class="remove-btn" data-key="${key}">×</button>`;

            const modalidadSelect = div.querySelector('.modalidad-select');
            const dayCheckboxContainer = div.querySelector('.day-checkboxes');
            const specialConfigContainer = div.querySelector('.special-config');
            const viewSpecialBtn = div.querySelector('.view-special-btn');

            modalidadSelect.addEventListener('change', (e) => {
                const isNowSpecial = e.target.value === 'especial';
                dayCheckboxContainer.style.display = isNowSpecial ? 'none' : 'flex';
                viewSpecialBtn.style.display = isNowSpecial ? 'block' : 'none';
                specialConfigContainer.classList.remove('active');
                viewSpecialBtn.textContent = 'Detalles';
                updateAgentConfig(key);
            });

            viewSpecialBtn.addEventListener('click', () => {
                const isActive = specialConfigContainer.classList.toggle('active');
                viewSpecialBtn.textContent = isActive ? 'Ocultar' : 'Detalles';
            });

            div.querySelectorAll('.day-checkboxes input, .special-checkbox').forEach(cb => cb.addEventListener('change', (e) => {
                if (e.target.checked && e.target.classList.contains('special-checkbox')) {
                    let conflictingValue = e.target.value.includes('_tt') ? e.target.value.replace('_tt', '_site') : e.target.value.replace('_site', '_tt');
                    const conflictingCheckbox = div.querySelector(`input[value="${conflictingValue}"]`);
                    if (conflictingCheckbox) conflictingCheckbox.checked = false;
                }
                updateAgentConfig(key);
            }));
            
            div.querySelector('.remove-btn').addEventListener('click', function() {
                removeAgent(this.dataset.key);
            });
            return div;
        }

        function updateAgentConfig(key) {
            const config = configuredAgents.get(key);
            if (!config) return;
            const agentItem = Array.from(agentsList.children).find(item => item.querySelector('.remove-btn')?.dataset.key === key);
            if (agentItem) {
                config.modalidad = agentItem.querySelector('.modalidad-select').value;
                config.condicion = config.modalidad === 'especial'
                    ? Array.from(agentItem.querySelectorAll('.special-checkbox:checked')).map(cb => cb.value)
                    : Array.from(agentItem.querySelectorAll('.day-checkboxes input:checked')).map(cb => cb.value);
            }
        }

        function updateAddAgentSelect() {
            addAgentSelect.innerHTML = '<option value="">Seleccionar agente para agregar...</option>';
            const sortedAvailable = availableAgents.sort((a,b) => a.nombre.localeCompare(b.nombre));
            sortedAvailable.forEach(agent => {
                const key = agent.nombre + '_' + agent.rut;
                if (!configuredAgents.has(key)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${agent.nombre}`;
                    addAgentSelect.appendChild(option);
                }
            });
        }

        function addAgent() {
            const selectedKey = addAgentSelect.value;
            if (!selectedKey) return;
            const [nombre, rut] = selectedKey.split('_');
            configuredAgents.set(selectedKey, { nombre, rut, modalidad: '4x1', condicion: ['primer'] });
            updateAgentsList();
            updateAddAgentSelect();
        }

        function removeAgent(key) {
            configuredAgents.delete(key);
            updateAgentsList();
            updateAddAgentSelect();
        }

        function populateWeekSelector(data) {
            const weekSet = new Set();
            data.forEach(row => { if (row.Fecha instanceof Date && !isNaN(row.Fecha)) { weekSet.add(getMonday(row.Fecha).toISOString()); } });
            const sortedWeeks = Array.from(weekSet).sort((a, b) => new Date(b) - new Date(a));
            const last4Weeks = sortedWeeks.slice(0, 4);
            weekSelector.innerHTML = ''; customOptions.innerHTML = '';
            if (last4Weeks.length === 0) {
                customSelectTrigger.textContent = 'No se encontraron semanas';
                return;
            }
            customSelectTrigger.textContent = '-- Selecciona una semana --';
            last4Weeks.forEach(mondayISO => {
                const monday = new Date(mondayISO); const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
                const optionText = `Semana del ${monday.getDate()} de ${monday.toLocaleString('es-ES', { month: 'short' })} al ${sunday.getDate()} de ${sunday.toLocaleString('es-ES', { month: 'short' })}`;
                const option = document.createElement('option'); option.value = mondayISO; option.textContent = optionText; weekSelector.appendChild(option);
                const customOption = document.createElement('div'); customOption.className = 'custom-option'; customOption.textContent = optionText; customOption.dataset.value = mondayISO;
                customOption.addEventListener('click', () => {
                    customSelectTrigger.textContent = customOption.textContent; weekSelector.value = customOption.dataset.value;
                    weekSelector.dispatchEvent(new Event('change'));
                    document.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
                    customOption.classList.add('selected'); customSelect.classList.remove('open');
                });
                customOptions.appendChild(customOption);
            });
        }

        function filterTurnosData() {
            const selectedMondayISO = weekSelector.value;
            if (!selectedMondayISO || !allData) {
                turnosData = null; generateBtn.disabled = true; return;
            }
            const selectedServices = Array.from(serviceList.querySelectorAll('input:checked')).map(cb => cb.value);
            const serviceKey = findKey(allData[0] || {}, ['Servicio']);
            const selectedMonday = new Date(selectedMondayISO);
            const nextMonday = new Date(selectedMonday); nextMonday.setDate(selectedMonday.getDate() + 7);
            let weeklyData = allData.filter(row => {
                if (!row || !row.Fecha) return false;
                const rowDate = new Date(row.Fecha);
                return rowDate >= selectedMonday && rowDate < nextMonday;
            });
            turnosData = (serviceKey && selectedServices.length > 0) ? weeklyData.filter(row => selectedServices.includes(row[serviceKey])) : weeklyData;
            generateBtn.disabled = turnosData.length === 0;
        }

        async function generateCalendar() {
            if (!turnosData || turnosData.length === 0) { showStatus('No hay datos para procesar.', 'error'); return; }
            if (configuredAgents.size === 0) { showStatus('No hay agentes configurados para procesar.', 'error'); return; }
            
            calendarResults.clear();
            generateBtn.disabled = true;
            const originalText = generateBtn.textContent;
            generateBtn.textContent = 'Generando...';

            setTimeout(async () => {
                try {
                    await createCalendarWorkbook();
                    generateBtn.textContent = 'Descargando...';
                    showStatus('Calendario generado. Iniciando descarga...', 'success');
                    await triggerDownload();
                    setTimeout(() => {
                        generateBtn.textContent = originalText;
                        generateBtn.disabled = false;
                    }, 2000);
                } catch (error) {
                    showStatus('Ocurrió un error al generar el archivo.', 'error');
                    console.error(error);
                    generateBtn.textContent = originalText;
                    generateBtn.disabled = false;
                }
            }, 100);
        }

        async function createCalendarWorkbook() {
            fileName = '';
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Calendario TT');
            const monday = new Date(weekSelector.value);
            const monthName = monday.toLocaleString('es-ES', { month: 'long' }).toUpperCase();
            const year = monday.getFullYear();
            const weekDays = Array.from({length: 7}, (_, i) => { const d = new Date(monday); d.setDate(d.getDate() + i); return d; });
            fileName = `Calendario TT semana del ${weekDays[0].getDate()} al ${weekDays[6].getDate()} de ${monthName} ${year}.xlsx`;
            createCalendarSheet(worksheet, weekDays, monthName, year);
            generatedWorkbook = workbook;
        }

        function createCalendarSheet(worksheet, weekDays, monthName, year) {
            worksheet.columns = [ { width: 5 }, { width: 35 }, { width: 12 }, { width: 12 }, { width: 12 }, { width: 12 }, { width: 12 }, { width: 12 }, { width: 12 }, { width: 80 } ];
            let rowIndex = 1;
            const headerFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0B3041' } };
            const headerFont = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri' };
            
            const titleCell = worksheet.getCell(rowIndex, 1);
            titleCell.value = `CALENDARIO TT ${monthName} ${year}`;
            worksheet.mergeCells(rowIndex, 1, rowIndex, 10);
            titleCell.font = { ...headerFont, size: 14 }; titleCell.fill = headerFill; titleCell.alignment = { horizontal: 'center' };
            rowIndex++;

            const subtitleCell = worksheet.getCell(rowIndex, 1);
            subtitleCell.value = `SEMANA ${weekDays[0].getDate()} AL ${weekDays[6].getDate()} ${monthName}`;
            worksheet.mergeCells(rowIndex, 1, rowIndex, 10);
            subtitleCell.font = { ...headerFont, size: 12 }; subtitleCell.fill = headerFill; subtitleCell.alignment = { horizontal: 'center' };
            rowIndex++;
            
            const dayNames = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            const headers = ['N°', 'NOMBRE', ...weekDays.map((day, i) => `${dayNames[i]} ${day.getDate()}`), 'condiciones'];
            const headerRow = worksheet.getRow(rowIndex++);
            headers.forEach((header, index) => {
                const cell = headerRow.getCell(index + 1);
                cell.value = header; cell.fill = headerFill; cell.font = { ...headerFont, size: 11 };
                cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
            });

            let agentNumber = 1;
            const sortedAgents = Array.from(configuredAgents.values()).sort((a,b) => a.nombre.localeCompare(b.nombre));
            
            sortedAgents.forEach((config) => {
                const agentShifts = turnosData.filter(row => {
                    const turnoRut = findVal(row, ['Rut', 'id']);
                    return turnoRut && String(turnoRut).trim() === config.rut;
                });

                if (agentShifts.length > 0) {
                    const agentRow = worksheet.getRow(rowIndex++);
                    agentRow.getCell(1).value = agentNumber++;
                    agentRow.getCell(2).value = config.nombre;
                    
                    weekDays.forEach((day, dayIndex) => {
                        const dayShift = agentShifts.find(s => s.Fecha && normalizeDate(s.Fecha).getTime() === day.getTime());
                        let status = 'LIBRE';
                        if (dayShift && !isLibre(dayShift)) {
                            if (config.modalidad.toLowerCase() === 'especial') {
                                status = applySpecialLogic(dayShift, config.condicion, day);
                            } else {
                                const workingShifts = agentShifts.filter(s => !isLibre(s)).sort((a, b) => new Date(a.Fecha) - new Date(b.Fecha));
                                const shiftPosition = workingShifts.findIndex(s => new Date(s.Fecha).getTime() === day.getTime()) + 1;

                                const otherConditions = config.condicion.filter(c => c !== 'quinto');
                                let sitePositions = otherConditions.map(getDayPosition).filter(p => p > 0);
                                
                                if (config.condicion.includes('quinto')) {
                                    const lastDayPosition = workingShifts.length;
                                    if (lastDayPosition > 0 && !sitePositions.includes(lastDayPosition)) {
                                        sitePositions.push(lastDayPosition);
                                    }
                                }
                                
                                status = sitePositions.includes(shiftPosition) ? 'SITE' : 'TT';
                            }
                        }
                        const cell = agentRow.getCell(3 + dayIndex);
                        cell.value = status;
                        
                        if (status === 'TT') cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD1FAE5' } };
                        else if (status === 'SITE') cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0E7FF' } };

                        calendarResults.set(`${config.nombre}_${day.toDateString()}`, status);
                    });

                    agentRow.getCell(10).value = generateConditionText(config);
                    for (let i = 1; i <= 10; i++) {
                        const cell = agentRow.getCell(i);
                        cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                        cell.font = { name: 'Calibri', size: 11 };
                        cell.alignment = { vertical: 'middle', horizontal: (i > 2 && i < 10) ? 'center' : (i==1 ? 'center' : 'left') };
                    }
                }
            });
        }

        // --- FUNCIONES UTILITARIAS ---
        function excelSerialToDate(serial) { if (typeof serial !== 'number' || serial < 1) return null; const utcDate = new Date((serial - 25569) * 86400 * 1000); return new Date(utcDate.getTime() + (utcDate.getTimezoneOffset() * 60000)); }
        function parseDateTime(value, dateRef) { if (value === null || typeof value !== 'number') return null; if (value > 1) return excelSerialToDate(value); if (value >= 0 && value < 1 && dateRef instanceof Date) { const totalMs = Math.round(value * 24 * 60 * 60 * 1000); const combined = new Date(dateRef); combined.setHours(0,0,0,0); combined.setTime(combined.getTime() + totalMs); return combined; } return null; }
        function normalizeDate(d) { if (!(d instanceof Date)) return null; const date = new Date(d); date.setHours(0, 0, 0, 0); return date; }
        const findKey = (o, names) => { if (!o || !names) return null; const norm = s => String(s).replace(/[\s_]+/g,'').toLowerCase(); const keys = Object.keys(o); const wanted = new Set(names.map(n => norm(n))); return keys.find(k => wanted.has(norm(k))); };
        const findVal = (o, names) => { const key = findKey(o, names); return key ? o[key] : undefined; };
        function getMonday(d) { d = new Date(d); const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1); const monday = new Date(d.setDate(diff)); monday.setHours(0, 0, 0, 0); return monday; }
        
        function isLibre(row) {
            if (!row) return true;
            const ini = findVal(row, ['ini', 'Ini', 'INICIO TURNO']);
            const fin = findVal(row, ['fin', 'Fin', 'FIN DEL TURNO']);
            
            const iniStr = (typeof ini === 'string') ? ini.trim().toUpperCase() : '';
            const finStr = (typeof fin === 'string') ? fin.trim().toUpperCase() : '';
            if (iniStr.includes('LIBRE') || finStr.includes('LIBRE')) return true;
            
            const iniInvalid = !(ini instanceof Date);
            const finInvalid = !(fin instanceof Date);
            return iniInvalid && finInvalid;
        }

        function formatTime(t) { if (!(t instanceof Date)) return ''; return `${String(t.getHours()).padStart(2, '0')}:${String(t.getMinutes()).padStart(2, '0')}`; }
        function applySpecialLogic(shift, conditions, day) {
            const iniValue = findVal(shift, ['ini', 'Ini']);
            if (!(iniValue instanceof Date)) return 'SITE';
            const hour = iniValue.getHours();
            const isWeekendOrFestivo = day.getDay() === 0 || day.getDay() === 6 || checkIfFestivo(day);
            let shiftType = (hour < 7) ? 'noche' : (hour < 12) ? 'am' : 'pm';
            if (isWeekendOrFestivo) {
                if (conditions.includes('weekend_festivos_tt')) return 'TT';
                if (conditions.includes('weekend_festivos_site')) return 'SITE';
            }
            if (conditions.includes(`${shiftType}_tt`)) return 'TT';
            if (conditions.includes(`${shiftType}_site`)) return 'SITE';
            return 'SITE'; // Default
        }
        function checkIfFestivo(day) { const festivos = ['2025-01-01','2025-04-18','2025-04-19','2025-05-01','2025-05-21','2025-06-29','2025-07-16','2025-08-15','2025-09-18','2025-09-19','2025-10-12','2025-11-01','2025-12-08','2025-12-25']; return festivos.includes(day.toISOString().split('T')[0]); }
        function generateConditionText(config) {
            if (config.modalidad.toLowerCase() === 'especial') {
                const format = (type) => config.condicion.filter(c => c.endsWith(type)).map(c => c.split('_')[0].replace('weekendfestivos', 'FDS/Fest.').toUpperCase()).join(', ');
                const tt = format('_tt'), site = format('_site');
                let result = 'Especial: ';
                if (tt) result += `${tt} TT`; if(tt && site) result += ' | '; if(site) result += `${site} SITE`;
                return result;
            } else {
                return `Distribución ${config.modalidad.toUpperCase()} (${config.condicion.map(p=>p.slice(0,3).toUpperCase()).join(', ')})`;
            }
        }
        function getDayPosition(dayName) { const p = { 'primer': 1, 'segundo': 2, 'tercer': 3, 'cuarto': 4, 'quinto': 5 }; return p[dayName] || 0; }
        async function triggerDownload() { if (!generatedWorkbook || !fileName) return; const buffer = await generatedWorkbook.xlsx.writeBuffer(); const blob = new Blob([buffer], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fileName; a.click(); URL.revokeObjectURL(url); }
        function showStatus(message, type) { statusMessage.className = `status-message ${type}`; statusMessage.textContent = message; setTimeout(() => { statusMessage.className = 'status-message'; }, 4000); }
        
        loadInitialData();
    });
</script>
</body>
</html>
