<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Cartas Corporativas</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #f4f7fe;
            --color-surface: #ffffff;
            --color-primary-start: #6a11cb;
            --color-primary-end: #2575fc;
            --color-success-start: #16a34a;
            --color-success-end: #15803d;
            --color-text: #1e293b;
            --color-text-secondary: #64748b;
            --color-border: #e2e8f0;
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            --font-family: 'Manrope', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family); background-color: var(--color-bg); min-height: 100vh;
            display: flex; justify-content: center; align-items: center; padding: 20px;
            color: var(--color-text); position: relative; overflow: hidden;
        }
        .main-container {
            display: grid; grid-template-columns: 1fr; max-width: 1000px; width: 100%;
            background: var(--color-surface); border-radius: 24px; box-shadow: var(--shadow-lg);
            border: 1px solid white; overflow: hidden; z-index: 10;
        }
        @media (min-width: 800px) { .main-container { grid-template-columns: 40% 60%; } }
        .illustration-panel {
            background: linear-gradient(160deg, #f0f5ff, #e6efff); padding: 40px;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        /* Nueva animaci√≥n de Documento Word */
        .doc-animation {
            width: 200px;
            height: 220px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.2);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transform: perspective(800px) rotateX(10deg) rotateY(-20deg);
            border-top: 25px solid #2b579a; /* Barra azul de Word */
        }
        .doc-line {
            height: 8px;
            background-color: #eef2f9;
            border-radius: 4px;
            opacity: 0;
            animation: writeLine 6s ease-out infinite;
        }
        .doc-line.short { width: 60%; }
        .doc-line.medium { width: 85%; }
        .doc-line.long { width: 100%; }

        /* Keyframes para la animaci√≥n de escritura */
        @keyframes writeLine {
            0% { width: 0%; opacity: 1; }
            80% { width: var(--final-width, 100%); opacity: 1; }
            100% { width: var(--final-width, 100%); opacity: 1; }
        }
        
        .doc-line:nth-child(1) { --final-width: 90%; animation-delay: 0s; }
        .doc-line:nth-child(2) { --final-width: 100%; animation-delay: 0.5s; }
        .doc-line:nth-child(3) { --final-width: 60%; animation-delay: 1s; }
        .doc-line:nth-child(4) { --final-width: 80%; animation-delay: 1.5s; }
        .doc-line:nth-child(5) { --final-width: 95%; animation-delay: 2s; }
        .doc-line:nth-child(6) { --final-width: 70%; animation-delay: 2.5s; }

        .illustration-panel h2 { margin-top: 20px; font-size: 22px; color: var(--color-text); }
        .illustration-panel p { margin-top: 8px; font-size: 15px; color: var(--color-text-secondary); max-width: 300px; line-height: 1.6; }
        .content-panel { padding: 40px; }
        .header { text-align: center; margin-bottom: 30px; }
        h1 { color: var(--color-text); font-size: 28px; font-weight: 700; }
        .upload-area {
            border: 2px dashed var(--color-border); border-radius: 12px; padding: 40px 20px;
            text-align: center; transition: all 0.3s ease; cursor: pointer; background-color: #fafbff;
        }
        .upload-area:hover, .upload-area.dragover { border-color: var(--color-primary-end); background: #f7faff; transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(37, 117, 252, 0.1); }
        .upload-icon { width: 48px; height: 48px; margin: 0 auto 15px; background: linear-gradient(45deg, var(--color-primary-start), var(--color-primary-end)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease; }
        .upload-area:hover .upload-icon { transform: scale(1.1) rotate(10deg); }
        .upload-text { color: var(--color-text); font-size: 16px; font-weight: 600; }
        input[type="file"] { display: none; }
        .button { background-image: linear-gradient(45deg, var(--color-primary-start) 0%, var(--color-primary-end) 100%); color: white; border: none; padding: 14px 35px; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 10px; width: 100%; justify-content: center; margin-top: 15px; }
        .button:hover { transform: translateY(-3px); box-shadow: 0 7px 20px rgba(106, 17, 203, 0.3); }
        .button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .status { margin-top: 20px; padding: 15px; border-radius: 10px; text-align: center; font-weight: 500; display: none; animation: slideDown 0.5s; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status.success { background: #e6f7f0; color: #0d8a54; display: block; }
        .status.error { background: #fdeaea; color: #d92d20; display: block; }
        .status.warning { background: #fffbeb; color: #b45309; display: block; }
        .hidden { display: none; }
        .date-filter-container { background-color: #f8faff; border-radius: 12px; padding: 20px; margin-top: 25px; border: 1px solid var(--color-border); }
        .date-filter-container h3 { text-align: center; margin-bottom: 25px; color: var(--color-text); font-weight: 600; font-size: 18px; }
        .slider-labels { display: flex; justify-content: space-between; margin-top: 10px; font-weight: 600; color: var(--color-text-secondary); font-size: 14px; }
        #date-slider { margin: 25px 10px 15px; }
        /* Estilos para noUiSlider */
        #date-slider .noUi-connect { background: linear-gradient(45deg, var(--color-primary-start), var(--color-primary-end)); }
        #date-slider .noUi-handle { border: 3px solid var(--color-surface); border-radius: 50%; width: 24px; height: 24px; right: -12px; top: -9px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); cursor: pointer; }
        #date-slider .noUi-handle:focus { outline: none; }
        #date-slider .noUi-handle::before, #date-slider .noUi-handle::after { display: none; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="illustration-panel">
            <div class="doc-animation">
                <div class="doc-line"></div>
                <div class="doc-line"></div>
                <div class="doc-line"></div>
                <div class="doc-line"></div>
                <div class="doc-line"></div>
                <div class="doc-line"></div>
            </div>
            <h2>Gu√≠a R√°pida</h2>
            <p>Sube tu archivo Excel con las incidencias, filtra por fecha si es necesario, y genera las cartas de amonestaci√≥n o compromiso en segundos.</p>
        </div>

        <div class="content-panel">
            <div class="header">
                <h1>üè¢ Generador de Cartas</h1>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                <div class="upload-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                </div>
                <div id="uploadText" class="upload-text">Haz clic o arrastra tu archivo Excel</div>
            </div>

            <div class="date-filter-container hidden" id="dateFilterContainer">
                <h3>üìÖ Filtrar por Fecha de Incidencia</h3>
                <div id="date-slider"></div>
                <div class="slider-labels">
                    <span id="slider-start-date"></span>
                    <span id="slider-end-date"></span>
                </div>
            </div>
    
            <button class="button hidden" id="generateBtn">
                <span id="btnText">üöÄ Generar Cartas</span>
            </button>
            
            <div class="status" id="status"></div>
        </div>
    </div>

    <script>
        let fullProcessedData = []; 
        let processedData = []; 
        let dateSlider = null;

        const COLUMN_MAPPING = {
            nombres: ['nombre', 'nombres', 'agente', 'agentes', 'trabajador'],
            rut: ['rut', 'cedula', 'c√©dula', 'ci'],
            fecha: ['fecha', 'date', 'fecha_incidencia'],
            duracion: ['duracion', 'duraci√≥n', 'minutos'],
            inicioTurno: ['inicio turno', 'inicio_turno', 'turno', 'hora inicio'],
            finTurno: ['fin turno', 'fin_turno', 'termino turno', 'hora fin'],
            incidencia: ['incidencia'],
            tipoCarta: ['tipo de carta', 'tipo carta']
        };

        const elements = {
            uploadArea: document.getElementById('uploadArea'),
            fileInput: document.getElementById('fileInput'),
            dateFilterContainer: document.getElementById('dateFilterContainer'),
            dateSlider: document.getElementById('date-slider'),
            sliderStartDate: document.getElementById('slider-start-date'),
            sliderEndDate: document.getElementById('slider-end-date'),
            generateBtn: document.getElementById('generateBtn'),
            btnText: document.getElementById('btnText'),
            status: document.getElementById('status')
        };

        elements.uploadArea.addEventListener('click', () => elements.fileInput.click());
        elements.fileInput.addEventListener('change', handleFileSelect);
        elements.generateBtn.addEventListener('click', generateDocuments);
        
        // Soporte para Drag & Drop
        elements.uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); elements.uploadArea.classList.add('dragover'); });
        elements.uploadArea.addEventListener('dragleave', () => { elements.uploadArea.classList.remove('dragover'); });
        elements.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                elements.fileInput.files = e.dataTransfer.files;
                handleFileSelect({ target: elements.fileInput });
            }
        });

        function showStatus(message, type = 'success') {
            elements.status.className = `status ${type}`;
            elements.status.textContent = message;
            elements.status.style.display = 'block';
        }

        function handleFileSelect(event) {
            fullProcessedData = [];
            processedData = [];
            if(dateSlider) { dateSlider.destroy(); dateSlider = null; }
            elements.dateFilterContainer.classList.add('hidden');
            elements.generateBtn.classList.add('hidden');
            
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('uploadText').textContent = file.name;
            showStatus('Procesando archivo...', 'warning');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: null });
                    processData(rawData);
                } catch (error) {
                    console.error("Error detallado:", error);
                    showStatus('Error al leer el archivo. Verifique que el formato sea correcto.', 'error');
                }
            };
            reader.readAsBinaryString(file);
        }
        
        function parseDate(dateValue) {
            if (!dateValue) return null;
            if (dateValue instanceof Date && !isNaN(dateValue)) return dateValue;
            if (typeof dateValue === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                return new Date(excelEpoch.getTime() + dateValue * 86400000);
            }
            if (typeof dateValue === 'string') {
                let date = new Date(dateValue);
                if (!isNaN(date)) return date;
                if (dateValue.includes('/')) {
                    const parts = dateValue.split('/');
                    if (parts.length === 3) {
                        date = new Date(parts[2], parts[1] - 1, parts[0]);
                        if (!isNaN(date)) return date;
                    }
                }
            }
            return null;
        }

        function formatShiftTime(value) {
            if (value instanceof Date && !isNaN(value)) {
                const hours = value.getHours().toString().padStart(2, '0');
                const minutes = value.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            }
            return value;
        }

        function toProperCase(str) {
            if (!str) return '';
            return str.toString().toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
        
        function processData(data) {
            if (!data || data.length === 0) {
                showStatus('El archivo est√° vac√≠o o no tiene un formato v√°lido.', 'error'); return;
            }
            const headers = Object.keys(data[0]);
            const columnMap = {};
            
            const missingCols = Object.keys(COLUMN_MAPPING).filter(key => {
                const foundHeader = headers.find(h => COLUMN_MAPPING[key].some(alias => h.toLowerCase().includes(alias)));
                if(foundHeader) columnMap[key] = foundHeader;
                return !foundHeader;
            });

            if (missingCols.length > 0) {
                showStatus(`Error: Faltan las siguientes columnas en el archivo: ${missingCols.join(', ')}.`, 'error'); return;
            }

            const allData = data.map(row => ({
                nombres: row[columnMap.nombres] || '',
                rut: row[columnMap.rut] || '',
                fecha: parseDate(row[columnMap.fecha]),
                duracion: row[columnMap.duracion] || '',
                inicioTurno: formatShiftTime(row[columnMap.inicioTurno]) || '00:00',
                finTurno: formatShiftTime(row[columnMap.finTurno]) || '00:00',
                incidencia: (row[columnMap.incidencia] || '').toString().toLowerCase().trim(),
                tipoCarta: (row[columnMap.tipoCarta] || '').toString().toLowerCase().trim()
            })).filter(row => row.nombres && row.rut && row.fecha);

            fullProcessedData = allData.filter(row => {
                const esAtraso = (row.incidencia === 'atraso' || row.incidencia === 'atrasos') && ['amonestacion', 'amonestaci√≥n', 'compromiso'].includes(row.tipoCarta);
                const esAusencia = (row.incidencia === 'ausencia') && ['amonestacion', 'amonestaci√≥n', 'compromiso'].includes(row.tipoCarta);
                const esAbandono = (row.incidencia === 'abandono de trabajo') && ['amonestacion', 'amonestaci√≥n', 'compromiso'].includes(row.tipoCarta);
                return esAtraso || esAusencia || esAbandono;
            });
            
            if (fullProcessedData.length === 0) {
                showStatus('No se encontraron registros que cumplan con los criterios definidos.', 'error'); return;
            }
            
            const uniqueTimestamps = [...new Set(fullProcessedData.map(d => new Date(d.fecha).setHours(0, 0, 0, 0)))].sort((a, b) => a - b);
            
            if (uniqueTimestamps.length < 2) {
                processedData = [...fullProcessedData];
                elements.dateFilterContainer.classList.add('hidden');
                showResults();
            } else {
                setupAndShowDateFilter(uniqueTimestamps);
            }
        }

        function setupAndShowDateFilter(uniqueTimestamps) {
            const minTimestamp = uniqueTimestamps[0];
            const maxTimestamp = uniqueTimestamps[uniqueTimestamps.length - 1];
            if (dateSlider) dateSlider.destroy();
            dateSlider = noUiSlider.create(elements.dateSlider, {
                start: [minTimestamp, maxTimestamp], connect: true,
                range: { min: minTimestamp, max: maxTimestamp }, step: 24 * 60 * 60 * 1000,
            });
            const formatDateForDisplay = (ts) => new Date(parseInt(ts)).toLocaleDateString('es-CL', { timeZone: 'UTC' });
            dateSlider.on('slide', (values) => { applyFiltersAndShowResults(values.map(v => parseInt(v))); });
            dateSlider.on('update', (values) => {
                 elements.sliderStartDate.textContent = formatDateForDisplay(values[0]);
                 elements.sliderEndDate.textContent = formatDateForDisplay(values[1]);
            });
            elements.dateFilterContainer.classList.remove('hidden');
            applyFiltersAndShowResults(dateSlider.get(true));
        }

        function applyFiltersAndShowResults(values) {
            const [startTimestamp, endTimestamp] = values;
            processedData = fullProcessedData.filter(row => {
                const rowTimestamp = new Date(row.fecha).setHours(0,0,0,0);
                return rowTimestamp >= startTimestamp && rowTimestamp <= endTimestamp;
            });
            showResults();
        }

        function groupData(data) {
            const grouped = {};
            data.forEach(row => {
                const key = `${row.rut}-${row.incidencia}-${row.tipoCarta}`;
                if (!grouped[key]) {
                    grouped[key] = [];
                }
                grouped[key].push(row);
            });
            return Object.values(grouped);
        }

        function showResults() {
            const groupedData = groupData(processedData);
            const letterCount = groupedData.length;

            if (letterCount > 0) {
                elements.generateBtn.classList.remove('hidden');
                elements.btnText.textContent = `üöÄ Generar ${letterCount} Cartas`;
                showStatus(`${processedData.length} registros encontrados (se generar√°n ${letterCount} cartas).`, 'success');
            } else {
                elements.generateBtn.classList.add('hidden');
                showStatus('No se encontraron registros en el rango de fechas seleccionado.', 'warning');
            }
        }
        
        function createWordDocument(incidentGroup) {
            const data = incidentGroup[0];
            const isPlural = incidentGroup.length > 1;

            const today = new Date().toLocaleDateString('es-CL', { day: '2-digit', month: 'long', year: 'numeric' });
            const headerHtml = `<div style='font-family: Calibri, sans-serif; color: #1f4e9b; font-weight: bold; font-size: 18pt;'>Konecta</div><div style='font-family: Calibri, sans-serif; font-size: 10pt; line-height: 1.2;'><b>KALLPLAT CHILE LIMITADA</b><br>RUT: 76.071.717-7<br>Giro: Actividades de Call Center<br>Calle Rodrigo de Araya N¬∫ 1045, Macul. Santiago.</div>`;
            
            let bodyHtml;
            const esCompromiso = data.tipoCarta === 'compromiso';

            if (data.incidencia.includes('abandono')) {
                const titulo = esCompromiso ? 'Carta de Compromiso' : 'Carta de Amonestaci√≥n';
                const parrafoInspeccion = esCompromiso ? '' : ' De acuerdo a lo anterior, esta amonestaci√≥n ser√° informada a la Inspecci√≥n del Trabajo y quedar√° una copia en su carpeta personal.';
                const textoCC = esCompromiso ? 'CC. Carpeta personal' : 'CC. Carpeta personal<br>Inspecci√≥n del Trabajo';
                
                const datesString = incidentGroup.map(d => d.fecha.toLocaleDateString('es-CL', { day: '2-digit', month: 'long', timeZone: 'UTC' }).replace('-', ' de ')).join(', ');
                const dayText = isPlural ? `los d√≠as ${datesString}` : `el d√≠a ${datesString}`;
                const shiftText = isPlural 
                    ? `durante sus jornadas de trabajo` 
                    : `durante su jornada de trabajo desde las ${data.inicioTurno} a ${data.finTurno} horas`;

                const page1 = `<table style='width: 100%; border-collapse: collapse;'>
                                <tr><td style='padding-bottom: 10px;'>${headerHtml}</td></tr>
                                <tr>
                                    <td>
                                        <p style='text-align: right; padding-top:20px;'>Osorno, ${today}</p>
                                        <p style='text-align: center; font-weight: bold; text-decoration: underline; padding-top:30px;'>${titulo}</p>
                                        <br><br>
                                        <p style='margin-bottom: 20px;'><b>Se√±or (a):</b> ${toProperCase(data.nombres)}<br><b>Rut:</b> ${data.rut}</p>
                                        <p style='margin-bottom: 20px;'><b>Presente.</b></p>
                                        <p style='margin-bottom: 20px;'>De mi consideraci√≥n:</p>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Cumplo con informarle a Ud. que es su obligaci√≥n cumplir en forma √≠ntegra su jornada laboral, para poder desempe√±ar en forma correcta las funciones para las que fue contratado, ${dayText}, sin justificaci√≥n alguna y sin autorizaci√≥n de su jefatura directa se ha ausentado ${shiftText} y al ser buscado en plataforma Genesys iCloud no pudo ser ubicada en conexi√≥n desde su modalidad de teletrabajo.</p>
                                    </td>
                                </tr>
                            </table>`;
                
                const page2 = `<table style='width: 100%; border-collapse: collapse;'>
                                <tr><td style='padding-bottom: 10px;'>${headerHtml}</td></tr>
                                <tr>
                                    <td style='padding-top: 20px;'>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Le recordamos que debe respetar la letra A) del Reglamento Interno de Orden Higiene y Seguridad que en el apartado referido a las Prohibiciones en el Titulo XV en su art√≠culo 87, indica ‚Ä¶‚Äù Abandonar el trabajo o ausentarse intempestivamente del recinto en que √©ste se desarrolla durante la jornada laboral sin justificaci√≥n y/o autorizaci√≥n.</p>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>En atenci√≥n a lo se√±alado con anterioridad se le solicita encarecidamente, que tome las medidas pertinentes para solucionar estas dificultades que entorpecen el normal funcionamiento de nuestra empresa, a fin de evitar sanciones posteriores.${parrafoInspeccion}</p>
                                        <p style='margin-top: 30px;'>Sin otro particular,</p>
                                        <p style='margin-top: 10px; margin-bottom: 80px;'>Le saluda atentamente,</p>
                                        <table style="width:100%;"><tr><td style="text-align:left; vertical-align:bottom;"><b>Jefe de Servicios</b></td><td style="text-align:right; vertical-align:bottom;"><b>Nombre:</b> ${toProperCase(data.nombres)}<br><b>Rut:</b> ${data.rut}</td></tr></table>
                                        <div style='margin-top: 50px; font-weight: bold;'>${textoCC}</div>
                                    </td>
                                </tr>
                               </table>`;
                bodyHtml = `${page1}<br clear=all style='mso-special-character:line-break; page-break-before:always'>${page2}`;

            } else if (data.incidencia.includes('ausencia')) {
                const titulo = esCompromiso ? 'Carta de Compromiso' : 'Carta de Amonestaci√≥n';
                const parrafoInspeccion = esCompromiso ? '' : ' De acuerdo con lo anterior, esta amonestaci√≥n ser√° informada a la Inspecci√≥n del Trabajo y quedar√° una copia en su carpeta personal.';
                const textoCC = esCompromiso ? 'CC. Carpeta personal' : 'CC. Carpeta personal<br>Inspecci√≥n del Trabajo';

                let incidentDetails;
                if (isPlural) {
                    const datesString = incidentGroup.map(d => d.fecha.toLocaleDateString('es-CL', { day: '2-digit', month: 'long', timeZone: 'UTC' }).replace('-', ' de ')).join(', ');
                    const shiftsString = incidentGroup.map(d => `turno de ${d.inicioTurno} a ${d.finTurno} horas`).join(', ');
                    incidentDetails = `los d√≠as en que ha dejado de prestar sus funciones injustificadamente ${datesString} en sus respectivos turnos (${shiftsString})`;
                } else {
                    const incidentDate = data.fecha.toLocaleDateString('es-CL', { day: '2-digit', month: 'long', timeZone: 'UTC' }).replace('-', ' de ');
                    incidentDetails = `el d√≠a en que ha dejado de prestar sus funciones injustificadamente ${incidentDate} en su turno programado de ${data.inicioTurno} a ${data.finTurno} horas.`;
                }

                const page1 = `<table style='width: 100%; border-collapse: collapse;'>
                                <tr><td style='padding-bottom: 10px;'>${headerHtml}</td></tr>
                                <tr>
                                    <td>
                                        <p style='text-align: right; padding-top:20px;'>Osorno, ${today}</p>
                                        <p style='text-align: center; text-decoration: underline; font-weight:bold; padding-top:30px;'>${titulo}</p>
                                        <br><br>
                                        <p><b>Se√±or(a):</b> ${toProperCase(data.nombres)}</p>
                                        <p><b>RUT:</b> ${data.rut}</p>
                                        <p style='font-weight: bold; margin-bottom: 20px;'>Presente</p>
                                        <p style='margin-bottom: 20px;'>De nuestra consideraci√≥n:</p>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Cumplo con informarle a Ud. que, seg√∫n lo dispuesto en su contrato individual de trabajo, usted debe entregar una atenci√≥n de calidad al momento de realizar las atenciones.</p>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Le recordamos que debe respetar la Cl√°usula Primera y Cuarta de su Contrato Individual de trabajo... ${incidentDetails}, debe cumplir con lo establecido en el Reglamento Interno...</p>
                                    </td>
                                </tr>
                            </table>`;
                const page2 = `<table style='width: 100%; border-collapse: collapse;'>
                                <tr><td style='padding-bottom: 10px;'>${headerHtml}</td></tr>
                                <tr>
                                    <td style='padding-top: 20px;'>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Con el objeto de que Ud. se comprometa a no presentar Alguna Ausencia y Cumplir con su Turno, se efect√∫a esta carta de Amonestaci√≥n.</p>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>En atenci√≥n a los puntos se√±alados con anterioridad se le solicita encarecidamente, que tome las medidas pertinentes para solucionar estas dificultades que entorpecen el normal funcionamiento de sus deberes laborales en nuestra empresa, a fin de evitar sanciones posteriores.${parrafoInspeccion}</p>
                                        <p style='margin-top: 30px;'>Sin otro particular, le saluda atentamente,</p>
                                        <br><br><br><br>
                                        <table style="width:100%;"><tr><td style="text-align:left; vertical-align:bottom;"><b>Jefe de Servicio</b><br>Konecta Chile Limitada.</td><td style="text-align:right; vertical-align:bottom;"><b>Nombre del Trabajador:</b> ${toProperCase(data.nombres)}<br>${data.rut}</td></tr></table>
                                        <div style='margin-top: 50px; font-weight: bold;'>${textoCC}</div>
                                    </td>
                                </tr>
                               </table>`;
                bodyHtml = `${page1}<br clear=all style='mso-special-character:line-break; page-break-before:always'>${page2}`;

            } else { // L√≥gica para cartas de Atraso
                const titulo = esCompromiso ? 'Carta de Compromiso' : 'Carta de Amonestaci√≥n';
                const parrafoInspeccion = esCompromiso ? '' : ' De acuerdo con lo anterior, esta amonestaci√≥n ser√° informada a la Inspecci√≥n del Trabajo y quedar√° una copia en su carpeta personal.';
                const textoCC = esCompromiso ? 'CC. Carpeta personal' : 'CC. Carpeta personal<br>Inspecci√≥n del Trabajo';
                
                let parrafoPrincipal;
                if (isPlural) {
                    const incidentsHtml = incidentGroup.map(incident => {
                        const incidentDate = incident.fecha.toLocaleDateString('es-CL', { day: '2-digit', month: 'long', timeZone: 'UTC' }).replace('-', ' de ');
                        const duracionTexto = incident.duracion ? `de una duraci√≥n de ${incident.duracion} minutos ` : ``;
                        return `El d√≠a ${incidentDate}, presenta un atraso injustificado, ${duracionTexto}ya que su turno programado para ese d√≠a era a partir de las ${incident.inicioTurno} horas.`;
                    }).join('<br>');

                    parrafoPrincipal = `<p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>${incidentsHtml}</p>
                                      <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Al presentar estos atrasos en su hora de ingreso, perjudica el normal funcionamiento de la plataforma, que necesita contar con una cantidad de ejecutivos disponibles para atender en el horario en que su turno fue programado, perjudicando gravemente los niveles de servicio de la compa√±√≠a y la calidad de atenci√≥n a nuestros clientes.</p>`;
                } else {
                    const incidentDate = data.fecha.toLocaleDateString('es-CL', { day: '2-digit', month: 'long', timeZone: 'UTC' }).replace('-', ' de ');
                    const duracionTexto = data.duracion ? `de una duraci√≥n de ${data.duracion} minutos ` : `de una duraci√≥n de AGREGAR `;
                    parrafoPrincipal = `<p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>El d√≠a ${incidentDate}, presenta un atraso injustificado, ${duracionTexto}ya que su turno programado para ese d√≠a era a partir de las ${data.inicioTurno} horas, al presentar este atraso en su hora de ingreso, perjudica el normal funcionamiento de la plataforma, que necesita contar con una cantidad de ejecutivos disponibles para atender en el horario en que su turno fue programado, perjudicando gravemente los niveles de servicio de la compa√±√≠a y la calidad de atenci√≥n a nuestros clientes.</p>`;
                }
                
                const parrafoReglamento = `<p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Le recordamos que debe respetar la <b>letra b)</b> del Reglamento Interno de Orden Higiene y Seguridad que en el apartado referido a las prohibiciones en el Titulo XV en su art√≠culo 87, indica ‚Ä¶‚Äù llegar atrasado o registrar en forma reiterada, atrasos en su hora de ingreso‚Ä¶‚Äù. En atenci√≥n a lo se√±alado con anterioridad se le solicita encarecidamente, que tome las medidas pertinentes para solucionar estas dificultades que entorpecen el normal funcionamiento de nuestra empresa, a fin de evitar sanciones posteriores.${parrafoInspeccion}</p>`;
                
                const page1 = `<table style='width: 100%; border-collapse: collapse;'>
                                <tr><td style='padding-bottom: 10px;'>${headerHtml}</td></tr>
                                <tr>
                                    <td>
                                        <p style='text-align: right; padding-top:20px;'>Osorno, ${today}</p>
                                        <p style='text-align: center; font-weight: bold; text-decoration: underline; padding-top:30px;'>${titulo}</p>
                                        <br><br>
                                        <p style='margin-bottom: 20px;'><b>Se√±or (a):</b> ${toProperCase(data.nombres)}<br><b>Rut:</b> ${data.rut}</p>
                                        <p style='margin-bottom: 20px;'><b>Presente.</b></p>
                                        <p style='margin-bottom: 20px;'>De mi consideraci√≥n:</p>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Cumplo con informarle a Ud. que es su obligaci√≥n cumplir en forma √≠ntegra su jornada laboral.</p>
                                        ${parrafoPrincipal}
                                    </td>
                                </tr>
                            </table>`;
                const page2 = `<table style='width: 100%; border-collapse: collapse;'>
                                <tr><td style='padding-bottom: 10px;'>${headerHtml}</td></tr>
                                <tr><td style='padding-top: 20px;'>${parrafoReglamento}<p style='margin-top: 30px;'>Sin otro particular,</p><p style='margin-top: 10px; margin-bottom: 80px;'>Le saluda atentamente,</p><table style="width:100%;"><tr><td style="text-align:left; vertical-align:bottom;"><b>Jefe de Servicios</b></td><td style="text-align:right; vertical-align:bottom;"><b>Nombre:</b> ${toProperCase(data.nombres)}<br><b>Rut:</b> ${data.rut}</td></tr></table><div style='margin-top: 50px; font-weight: bold;'>${textoCC}</div></td></tr>
                            </table>`;
                bodyHtml = `${page1}<br clear=all style='mso-special-character:line-break; page-break-before:always'>${page2}`;
            }
            
            return `<html xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head><meta charset='utf-8'><title>Carta Generada</title></head>
                <body style='font-family: Calibri, sans-serif; font-size: 11pt;'>${bodyHtml}</body>
                </html>`;
        }

        async function generateDocuments() {
            elements.generateBtn.disabled = true;
            elements.btnText.textContent = '‚è≥ Generando...';
            
            try {
                const zip = new JSZip();
                const groupedData = groupData(processedData);

                for (const incidentGroup of groupedData) {
                    const firstIncident = incidentGroup[0];
                    const htmlContent = createWordDocument(incidentGroup);
                    const blob = new Blob(['\ufeff', htmlContent], { type: 'application/msword' });
                    
                    let nombreBase;
                    if (firstIncident.incidencia.includes('abandono')) {
                        const tipo = firstIncident.tipoCarta === 'compromiso' ? 'Compromiso' : 'Amonestacion';
                        nombreBase = `${tipo}_Abandono_Trabajo`;
                    } else if (firstIncident.incidencia.includes('ausencia')) {
                        const tipo = firstIncident.tipoCarta === 'compromiso' ? 'Compromiso' : 'Amonestacion';
                        nombreBase = `${tipo}_Ausencia`;
                    } else {
                        const tipo = firstIncident.tipoCarta === 'compromiso' ? 'Compromiso' : 'Amonestacion';
                        nombreBase = `${tipo}_Atrasos`;
                    }
                    const cleanName = firstIncident.nombres.replace(/[^\w\s-]/g, '').trim().replace(/\s+/g, '_');
                    const fileName = `${nombreBase}_${firstIncident.rut}_${cleanName}.doc`;

                    zip.file(fileName, blob);
                    await new Promise(r => setTimeout(r, 10));
                }

                if (groupedData.length > 0) {
                    const today = new Date();
                    const day = String(today.getDate()).padStart(2, '0');
                    const month = String(today.getMonth() + 1).padStart(2, '0'); // Enero es 0
                    const year = today.getFullYear();
                    const formattedDate = `${day}-${month}-${year}`;
                    const zipFileName = `Cartas del ${formattedDate}.zip`;

                    const zipBlob = await zip.generateAsync({ type: 'blob' });
                    saveAs(zipBlob, zipFileName);
                    showStatus(`¬°√âxito! Se generaron ${groupedData.length} cartas.`, 'success');
                }
            } catch (error) {
                console.error("Error al generar documentos:", error);
                showStatus('Ocurri√≥ un error al generar el archivo ZIP.', 'error');
            } finally {
                elements.generateBtn.disabled = false;
                const letterCount = groupData(processedData).length;
                if (letterCount > 0) {
                   elements.btnText.textContent = `üöÄ Generar ${letterCount} Cartas`;
                }
            }
        }
    </script>
</body>
</html>
