<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestiones Inbound - Generador de Turnos</title>

  <!-- Librer√≠as -->
  <script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f8fb; margin:0; padding:40px; }
    .card { max-width: 980px; margin:0 auto; background:#fff; border-radius:16px; padding:28px; box-shadow: 0 8px 30px rgba(0,0,0,.08); }
    h1 { margin:0 0 10px; font-size:22px; }
    .muted { color:#6b7280; margin-bottom:18px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    button { background:linear-gradient(45deg,#6a11cb,#2575fc); border:0; color:#fff; padding:12px 16px; border-radius:10px; cursor:pointer; font-weight:600; }
    button.secondary { background:#0ea5e9; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .status { margin-top:16px; padding:10px; border-radius:8px; display:none; }
    .status.info { display:block; background:#e0f2fe; color:#075985; }
    .status.success { display:block; background:#eafbe7; color:#166534; }
    .status.error { display:block; background:#fee2e2; color:#991b1b; }
    select { padding:10px; border:1px solid #e5e7eb; border-radius:10px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Generador de Turnos Diarios Inbound</h1>
    <div class="muted">Conecta con tu Excel Online en OneDrive y genera el archivo por semana.</div>

    <div id="authRow" class="row" style="margin-bottom:12px;">
      <button id="connectBtn">Conectar con Microsoft</button>
      <button id="logoutBtn" class="secondary" style="display:none;">Cerrar sesi√≥n</button>
    </div>

    <div id="connected" style="display:none;">
      <div class="row">
        <label for="weekSelector">Semana:</label>
        <select id="weekSelector"></select>
        <button id="generateBtn" disabled>Generar Excel</button>
        <button id="downloadBtn" class="secondary" style="display:none;">Descargar Excel</button>
      </div>
      <div id="dataInfo" class="muted" style="margin-top:6px;"></div>
    </div>

    <div id="status" class="status"></div>
  </div>

<script>
/* ========= CONFIG MSAL ========= */
// Usa TU tenant (con / final). Si prefieres "common", sustit√∫yelo.
const msalConfig = {
  auth: {
    clientId: "7d5a8e5f-4d3e-45fa-b3de-f634b9c6b0f8",
    authority: "https://login.microsoftonline.com/13bd05ac-5854-49bf-b70c-842244af1a02/",
    redirectUri: "https://TU_USUARIO.github.io/gestor-turnos/" // üëà c√°mbialo por tu URL exacta (mejor con / final)
  },
  cache: {
    cacheLocation: "localStorage",
    storeAuthStateInCookie: false
  }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);

// Scopes m√≠nimos para leer/escribir tu archivo en OneDrive + refresh (PKCE)
const SCOPES = ["Files.ReadWrite", "offline_access"];
const loginRequest = { scopes: SCOPES };

let accessToken = null;
let allData = [], turnosData = [], workbookGenerado = null, fileName = "";

/* ========= UI helpers ========= */
const $ = (id) => document.getElementById(id);
function setStatus(msg, type="info") {
  const st = $("status");
  st.className = "status " + type;
  st.textContent = msg;
  st.style.display = "block";
}
function hideStatus(){ $("status").style.display = "none"; }

/* ========= Autenticaci√≥n ========= */
async function login() {
  try {
    // Si ya hay cuenta, intenta token silencioso
    const acc = msalInstance.getAllAccounts()[0];
    if (!acc) {
      msalInstance.loginRedirect(loginRequest);
      return;
    }
    msalInstance.setActiveAccount(acc);
    await getTokenAndLoad();
  } catch (e) {
    console.error(e);
    setStatus("Error autenticando: " + (e.message || e), "error");
  }
}

async function getTokenAndLoad() {
  try {
    const account = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];
    if (!account) return;
    const tokenResponse = await msalInstance.acquireTokenSilent({ scopes: SCOPES, account });
    accessToken = tokenResponse.accessToken;
    setStatus("‚úÖ Autenticado. Obteniendo datos de Excel...", "success");
    await loadExcelData();
  } catch (e) {
    console.warn("Silent token fall√≥, intento popup...", e);
    try {
      const popupResp = await msalInstance.acquireTokenPopup({ scopes: SCOPES });
      accessToken = popupResp.accessToken;
      setStatus("‚úÖ Autenticado. Obteniendo datos de Excel...", "success");
      await loadExcelData();
    } catch (err) {
      console.error(err);
      setStatus("Error obteniendo token: " + (err.message || err), "error");
    }
  }
}

function logout() {
  const account = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];
  if (!account) return;
  msalInstance.logoutRedirect({ account });
}

/* Manejo del retorno de redirect (despu√©s del login) */
msalInstance.handleRedirectPromise()
  .then(async (response) => {
    if (response?.account) {
      msalInstance.setActiveAccount(response.account);
      await getTokenAndLoad();
    } else {
      // Si ya hab√≠a sesi√≥n en cache, tambi√©n cargamos
      const acc = msalInstance.getAllAccounts()[0];
      if (acc) {
        msalInstance.setActiveAccount(acc);
        await getTokenAndLoad();
      }
    }
  })
  .catch(err => {
    console.error("Redirect error:", err);
    setStatus("Error autenticando: " + (err.message || err), "error");
  });

/* ========= L√≥gica de Excel/Graph ========= */
// Ajusta la ruta a tu archivo y nombre de tabla:
const FILE_PATH = "Documents/INBOUND/Dimensionamientos/Turnos_dimensionamiento.xlsx";
const TABLE_NAME = "Turnos";

async function loadExcelData() {
  try {
    setStatus("Consultando Microsoft Graph...", "info");

    const url = `https://graph.microsoft.com/v1.0/me/drive/root:/${encodeURIComponent(FILE_PATH)}:/workbook/tables/${encodeURIComponent(TABLE_NAME)}/rows`;
    const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(`Graph devolvi√≥ ${res.status}: ${text}`);
    }

    const json = await res.json();
    console.log("üìä Graph rows:", json);

    allData = parseGraphRows(json.value);
    $("connected").style.display = "block";
    $("dataInfo").textContent = `Datos cargados: ${allData.length} registros`;
    populateWeekSelector(allData);
    hideStatus();
  } catch (e) {
    console.error(e);
    setStatus("Error cargando Excel: " + (e.message || e), "error");
  }
}

function parseGraphRows(rows) {
  if (!rows || rows.length === 0) return [];
  // Primer row como encabezado
  const headers = rows[0].values[0];
  return rows.slice(1).map(r => {
    const obj = {};
    headers.forEach((h, i) => { obj[h] = r.values[0][i]; });
    return obj;
  });
}

/* ========= Semanas y generaci√≥n ========= */
function mondayOf(date) {
  const d = new Date(date);
  const day = d.getDay(); // 0 dom, 1 lun...
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  const m = new Date(d.setDate(diff));
  m.setHours(0,0,0,0);
  return m;
}

function populateWeekSelector(data) {
  const set = new Set();
  data.forEach(r => { if (r.Fecha) set.add(mondayOf(r.Fecha).toISOString()); });
  const sorted = Array.from(set).sort((a,b) => new Date(b) - new Date(a));
  const sel = $("weekSelector");
  sel.innerHTML = "";
  sorted.forEach(mISO => {
    const m = new Date(mISO);
    const s = new Date(m); s.setDate(m.getDate()+6);
    const opt = document.createElement("option");
    opt.value = mISO;
    opt.textContent = `Semana ${m.getDate()}‚Äì${s.getDate()} ${s.toLocaleString('es-ES',{month:'long'})} ${s.getFullYear()}`;
    sel.appendChild(opt);
  });
  $("generateBtn").disabled = sorted.length === 0;
}

$("weekSelector").addEventListener("change", onWeekChange);
function onWeekChange() {
  const monday = new Date($("weekSelector").value);
  const nextMonday = new Date(monday); nextMonday.setDate(monday.getDate()+7);
  turnosData = allData.filter(r => {
    const d = new Date(r.Fecha);
    return d >= monday && d < nextMonday;
  });
}

$("generateBtn").addEventListener("click", async () => {
  if (!$("weekSelector").value) { setStatus("Selecciona una semana.", "error"); return; }
  onWeekChange();
  if (turnosData.length === 0) { setStatus("No hay datos para esa semana.", "error"); return; }

  const wb = new ExcelJS.Workbook();
  const ws = wb.addWorksheet("Turnos");
  ws.addRow(Object.keys(turnosData[0]));
  turnosData.forEach(r => ws.addRow(Object.values(r)));

  workbookGenerado = wb;
  fileName = "Turnos.xlsx";
  $("downloadBtn").style.display = "inline-block";
  setStatus("Excel generado ‚úÖ", "success");
});

$("downloadBtn").addEventListener("click", async () => {
  if (!workbookGenerado) return;
  const buf = await workbookGenerado.xlsx.writeBuffer();
  const blob = new Blob([buf], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(url);
});

/* ========= Botones ========= */
$("connectBtn").addEventListener("click", login);
$("logoutBtn").addEventListener("click", logout);
</script>
</body>
</html>
