<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestor Operativo ‚Äî Final Integrado</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-bg: #f4f7fe;
      --color-surface: #ffffff;
      --color-primary-start: #6a11cb;
      --color-primary-end: #2575fc;
      --color-disabled: #cbd5e1;
      --color-text: #0f172a;
      --color-text-secondary: #64748b;
      --shadow-lg: 0 20px 40px -12px rgba(0,0,0,0.15);
      --font: 'Manrope', sans-serif;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: var(--font); background: var(--color-bg); color: var(--color-text); display: flex; min-height: 100vh; overflow: hidden; }
    .background { position: fixed; inset: 0; overflow: hidden; z-index: -1; }
    .blob { position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.35; }
    .blob1 { width: 400px; height: 400px; background: #6a11cb; top: -100px; left: -100px; animation: move1 30s infinite alternate ease-in-out; }
    .blob2 { width: 350px; height: 350px; background: #2575fc; bottom: -150px; right: -120px; animation: move2 40s infinite alternate ease-in-out; }
    .blob3 { width: 300px; height: 300px; background: #16a34a; top: 40%; left: 60%; animation: move3 35s infinite alternate ease-in-out; }
    @keyframes move1 { 0% { transform: translate(0,0);} 100% { transform: translate(150px,200px);} }
    @keyframes move2 { 0% { transform: translate(0,0);} 100% { transform: translate(-200px,-100px);} }
    @keyframes move3 { 0% { transform: translate(0,0);} 100% { transform: translate(100px,-150px);} }

    .sidebar { width: 260px; background: linear-gradient(180deg, var(--color-primary-start), var(--color-primary-end)); color: #fff; padding: 28px 18px 22px; display: flex; flex-direction: column; align-items: center; box-shadow: var(--shadow-lg); z-index: 10; }
    .sidebar h1 { margin: 0; font-size: 22px; font-weight: 700; text-align: center; }
    .sidebar h2 { margin: 6px 0 20px; font-size: 12px; font-weight: 400; opacity: .9; text-align: center; }
    .sidebar ul { list-style: none; padding: 0; margin: 0; width: 100%; display: flex; flex-direction: column; gap: 12px; }
    .sidebar li { background: rgba(255,255,255,.16); padding: 12px 14px; border-radius: 10px; font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background .25s; }
    .sidebar li:hover { background: rgba(255,255,255,.28); }
    .sidebar li.disabled { opacity: .55; cursor: not-allowed; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #16a34a; animation: blink 1.2s infinite; }
    @keyframes blink { 0%,50%,100%{opacity:1} 25%,75%{opacity:0} }

    .top-banner { position: fixed; top: 0; left: 260px; right: 0; background: linear-gradient(90deg, var(--color-primary-start), var(--color-primary-end)); color: #fff; padding: 18px 36px; box-shadow: var(--shadow-lg); display: flex; align-items: baseline; gap: 14px; z-index: 5; }
    .top-banner h1 { margin: 0; font-size: 26px; font-weight: 700; }
    .top-banner p { margin: 0; font-size: 14px; opacity: .95; }
    .loader { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,.6); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; vertical-align: -2px; margin-right: 8px; }
    @keyframes spin { to { transform: rotate(360deg);} }

    .main { flex: 1; padding: 110px 36px 28px; overflow-y: auto; }
    .inicio { max-width: 1100px; margin: 0 auto; text-align: center; }
    .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 22px; margin-top: 26px; }
    .card { background: var(--color-surface); border-radius: 18px; padding: 26px; box-shadow: var(--shadow-lg); cursor: pointer; transition: transform .22s, box-shadow .22s; position: relative; }
    .card:hover { transform: translateY(-6px); box-shadow: 0 25px 50px -15px rgba(106,17,203,.22); }
    .card h2 { margin: 12px 0 4px; font-size: 20px; }
    .card p { margin: 0; color: var(--color-text-secondary); font-size: 14px; }
    .card-icon { width: 58px; height: 58px; margin: 0 auto; border-radius: 50%; display: grid; place-items: center; color: #fff; background: linear-gradient(135deg, var(--color-primary-start), var(--color-primary-end)); font-size: 26px; }
    .status-pill { position: absolute; top: 12px; right: 12px; background: #e6f7f0; color: #16a34a; font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 999px; display: inline-flex; align-items: center; gap: 6px; }

    .section { display: none; }
    .section.active { display: block; }
    .frame-wrap { position: relative; width: 100%; height: calc(100vh - 170px); border-radius: 16px; overflow: hidden; background: #fff; box-shadow: var(--shadow-lg); }
    .frame-wrap iframe { width: 100%; height: 100%; border: 0; background: #fff; }
    .frame-overlay { position: absolute; inset: 0; display: grid; place-items: center; background: rgba(244,247,254,.75); font-weight: 700; font-size: 15px; }
    .frame-overlay .spinner { width: 20px; height: 20px; border: 3px solid rgba(37,117,252,.25); border-top-color: #2575fc; border-radius: 50%; animation: spin .9s linear infinite; margin-right: 10px; display: inline-block; vertical-align: -4px; }

    .ia-helper { position: fixed; right: 18px; bottom: 18px; display: flex; align-items: flex-end; gap: 10px; }
    .ia-msg { background: var(--color-surface); padding: 11px 14px; border-radius: 12px; box-shadow: var(--shadow-lg); font-size: 13px; max-width: 280px; color: var(--color-text-secondary); }
    .ia-avatar { width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--color-primary-start), var(--color-primary-end)); color: #fff; display: grid; place-items: center; font-size: 24px; animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%,100% { transform: translateY(0);} 50% { transform: translateY(-8px);} }
  </style>
</head>
<body>
  <div class="background">
    <div class="blob blob1"></div><div class="blob blob2"></div><div class="blob blob3"></div>
  </div>
  <aside class="sidebar">
    <h1>Gestor Operativo</h1><h2>Plataforma de automatizaci√≥n inteligente</h2>
    <ul>
      <li onclick="goInicio()">üè† Inicio</li>
      <li onclick="openSection('calendario')">üìÖ Calendario Teletrabajo <span class='status-dot'></span></li>
      <li onclick="openSection('turnos')">üìä Turnos Diarios <span class='status-dot'></span></li>
      <li onclick="openSection('cartas')">üìÑ Carta de Amonestaci√≥n <span class='status-dot'></span></li>
      <li class="disabled">üöê Gesti√≥n de Transporte (En desarrollo)</li>
      <li class="disabled">üîÑ Cambio de Turnos (Pr√≥ximamente)</li>
    </ul>
  </aside>
  <header class="top-banner" id="topBanner"><h1>‚ö° Gestor Operativo</h1><p>Plataforma de automatizaci√≥n inteligente</p></header>
  <main class="main">
    <section id="inicio" class="inicio"><h1>üöÄ Bienvenido</h1><p>Selecciona el m√≥dulo que deseas utilizar</p>
      <div class="card-grid">
        <article class="card" onclick="openSection('calendario')"><div class="status-pill"><span class="status-dot"></span>Activo</div><div class="card-icon">üìÖ</div><h2>Calendario Teletrabajo</h2><p>Gestiona la presencialidad y el trabajo remoto.</p></article>
        <article class="card" onclick="openSection('turnos')"><div class="status-pill"><span class="status-dot"></span>Activo</div><div class="card-icon">üìä</div><h2>Turnos Diarios</h2><p>Genera turnos de forma autom√°tica y optimizada.</p></article>
        <article class="card" onclick="openSection('cartas')"><div class="status-pill"><span class="status-dot"></span>Activo</div><div class="card-icon">üìÑ</div><h2>Carta de Amonestaci√≥n</h2><p>Crea documentos formales en segundos.</p></article>
        <article class="card disabled"><div class="card-icon">üöê</div><h2>Gesti√≥n de Transporte</h2><p>(En desarrollo)</p></article>
        <article class="card disabled"><div class="card-icon">üîÑ</div><h2>Cambio de Turnos</h2><p>(Pr√≥ximamente)</p></article>
      </div>
    </section>
    <section class="section" id="calendario"><div class="frame-wrap"><div class="frame-overlay" id="overlay-calendario"><span class="spinner"></span> Cargando Calendario‚Ä¶</div><iframe id="frame-calendario" title="Calendario Teletrabajo"></iframe></div></section>
    <section class="section" id="turnos"><div class="frame-wrap"><div class="frame-overlay" id="overlay-turnos"><span class="spinner"></span> Cargando Turnos‚Ä¶</div><iframe id="frame-turnos" title="Turnos Diarios"></iframe></div></section>
    <section class="section" id="cartas"><div class="frame-wrap"><div class="frame-overlay" id="overlay-cartas"><span class="spinner"></span> Cargando Cartas‚Ä¶</div><iframe id="frame-cartas" title="Carta de Amonestaci√≥n"></iframe></div></section>
  </main>
  <div class="ia-helper"><div class="ia-msg" id="iaMsg">üí° Consejo: Usa los m√≥dulos activos para ahorrar tiempo.</div><div class="ia-avatar">ü§ñ</div></div>
  <template id="mod-calendario"><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestiones Inbound - Calendario de Presencialidad</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%236a11cb' d='M50 0 L100 25 L100 75 L50 100 L0 75 L0 25 Z'%3E%3C/path%3E%3Cpath fill='%23ffffff' d='M50 20 L75 35 L75 65 L50 80 L25 65 L25 35 Z'%3E%3C/path%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #f4f7fe;
            --color-surface: #ffffff;
            --color-primary-start: #6a11cb;
            --color-primary-end: #2575fc;
            --color-success-start: #16a34a;
            --color-success-end: #15803d;
            --color-text: #1e293b;
            --color-text-secondary: #64748b;
            --color-border: #e2e8f0;
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            --font-family: 'Manrope', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family); background-color: var(--color-bg); min-height: 100vh;
            display: flex; justify-content: center; align-items: center; padding: 20px;
            color: var(--color-text); position: relative; overflow: hidden;
        }
        .main-container {
            display: grid; grid-template-columns: 1fr; max-width: 1200px; width: 100%;
            background: var(--color-surface); border-radius: 24px; box-shadow: var(--shadow-lg);
            border: 1px solid white; overflow: hidden; z-index: 10;
        }
        @media (min-width: 800px) { .main-container { grid-template-columns: 35% 65%; } }
        .illustration-panel {
            background: linear-gradient(160deg, #f0f5ff, #e6efff); padding: 40px;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .calendar-animation {
            width: 250px; height: 200px; background-color: #fff; border-radius: 8px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2); padding: 15px; display: flex;
            flex-direction: column; gap: 8px; transform: perspective(800px) rotateX(15deg) rotateY(-25deg);
        }
        .calendar-header { width: 100%; height: 25px; background-color: #eef2f9; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: #6a11cb; }
        .calendar-week { display: flex; gap: 4px; }
        .calendar-day { flex: 1; height: 25px; border-radius: 4px; position: relative; overflow: hidden; animation: dayPulse 3s ease-in-out infinite; }
        .calendar-day.site { background: linear-gradient(135deg, #2575fc, #6a11cb); }
        .calendar-day.tt { background: linear-gradient(135deg, #16a34a, #15803d); }
        .calendar-day.libre { background: #f8fafc; }
        @keyframes dayPulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
        .illustration-panel h2 { margin-top: 20px; font-size: 22px; color: var(--color-text); }
        .illustration-panel p { margin-top: 8px; font-size: 15px; color: var(--color-text-secondary); max-width: 300px; line-height: 1.6; }
        .content-panel { padding: 40px; }
        .header { text-align: center; margin-bottom: 30px; }
        h1 { color: var(--color-text); font-size: 28px; font-weight: 700; }
        .upload-area {
            border: 2px dashed var(--color-border); border-radius: 12px; padding: 40px 20px;
            text-align: center; transition: all 0.3s ease; cursor: pointer; background-color: #fafbff;
        }
        .upload-area:hover, .upload-area.dragover { border-color: var(--color-primary-end); background: #f7faff; transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(37, 117, 252, 0.1); }
        .upload-icon { width: 48px; height: 48px; margin: 0 auto 15px; background: linear-gradient(45deg, var(--color-primary-start), var(--color-primary-end)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease; }
        .upload-area:hover .upload-icon { transform: scale(1.1) rotate(10deg); }
        .upload-text { color: var(--color-text); font-size: 16px; font-weight: 600; }
        input[type="file"] { display: none; }
        .button-container { text-align: center; margin-top: 25px; }
        .button { background-image: linear-gradient(45deg, var(--color-primary-start) 0%, var(--color-primary-end) 100%); color: white; border: none; padding: 14px 35px; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 10px; }
        .button:hover { transform: translateY(-3px); box-shadow: 0 7px 20px rgba(106, 17, 203, 0.3); }
        .button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .button.secondary { background: #f8fafc; color: var(--color-text); border: 1px solid var(--color-border); }
        .button.secondary:hover { background: #e2e8f0; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        #downloadBtn { display: none; background-image: linear-gradient(45deg, var(--color-success-start) 0%, var(--color-success-end) 100%); }
        #downloadBtn:hover { box-shadow: 0 7px 20px rgba(22, 163, 74, 0.3); }
        .button-icon { width: 20px; height: 20px; }
        .file-info { background: #f8faff; padding: 15px; border-radius: 10px; margin-top: 20px; display: none; animation: fadeIn 0.5s; }
        .file-info.active { display: block; }
        .progress-bar { width: 100%; height: 8px; background: var(--color-border); border-radius: 4px; margin-top: 20px; overflow: hidden; display: none; }
        .progress-bar.active { display: block; }
        .progress-fill { height: 100%; background: linear-gradient(45deg, var(--color-primary-start), var(--color-primary-end)); border-radius: 4px; width: 0%; transition: width 0.3s ease; }
        .status-message { text-align: center; margin-top: 20px; padding: 15px; border-radius: 10px; display: none; animation: slideDown 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status-message.success { background: #e6f7f0; color: #0d8a54; display: block; }
        .status-message.error { background: #fdeaea; color: #d92d20; display: block; }
        
        #weekSelectorContainer { display: none; margin-top: 20px; animation: fadeIn 0.5s; position: relative; }
        #weekSelectorContainer label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--color-text-secondary); }
        .custom-select-wrapper { position: relative; }
        .custom-select-trigger { width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--color-border); background-color: #f8fafc; font-family: var(--font-family); font-size: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; }
        .custom-select-trigger:hover { border-color: var(--color-primary-end); }
        .custom-select-trigger::after { content: '‚ñº'; font-size: 12px; color: var(--color-text-secondary); transition: transform 0.3s ease; }
        .custom-select-wrapper.open .custom-select-trigger::after { transform: rotate(180deg); }
        .custom-options { position: absolute; top: 105%; left: 0; right: 0; background: var(--color-surface); border-radius: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); z-index: 100; max-height: 200px; overflow-y: auto; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; }
        .custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-option { padding: 12px 15px; cursor: pointer; transition: background-color 0.2s ease; border-bottom: 1px solid var(--color-border); }
        .custom-option:last-child { border-bottom: none; }
        .custom-option:hover { background-color: #f4f7fe; }
        .custom-option.selected { background-color: #eef2ff; font-weight: 600; color: var(--color-primary-end); }
        #weekSelector { display: none; }

        /* Agent Configuration Styles */
        #agentConfigContainer { display: none; margin-top: 20px; animation: fadeIn 0.5s; }
        .config-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .config-header h3 { font-size: 18px; font-weight: 600; color: var(--color-text); }
        .agents-list { max-height: 60vh; overflow-y: auto; border: 1px solid var(--color-border); border-radius: 8px; background: #fafbff; }
        .agent-item { padding: 15px; border-bottom: 1px solid var(--color-border); display: grid; grid-template-columns: 2fr 1fr 2fr auto; gap: 15px; align-items: start; transition: background-color 0.2s ease; min-height: fit-content; }
        .agent-item:last-child { border-bottom: none; }
        .agent-item:hover { background-color: #f4f7fe; }
        .agent-info { }
        .agent-name { font-weight: 600; color: var(--color-text); margin-bottom: 2px; }
        .agent-config { display: flex; flex-direction: column; gap: 5px; }
        .config-select { padding: 8px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 14px; background: white; width: 100%; }
        .day-checkboxes { display: flex; gap: 5px; flex-wrap: wrap; }
        .day-checkbox-label { display: flex; align-items: center; gap: 3px; font-size: 12px; color: var(--color-text-secondary); }
        .day-checkbox { width: 16px; height: 16px; cursor: pointer; }
        .special-config { display: none; margin-top: 10px; padding: 15px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; max-height: 50vh; overflow-y: auto; }
        .special-config.active { display: block; }
        .special-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .special-column { }
        .special-column h5 { margin: 0 0 8px 0; font-size: 13px; font-weight: 600; text-align: center; padding: 6px; border-radius: 4px; }
        .special-column.tt h5 { background: #dcfce7; color: #166534; }
        .special-column.site h5 { background: #fef3c7; color: #92400e; }
        .special-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px; align-items: center; }
        .special-option { }
        .special-option label { display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer; }
        .special-option input[type="checkbox"] { width: 14px; height: 14px; }
        .special-description { font-size: 11px; color: var(--color-text-secondary); margin-top: 3px; font-style: italic; }
        .remove-btn { padding: 8px 12px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.2s ease; }
        .remove-btn:hover { background: #b91c1c; }

        .add-agent-section { padding: 15px; background: #f8faff; border-top: 1px solid var(--color-border); }
        .add-agent-controls { display: flex; gap: 10px; align-items: center; }
        .add-agent-select { flex: 1; padding: 10px; border: 1px solid var(--color-border); border-radius: 6px; background: white; }
        .add-btn { padding: 8px 15px; background: var(--color-primary-end); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.2s ease; }
        .add-btn:hover { background: var(--color-primary-start); }

        .legend { margin-top: 15px; padding: 15px; background: #f8faff; border-radius: 8px; }
        .legend h4 { font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--color-text); }
        .legend-item { font-size: 13px; color: var(--color-text-secondary); margin-bottom: 3px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
</head>
<body>
    <div class="main-container">
        <div class="illustration-panel">
            <div class="calendar-animation">
                <div class="calendar-header">Calendario Presencialidad</div>
                <div class="calendar-week">
                    <div class="calendar-day site" style="animation-delay: 0.1s;"></div>
                    <div class="calendar-day tt" style="animation-delay: 0.3s;"></div>
                    <div class="calendar-day tt" style="animation-delay: 0.5s;"></div>
                    <div class="calendar-day tt" style="animation-delay: 0.7s;"></div>
                    <div class="calendar-day tt" style="animation-delay: 0.9s;"></div>
                </div>
                <div class="calendar-week">
                    <div class="calendar-day libre" style="animation-delay: 1.1s;"></div>
                    <div class="calendar-day libre" style="animation-delay: 1.3s;"></div>
                    <div class="calendar-day site" style="animation-delay: 1.5s;"></div>
                    <div class="calendar-day tt" style="animation-delay: 1.7s;"></div>
                    <div class="calendar-day tt" style="animation-delay: 1.9s;"></div>
                </div>
                <div class="calendar-week">
                    <div class="calendar-day tt" style="animation-delay: 2.1s;"></div>
                    <div class="calendar-day tt" style="animation-delay: 2.3s;"></div>
                    <div class="calendar-day libre" style="animation-delay: 2.5s;"></div>
                    <div class="calendar-day libre" style="animation-delay: 2.7s;"></div>
                    <div class="calendar-day site" style="animation-delay: 2.9s;"></div>
                </div>
            </div>
            <h2>Calendario Inteligente</h2>
            <p>Genera autom√°ticamente la distribuci√≥n de Site y Teletrabajo basado en patrones personalizables por agente.</p>
        </div>
        <div class="content-panel">
            <div class="header"><h1>Generador de Calendario de Presencialidad</h1></div>
            
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                <div class="upload-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="button-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                </div>
                <div class="upload-text">Cargar archivo de turnos (Excel/CSV)</div>
            </div>
            
            <div class="file-info" id="fileInfo">
                <span id="fileNameText"></span>
            </div>

            <div id="weekSelectorContainer">
                <label for="weekSelector">2. Selecciona la semana a procesar</label>
                <div class="custom-select-wrapper" id="customSelect">
                    <select id="weekSelector"></select>
                    <div class="custom-select-trigger" id="customSelectTrigger">-- Esperando archivo --</div>
                    <div class="custom-options" id="customOptions"></div>
                </div>
            </div>

            <div id="agentConfigContainer">
                <div class="config-header">
                    <h3>3. Configurar Agentes</h3>
                    <button class="button secondary" id="toggleAgentConfig">
                        <svg xmlns="http://www.w3.org/2000/svg" class="button-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
                        </svg>
                        Configurar
                    </button>
                </div>
                
                <div class="agents-list" id="agentsList" style="display: none;">
                    <!-- Agent items will be populated here -->
                </div>
                
                <div class="add-agent-section" id="addAgentSection" style="display: none;">
                    <div class="add-agent-controls">
                        <select class="add-agent-select" id="addAgentSelect">
                            <option value="">Seleccionar agente para agregar...</option>
                        </select>
                        <button class="add-btn" id="addAgentBtn">+ Agregar</button>
                    </div>
                </div>


            </div>
            
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="button-container">
                <button class="button" id="generateBtn" disabled>Generar Calendario</button>
                <button class="button" id="downloadBtn">Descargar Excel</button>
            </div>
            
            <div class="status-message" id="statusMessage"></div>
        </div>
    </div>
    
    <script>
        let allData = null;
        let turnosData = null;
        let generatedWorkbook = null;
        let fileName = '';
        let availableAgents = [];
        let configuredAgents = new Map();
        let defaultAgentsConfig = [
            { nombre: "Aros Medina Carla Yessenia", modalidad: "3x2", condicion: ["segundo"] },
            { nombre: "Alvarado Catal√°n Yocelyn Susana", modalidad: "4x1", condicion: ["segundo"] },
            { nombre: "Bracho Torres Josselin Tamara", modalidad: "4x1", condicion: ["tercer"] },
            { nombre: "Cort√©s Carmona Jessica Marcela", modalidad: "4x1", condicion: ["segundo"] },
            { nombre: "Mendoza Escobar Paola Alejandra", modalidad: "4x1", condicion: ["segundo"] },
            { nombre: "Neip√°n Lemuy Jessica Andrea", modalidad: "4x1", condicion: ["primer"] },
            { nombre: "Sol√≠s Y√°√±ez Cristian Andr√©s", modalidad: "4x1", condicion: ["tercer"] },
            { nombre: "Vargas Huirimilla Alisson Danitza", modalidad: "4x1", condicion: ["tercer"] },
            { nombre: "Vidal Gatica Yanira Belen", modalidad: "3x2", condicion: ["segundo", "tercer"] },
            { nombre: "Garces Nu√±ez Nicole Andrea", modalidad: "3x2", condicion: ["primer", "tercer"] },
            { nombre: "Ricouz Ricouz Valentina Anhelore", modalidad: "3x2", condicion: ["tercer", "quinto"] },
            { nombre: "Planzer Huanquil Catalina Fernanda", modalidad: "4x1", condicion: ["primer"] },
            { nombre: "Manriquez Mansilla Yasmin Fernanda", modalidad: "3x2", condicion: ["tercer", "quinto"] },
            { nombre: "Alvarado Rios Barbara Ivonne", modalidad: "4x1", condicion: ["primer"] },
            // Agentes con modalidades especiales
            { nombre: "Cardenas Huenuqueo Valeria Constanza", modalidad: "especial", condicion: ["pm_tt", "noche_tt", "weekend_festivos_tt"] }
        ];

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileNameEl = document.getElementById('fileNameText');
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const statusMessage = document.getElementById('statusMessage');
        const weekSelectorContainer = document.getElementById('weekSelectorContainer');
        const weekSelector = document.getElementById('weekSelector');
        const customSelect = document.getElementById('customSelect');
        const customSelectTrigger = document.getElementById('customSelectTrigger');
        const customOptions = document.getElementById('customOptions');
        const agentConfigContainer = document.getElementById('agentConfigContainer');
        const toggleAgentConfig = document.getElementById('toggleAgentConfig');
        const agentsList = document.getElementById('agentsList');
        const addAgentSection = document.getElementById('addAgentSection');
        const addAgentSelect = document.getElementById('addAgentSelect');
        const addAgentBtn = document.getElementById('addAgentBtn');

        // Event listeners
        customSelectTrigger.addEventListener('click', () => customSelect.classList.toggle('open'));
        window.addEventListener('click', (e) => { 
            if (!customSelect.contains(e.target)) customSelect.classList.remove('open'); 
        });

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            uploadArea.classList.add('dragover'); 
        });
        uploadArea.addEventListener('dragleave', () => { 
            uploadArea.classList.remove('dragover'); 
        });
        uploadArea.addEventListener('drop', (e) => { 
            e.preventDefault(); 
            uploadArea.classList.remove('dragover'); 
            if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]); 
        });
        fileInput.addEventListener('change', (e) => { 
            if (e.target.files.length > 0) handleFile(e.target.files[0]); 
        });

        toggleAgentConfig.addEventListener('click', () => {
            const isVisible = agentsList.style.display !== 'none';
            agentsList.style.display = isVisible ? 'none' : 'block';
            addAgentSection.style.display = isVisible ? 'none' : 'block';
            toggleAgentConfig.innerHTML = isVisible ? 
                `<svg xmlns="http://www.w3.org/2000/svg" class="button-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
                </svg>Configurar` : 
                `<svg xmlns="http://www.w3.org/2000/svg" class="button-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
                </svg>Ocultar`;
        });

        addAgentBtn.addEventListener('click', addAgent);
        weekSelector.addEventListener('change', handleWeekSelection);
        generateBtn.addEventListener('click', generateCalendar);
        downloadBtn.addEventListener('click', downloadExcel);

        function handleFile(file) {
            fileNameEl.textContent = file.name;
            fileInfo.classList.add('active');
            generateBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    allData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    extractAvailableAgents(allData);
                    populateWeekSelector(allData);
                    initializeDefaultConfigurations();
                    updateAgentsList();
                    updateAddAgentSelect();
                    
                    weekSelectorContainer.style.display = 'block';
                    agentConfigContainer.style.display = 'block';
                    showStatus('Archivo cargado correctamente. Configura los agentes y selecciona una semana.', 'success');
                } catch(error) {
                    showStatus('Error al leer el archivo. Aseg√∫rate que sea un Excel v√°lido.', 'error');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function extractAvailableAgents(data) {
            const agentsSet = new Set();
            data.forEach(row => {
                if (row.Nombre && row.Rut) {
                    // Solo agregar agentes que NO est√°n en las configuraciones por defecto
                    const isConfigured = defaultAgentsConfig.some(config => 
                        config.nombre.trim().toLowerCase() === row.Nombre.trim().toLowerCase()
                    );
                    
                    if (!isConfigured) {
                        agentsSet.add(JSON.stringify({ nombre: row.Nombre, rut: row.Rut }));
                    }
                }
            });
            availableAgents = Array.from(agentsSet).map(agentStr => JSON.parse(agentStr));
        }

        function initializeDefaultConfigurations() {
            configuredAgents.clear();
            
            // Solo agregar agentes que est√°n en la lista de configuraciones por defecto
            // Y que tambi√©n existen en el archivo de turnos cargado
            defaultAgentsConfig.forEach(defaultConfig => {
                // Buscar si este agente existe en los datos cargados
                const agentInFile = allData.find(row => 
                    row.Nombre && row.Nombre.trim().toLowerCase() === defaultConfig.nombre.trim().toLowerCase()
                );
                
                if (agentInFile) {
                    const key = `${defaultConfig.nombre}_${agentInFile.Rut || 'SIN_RUT'}`;
                    configuredAgents.set(key, {
                        nombre: defaultConfig.nombre,
                        rut: agentInFile.Rut || 'SIN_RUT',
                        modalidad: defaultConfig.modalidad,
                        condicion: defaultConfig.condicion
                    });
                }
            });
            
            // Corregir configuraciones incoherentes en agentes existentes
            configuredAgents.forEach((config, key) => {
                if (config.modalidad === 'especial' && config.condicion) {
                    config.condicion = fixIncoherentConfiguration(config.condicion);
                }
            });
        }
        
        function fixIncoherentConfiguration(condicion) {
            const fixed = [];
            const types = ['am', 'pm', 'noche', 'weekend_festivos'];
            
            types.forEach(type => {
                const ttOption = `${type}_tt`;
                const siteOption = `${type}_site`;
                
                if (condicion.includes(ttOption) && condicion.includes(siteOption)) {
                    // Si ambas est√°n seleccionadas, mantener solo TT (o puedes cambiar la prioridad)
                    fixed.push(ttOption);
                } else if (condicion.includes(ttOption)) {
                    fixed.push(ttOption);
                } else if (condicion.includes(siteOption)) {
                    fixed.push(siteOption);
                }
            });
            
            return fixed;
        }

        function updateAgentsList() {
            agentsList.innerHTML = '';
            configuredAgents.forEach((config, key) => {
                const agentItem = createAgentItem(config);
                agentsList.appendChild(agentItem);
            });
        }

        function createAgentItem(config) {
            const div = document.createElement('div');
            div.className = 'agent-item';
            
            const isSpecial = config.modalidad === 'especial';
            
            div.innerHTML = `
                <div class="agent-info">
                    <div class="agent-name">${config.nombre}</div>
                </div>
                <div class="agent-config">
                    <select class="config-select modalidad-select">
                        <option value="4x1" ${config.modalidad === '4x1' ? 'selected' : ''}>4x1</option>
                        <option value="3x2" ${config.modalidad === '3x2' ? 'selected' : ''}>3x2</option>
                        <option value="especial" ${config.modalidad === 'especial' ? 'selected' : ''}>Especiales</option>
                    </select>
                </div>
                <div class="agent-config">
                    <div class="day-checkboxes" ${isSpecial ? 'style="display: none;"' : ''}>
                        ${['primer', 'segundo', 'tercer', 'cuarto', 'quinto'].map(day => `
                            <label class="day-checkbox-label">
                                <input type="checkbox" class="day-checkbox" value="${day}" 
                                       ${config.condicion && config.condicion.includes(day) ? 'checked' : ''}>
                                ${day.charAt(0).toUpperCase() + day.slice(1, 3)}
                            </label>
                        `).join('')}
                    </div>
                    
                    <div class="special-config ${isSpecial ? 'active' : ''}">
                        <div class="special-columns">
                            <div class="special-column tt">
                                <h5>üè† TELETRABAJO (TT)</h5>
                            </div>
                            <div class="special-column site">
                                <h5>üè¢ PRESENCIAL (SITE)</h5>
                            </div>
                        </div>
                        
                        <div class="special-row">
                            <div class="special-option">
                                <label>
                                    <input type="checkbox" class="special-checkbox" value="am_tt" 
                                           ${config.condicion && config.condicion.includes('am_tt') ? 'checked' : ''}>
                                    Turnos AM (07:00-11:59)
                                </label>
                            </div>
                            <div class="special-option">
                                <label>
                                    <input type="checkbox" class="special-checkbox" value="am_site" 
                                           ${config.condicion && config.condicion.includes('am_site') ? 'checked' : ''}>
                                    Turnos AM (07:00-11:59)
                                </label>
                            </div>
                        </div>
                        
                        <div class="special-row">
                            <div class="special-option">
                                <label>
                                    <input type="checkbox" class="special-checkbox" value="pm_tt" 
                                           ${config.condicion && config.condicion.includes('pm_tt') ? 'checked' : ''}>
                                    Turnos PM (12:00-23:59)
                                </label>
                            </div>
                            <div class="special-option">
                                <label>
                                    <input type="checkbox" class="special-checkbox" value="pm_site" 
                                           ${config.condicion && config.condicion.includes('pm_site') ? 'checked' : ''}>
                                    Turnos PM (12:00-23:59)
                                </label>
                            </div>
                        </div>
                        
                        <div class="special-row">
                            <div class="special-option">
                                <label>
                                    <input type="checkbox" class="special-checkbox" value="noche_tt" 
                                           ${config.condicion && config.condicion.includes('noche_tt') ? 'checked' : ''}>
                                    Turnos Noche
                                </label>
                            </div>
                            <div class="special-option">
                                <label>
                                    <input type="checkbox" class="special-checkbox" value="noche_site" 
                                           ${config.condicion && config.condicion.includes('noche_site') ? 'checked' : ''}>
                                    Turnos Noche
                                </label>
                            </div>
                        </div>
                        
                        <div class="special-row">
                            <div class="special-option">
                                <label>
                                    <input type="checkbox" class="special-checkbox" value="weekend_festivos_tt" 
                                           ${config.condicion && config.condicion.includes('weekend_festivos_tt') ? 'checked' : ''}>
                                    Fines de Semana y Festivos
                                </label>
                            </div>
                            <div class="special-option">
                                <label>
                                    <input type="checkbox" class="special-checkbox" value="weekend_festivos_site" 
                                           ${config.condicion && config.condicion.includes('weekend_festivos_site') ? 'checked' : ''}>
                                    Fines de Semana y Festivos
                                </label>
                            </div>
                        </div>
                        
                        <div class="special-description">
                            ‚ö†Ô∏è Selecciona solo UNA opci√≥n por fila (TT o SITE, no ambas). El sistema previene configuraciones incoherentes autom√°ticamente.
                        </div>
                    </div>
                </div>
                <button class="remove-btn" onclick="removeAgent('${config.nombre}_${config.rut}')">√ó</button>
            `;

            // Add event listeners
            const modalidadSelect = div.querySelector('.modalidad-select');
            const dayCheckboxes = div.querySelectorAll('.day-checkbox');
            const specialCheckboxes = div.querySelectorAll('.special-checkbox');
            const dayCheckboxContainer = div.querySelector('.day-checkboxes');
            const specialConfigContainer = div.querySelector('.special-config');

            modalidadSelect.addEventListener('change', (e) => {
                const isSpecialMode = e.target.value === 'especial';
                dayCheckboxContainer.style.display = isSpecialMode ? 'none' : 'flex';
                if (isSpecialMode) {
                    specialConfigContainer.classList.add('active');
                } else {
                    specialConfigContainer.classList.remove('active');
                }
                updateAgentConfig(config.nombre + '_' + config.rut);
            });

            dayCheckboxes.forEach(cb => cb.addEventListener('change', () => updateAgentConfig(config.nombre + '_' + config.rut)));
            specialCheckboxes.forEach(cb => cb.addEventListener('change', (e) => {
                // Prevenir conflictos: si selecciona TT para un tipo, deseleccionar SITE del mismo tipo
                const value = e.target.value;
                const isChecked = e.target.checked;
                
                if (isChecked) {
                    let conflictingValue = '';
                    if (value.includes('_tt')) {
                        conflictingValue = value.replace('_tt', '_site');
                    } else if (value.includes('_site')) {
                        conflictingValue = value.replace('_site', '_tt');
                    }
                    
                    if (conflictingValue) {
                        const conflictingCheckbox = agentItem.querySelector(`input[value="${conflictingValue}"]`);
                        if (conflictingCheckbox) {
                            conflictingCheckbox.checked = false;
                        }
                    }
                }
                
                updateAgentConfig(config.nombre + '_' + config.rut);
            }));

            return div;
        }

        function updateAgentConfig(key) {
            const agentItem = Array.from(agentsList.children).find(item => {
                const config = configuredAgents.get(key);
                return config && item.querySelector('.agent-name').textContent.trim() === config.nombre.trim();
            });
            
            if (agentItem) {
                const config = configuredAgents.get(key);
                const modalidad = agentItem.querySelector('.modalidad-select').value;
                
                if (modalidad === 'especial') {
                    const selectedSpecialOptions = Array.from(agentItem.querySelectorAll('.special-checkbox:checked')).map(cb => cb.value);
                    config.modalidad = 'especial';
                    config.condicion = selectedSpecialOptions;
                } else {
                    const selectedDays = Array.from(agentItem.querySelectorAll('.day-checkbox:checked')).map(cb => cb.value);
                    config.modalidad = modalidad;
                    config.condicion = selectedDays;
                }
            }
        }

        function updateAddAgentSelect() {
            addAgentSelect.innerHTML = '<option value="">Seleccionar agente para agregar...</option>';
            
            availableAgents.forEach(agent => {
                const key = agent.nombre + '_' + agent.rut;
                if (!configuredAgents.has(key)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${agent.nombre} (${agent.rut})`;
                    addAgentSelect.appendChild(option);
                }
            });
        }

        function addAgent() {
            const selectedKey = addAgentSelect.value;
            if (!selectedKey) return;

            const [nombre, rut] = selectedKey.split('_');
            const newConfig = {
                nombre: nombre,
                rut: rut,
                modalidad: '4x1',
                condicion: ['primer']
            };

            configuredAgents.set(selectedKey, newConfig);
            updateAgentsList();
            updateAddAgentSelect();
        }

        function removeAgent(key) {
            configuredAgents.delete(key);
            updateAgentsList();
            updateAddAgentSelect();
        }

        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day == 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            monday.setHours(0, 0, 0, 0);
            return monday;
        }

        function populateWeekSelector(data) {
            const weekSet = new Set();
            data.forEach(row => {
                if (row.Fecha) weekSet.add(getMonday(row.Fecha).toISOString());
            });

            const sortedWeeks = Array.from(weekSet).sort((a, b) => new Date(b) - new Date(a));
            const last4Weeks = sortedWeeks.slice(0, 4);

            weekSelector.innerHTML = '';
            customOptions.innerHTML = '';
            customSelectTrigger.textContent = '-- Selecciona una semana --';
            
            last4Weeks.forEach(mondayISO => {
                const monday = new Date(mondayISO);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                
                const monthName = sunday.toLocaleString('es-ES', { month: 'long' });
                const optionText = `Semana ${monday.getDate()} al ${sunday.getDate()} de ${monthName}`;
                
                const option = document.createElement('option');
                option.value = mondayISO;
                option.textContent = optionText;
                weekSelector.appendChild(option);

                const customOption = document.createElement('div');
                customOption.classList.add('custom-option');
                customOption.textContent = optionText;
                customOption.dataset.value = mondayISO;

                customOption.addEventListener('click', () => {
                    customSelectTrigger.textContent = customOption.textContent;
                    weekSelector.value = customOption.dataset.value;
                    weekSelector.dispatchEvent(new Event('change'));
                    document.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
                    customOption.classList.add('selected');
                    customSelect.classList.remove('open');
                });
                customOptions.appendChild(customOption);
            });
        }

        function handleWeekSelection(event) {
            const selectedMondayISO = event.target.value;
            if (!selectedMondayISO) {
                turnosData = null;
                generateBtn.disabled = true;
                return;
            }
            
            const selectedMonday = new Date(selectedMondayISO);
            const nextMonday = new Date(selectedMonday);
            nextMonday.setDate(selectedMonday.getDate() + 7);
            
            turnosData = allData.filter(row => {
                const rowDate = new Date(row.Fecha);
                return rowDate >= selectedMonday && rowDate < nextMonday;
            });
            
            generateBtn.disabled = false;
        }

        function generateCalendar() {
            if (!turnosData || turnosData.length === 0) {
                showStatus('No hay datos v√°lidos para procesar en la semana seleccionada.', 'error');
                return;
            }

            if (configuredAgents.size === 0) {
                showStatus('Debes configurar al menos un agente.', 'error');
                return;
            }

            progressBar.classList.add('active');
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                progressFill.style.width = progress + '%';
                if (progress >= 100) clearInterval(progressInterval);
            }, 100);

            setTimeout(async () => {
                await createCalendarWorkbook();
                progressBar.classList.remove('active');
                progressFill.style.width = '0%';
                if (fileName) {
                    showStatus('Calendario generado correctamente', 'success');
                    generateBtn.style.display = 'none';
                    downloadBtn.style.display = 'inline-flex';
                }
            }, 1500);
        }

        async function createCalendarWorkbook() {
            fileName = '';
            const workbook = new ExcelJS.Workbook();
            
            // Crear una sola hoja con el calendario
            const worksheet = workbook.addWorksheet('Calendario TT');
            
            let minDate = null, maxDate = null;
            
            // Encontrar el rango de fechas de la semana seleccionada
            turnosData.forEach(row => {
                if (row.Fecha) {
                    const fecha = new Date(row.Fecha);
                    if (!minDate || fecha < minDate) minDate = fecha;
                    if (!maxDate || fecha > maxDate) maxDate = fecha;
                }
            });

            if (minDate && maxDate) {
                const monday = getMonday(minDate);
                const monthName = monday.toLocaleString('es-ES', { month: 'long' }).toUpperCase();
                const year = monday.getFullYear();
                
                // Calcular los d√≠as de la semana
                const weekDays = [];
                for (let i = 0; i < 7; i++) {
                    const day = new Date(monday);
                    day.setDate(monday.getDate() + i);
                    weekDays.push(day);
                }
                
                const startDay = weekDays[0].getDate();
                const endDay = weekDays[6].getDate();
                
                fileName = `Calendario TT semana del ${startDay} al ${endDay} de ${monthName} ${year}.xlsx`;
                
                createCalendarSheet(worksheet, weekDays, monthName, year);
            } else {
                showStatus('No se encontraron fechas v√°lidas para la semana seleccionada.', 'error');
            }
            
            generatedWorkbook = workbook;
        }

        function createCalendarSheet(worksheet, weekDays, monthName, year) {
            // Configurar anchos de columna
            worksheet.columns = [
                { width: 5 },   // N¬∞
                { width: 35 },  // NOMBRE
                { width: 12 },  // Lunes
                { width: 12 },  // Martes
                { width: 12 },  // Mi√©rcoles
                { width: 12 },  // Jueves
                { width: 12 },  // Viernes
                { width: 12 },  // S√°bado
                { width: 12 },  // Domingo
                { width: 80 }   // Condiciones
            ];

            let rowIndex = 1;

            // T√≠tulo principal
            const titleRow = worksheet.getRow(rowIndex);
            titleRow.getCell(1).value = `CALENDARIO TT ${monthName} ${year}`;
            worksheet.mergeCells(rowIndex, 1, rowIndex, 10);
            titleRow.getCell(1).font = { bold: true, size: 14, name: 'Calibri' };
            titleRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
            rowIndex++;

            // Subt√≠tulo con semana
            const subtitleRow = worksheet.getRow(rowIndex);
            const startDay = weekDays[0].getDate();
            const endDay = weekDays[6].getDate();
            subtitleRow.getCell(1).value = `SEMANA ${startDay} AL ${endDay} ${monthName}`;
            worksheet.mergeCells(rowIndex, 1, rowIndex, 10);
            subtitleRow.getCell(1).font = { bold: true, size: 12, name: 'Calibri' };
            subtitleRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
            rowIndex++;

            // Headers
            const headerRow = worksheet.getRow(rowIndex);
            const headers = ['N¬∞', 'NOMBRE'];
            
            // Agregar d√≠as de la semana
            const dayNames = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
            weekDays.forEach((day, index) => {
                headers.push(`${dayNames[index]} ${day.getDate()}`);
            });
            headers.push('condiciones');

            headers.forEach((header, index) => {
                const cell = headerRow.getCell(index + 1);
                cell.value = header;
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF366092' } };
                cell.font = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 };
                cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                cell.border = {
                    top: { style: 'thin' }, left: { style: 'thin' },
                    bottom: { style: 'thin' }, right: { style: 'thin' }
                };
            });
            rowIndex++;

            // Generar filas para cada agente configurado
            let agentNumber = 1;
            configuredAgents.forEach((config, key) => {
                // Verificar si el agente tiene turnos en esta semana
                const agentShifts = turnosData.filter(row => 
                    row.Nombre && row.Nombre.trim().toLowerCase() === config.nombre.trim().toLowerCase()
                );

                if (agentShifts.length > 0) {
                    const agentRow = worksheet.getRow(rowIndex);
                    
                    // N¬∞
                    agentRow.getCell(1).value = agentNumber;
                    agentRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
                    
                    // Nombre
                    agentRow.getCell(2).value = config.nombre;
                    agentRow.getCell(2).alignment = { horizontal: 'left', vertical: 'middle' };
                    
                    // Calcular el estado para cada d√≠a
                    weekDays.forEach((day, dayIndex) => {
                        const dayShift = agentShifts.find(shift => {
                            if (!shift.Fecha) return false;
                            const shiftDate = new Date(shift.Fecha);
                            return shiftDate.getDate() === day.getDate() && 
                                   shiftDate.getMonth() === day.getMonth() && 
                                   shiftDate.getFullYear() === day.getFullYear();
                        });

                        let status = 'LIBRE';
                        if (dayShift) {
                            if (isLibre(dayShift)) {
                                status = 'LIBRE';
                            } else {
                                // Aplicar l√≥gica seg√∫n modalidad
                                if (config.modalidad === 'especial') {
                                    status = applySpecialLogic(dayShift, config.condicion, day);
                                } else {
                                    // L√≥gica normal (4x1 o 3x2)
                                    const workingShifts = agentShifts.filter(s => !isLibre(s)).sort((a, b) => new Date(a.Fecha) - new Date(b.Fecha));
                                    const shiftPosition = workingShifts.findIndex(s => s === dayShift) + 1;
                                    
                                    const sitePositions = config.condicion.map(day => getDayPosition(day));
                                    status = sitePositions.includes(shiftPosition) ? 'SITE' : 'TT';
                                }
                            }
                        }

                        const cell = agentRow.getCell(3 + dayIndex);
                        cell.value = status;
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        
                        // Colorear seg√∫n el estado
                        if (status === 'TT') {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF92D050' } };
                        } else if (status === 'SITE') {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFC000' } };
                        }
                    });

                    // Condiciones
                    const conditionText = generateConditionText(config);
                    agentRow.getCell(10).value = conditionText;
                    agentRow.getCell(10).alignment = { horizontal: 'left', vertical: 'middle', wrapText: true };

                    // Aplicar bordes a toda la fila
                    for (let i = 1; i <= 10; i++) {
                        agentRow.getCell(i).border = {
                            top: { style: 'thin' }, left: { style: 'thin' },
                            bottom: { style: 'thin' }, right: { style: 'thin' }
                        };
                        if (!agentRow.getCell(i).font) {
                            agentRow.getCell(i).font = { name: 'Calibri', size: 11 };
                        }
                    }

                    agentNumber++;
                    rowIndex++;
                }
            });
        }

        function applySpecialLogic(shift, specialConditions, day) {
            if (!shift.Ini || typeof shift.Ini.getHours !== 'function') return 'SITE';
            
            const shiftTime = new Date(shift.Ini);
            const hour = shiftTime.getHours();
            const dayOfWeek = day.getDay(); // 0 = domingo, 6 = s√°bado
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const isFestivo = checkIfFestivo(day);
            const isWeekendOrFestivo = isWeekend || isFestivo;
            
            // Determinar el tipo de turno por horario
            let shiftType = '';
            if (hour >= 0 && hour <= 6) {
                shiftType = 'noche';
            } else if (hour >= 7 && hour <= 11) {
                shiftType = 'am';
            } else {
                shiftType = 'pm';
            }
            
            // Verificar condiciones espec√≠ficas
            if (isWeekendOrFestivo) {
                if (specialConditions.includes('weekend_festivos_tt')) {
                    return 'TT';
                } else if (specialConditions.includes('weekend_festivos_site')) {
                    return 'SITE';
                }
            }
            
            // Verificar por tipo de turno
            if (specialConditions.includes(`${shiftType}_tt`)) {
                return 'TT';
            } else if (specialConditions.includes(`${shiftType}_site`)) {
                return 'SITE';
            }
            
            // Por defecto SITE si no est√° configurado
            return 'SITE';
        }
        
        function checkIfFestivo(day) {
            // Lista b√°sica de festivos de Chile 2024/2025 (puedes expandir)
            const festivos2024 = [
                '2024-01-01', // A√±o Nuevo
                '2024-03-29', // Viernes Santo
                '2024-03-30', // S√°bado Santo
                '2024-05-01', // D√≠a del Trabajador
                '2024-05-21', // D√≠a de las Glorias Navales
                '2024-06-29', // San Pedro y San Pablo
                '2024-07-16', // D√≠a de la Virgen del Carmen
                '2024-08-15', // Asunci√≥n de la Virgen
                '2024-09-18', // Independencia Nacional
                '2024-09-19', // D√≠a de las Glorias del Ej√©rcito
                '2024-10-12', // Encuentro de Dos Mundos
                '2024-11-01', // D√≠a de Todos los Santos
                '2024-12-08', // Inmaculada Concepci√≥n
                '2024-12-25'  // Navidad
            ];
            
            const festivos2025 = [
                '2025-01-01', // A√±o Nuevo
                '2025-04-18', // Viernes Santo
                '2025-04-19', // S√°bado Santo
                '2025-05-01', // D√≠a del Trabajador
                '2025-05-21', // D√≠a de las Glorias Navales
                '2025-06-29', // San Pedro y San Pablo
                '2025-07-16', // D√≠a de la Virgen del Carmen
                '2025-08-15', // Asunci√≥n de la Virgen
                '2025-09-18', // Independencia Nacional
                '2025-09-19', // D√≠a de las Glorias del Ej√©rcito
                '2025-10-12', // Encuentro de Dos Mundos
                '2025-11-01', // D√≠a de Todos los Santos
                '2025-12-08', // Inmaculada Concepci√≥n
                '2025-12-25'  // Navidad
            ];
            
            const dateStr = day.toISOString().split('T')[0];
            return festivos2024.includes(dateStr) || festivos2025.includes(dateStr);
        }

        function generateConditionText(config) {
            if (config.modalidad === 'especial') {
                const ttOptions = config.condicion.filter(c => c.endsWith('_tt'));
                const siteOptions = config.condicion.filter(c => c.endsWith('_site'));
                
                const formatConditions = (conditions, type) => {
                    if (conditions.length === 0) return '';
                    
                    const formatted = conditions.map(c => {
                        switch(c) {
                            case 'am_tt':
                            case 'am_site': return 'TURNOS AM';
                            case 'pm_tt':
                            case 'pm_site': return 'TURNOS PM';
                            case 'noche_tt':
                            case 'noche_site': return 'TURNOS NOCHE';
                            case 'weekend_festivos_tt':
                            case 'weekend_festivos_site': return 'FINES DE SEMANA Y FESTIVOS';
                            default: return c.toUpperCase();
                        }
                    }).join(', ');
                    
                    return `${formatted} ${type}`;
                };
                
                const ttText = formatConditions(ttOptions, 'TT');
                const siteText = formatConditions(siteOptions, 'PRESENCIAL');
                
                if (ttText && siteText) {
                    return `DISTRIBUCI√ìN PERSONALIZADA: ${ttText} X ${siteText}`;
                } else if (ttText) {
                    return `DISTRIBUCI√ìN PERSONALIZADA: ${ttText} X RESTO PRESENCIAL`;
                } else if (siteText) {
                    return `DISTRIBUCI√ìN PERSONALIZADA: ${siteText} X RESTO TT`;
                } else {
                    return 'DISTRIBUCI√ìN PERSONALIZADA';
                }
            } else {
                const modalidadText = config.modalidad === '4x1' ? '4 TT X 1 PRESENCIAL' : '3 TT X 2 PRESENCIAL';
                
                let positionText = '';
                if (config.condicion.length === 1) {
                    const position = config.condicion[0].toUpperCase();
                    positionText = `(${position} TURNO DE LA SEMANA)`;
                } else {
                    const positions = config.condicion.map(pos => {
                        const num = getDayPosition(pos);
                        return num === 1 ? '1er' : num === 2 ? '2do' : num === 3 ? '3er' : num === 4 ? '4to' : '5to';
                    }).join(' Y ');
                    positionText = `(${positions} TURNO DE LA SEMANA)`;
                }

                return `DISTRIBUCI√ìN ${modalidadText} ${positionText}`;
            }
        }

        function applyPresencialityPatterns(data) {
            const processedData = [...data];
            
            // Aplicar configuraciones solo a agentes configurados
            configuredAgents.forEach((config, key) => {
                // Find all shifts for this agent in the week
                const agentShifts = processedData.filter(row => 
                    row.Nombre && row.Nombre.trim().toLowerCase() === config.nombre.trim().toLowerCase() && !isLibre(row)
                ).sort((a, b) => new Date(a.Fecha) - new Date(b.Fecha));

                if (agentShifts.length === 0) return;

                // Apply pattern logic
                const sitePositions = config.condicion.map(day => getDayPosition(day));
                
                agentShifts.forEach((shift, index) => {
                    const shiftPosition = index + 1; // 1-based position
                    
                    // Check if this shift should be Site based on configuration
                    if (sitePositions.includes(shiftPosition)) {
                        shift.Lugar = 'Site';
                    } else {
                        shift.Lugar = 'TT';
                    }
                });
            });

            // Para todos los dem√°s agentes (no configurados), mantenerlos como Site (presencial)
            processedData.forEach(row => {
                if (row.Nombre && !isLibre(row)) {
                    const isConfigured = Array.from(configuredAgents.values()).some(config => 
                        config.nombre.trim().toLowerCase() === row.Nombre.trim().toLowerCase()
                    );
                    
                    if (!isConfigured) {
                        row.Lugar = 'Site'; // Todos los no configurados son presenciales
                    }
                }
            });

            return processedData;
        }

        function parsePattern(pattern) {
            const [tt, site] = pattern.split('x').map(Number);
            return { ttDays: tt, siteDays: site };
        }

        function getDayPosition(dayName) {
            const positions = {
                'primer': 1,
                'segundo': 2,
                'tercer': 3,
                'cuarto': 4,
                'quinto': 5
            };
            return positions[dayName] || 1;
        }

        function createStyledSheet(worksheet, dayData, fechaDia) {
            worksheet.columns = [
                { width: 39.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, 
                { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, 
                { width: 10.5 }, { width: 10.5 }, { width: 10 }
            ];

            let rowIndex = 1;
            
            // Create header row with date
            const fechaRow = worksheet.getRow(rowIndex);
            fechaRow.getCell(1).value = 'FECHA';
            fechaRow.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0B3041' } };
            fechaRow.getCell(1).font = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 };
            fechaRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            
            fechaRow.getCell(2).value = formatDate(fechaDia);
            worksheet.mergeCells(rowIndex, 2, rowIndex, 4);
            
            fechaRow.getCell(5).value = 'Permanencia';
            worksheet.mergeCells(rowIndex, 5, rowIndex, 6);
            fechaRow.getCell(5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0B3041' } };
            fechaRow.getCell(5).font = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 };
            fechaRow.getCell(5).alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            
            for (let i = 1; i <= 10; i++) {
                fechaRow.getCell(i).border = {
                    top: { style: 'thin' }, left: { style: 'thin' },
                    bottom: { style: 'thin' }, right: { style: 'thin' }
                };
                if (i !== 1 && i !== 5) {
                    fechaRow.getCell(i).alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                }
            }
            worksheet.mergeCells(rowIndex, 7, rowIndex, 10);
            rowIndex = 2;

            const headers = [
                'SUPERVISOR / ANALISTA', 'HORA INGRESO', 'FURGON', 'INICIO TURNO',
                'Break1', '30 MIN COLACI√ìN', '60 MIN COLACI√ìN', 'Break2', 'TERMINO TURNO', 'HORA SALIDA'
            ];

            // Process different categories
            rowIndex = createHeaderRow(rowIndex, 'SUPERVISOR / ANALISTA', 
                { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF104862' } }, headers);
            const supervisores = dayData.filter(row => 
                row['Servicio'] === '10_Staff_Inbound' && row['Estado'] === 'Activo');
            rowIndex = processDataRows(rowIndex, supervisores, worksheet, headers);

            rowIndex = createHeaderRow(rowIndex, 'AGENTE MASIVO', 
                { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F5A87' } }, headers);
            const agentesSite = dayData.filter(row => 
                row['Servicio'] === '01_Masivo' && row['Estado'] === 'Activo' && row['Lugar'] === 'Site');
            rowIndex = processDataRows(rowIndex, agentesSite, worksheet, headers);

            // Teletrabajo section
            const teletrabajoData = dayData.filter(row => 
                row['Servicio'] === '01_Masivo' && row['Estado'] === 'Activo' && row['Lugar'] === 'TT');
            if (teletrabajoData.length > 0) {
                const teletrabajoHeaderRow = worksheet.getRow(rowIndex);
                worksheet.mergeCells(rowIndex, 1, rowIndex, 10);
                const teletrabajoCell = teletrabajoHeaderRow.getCell(1);
                teletrabajoCell.value = 'TELETRABAJO';
                teletrabajoCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF047857' } };
                teletrabajoCell.font = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 };
                teletrabajoCell.alignment = { horizontal: 'center', vertical: 'middle' };
                for (let i = 1; i <= 10; i++) {
                    teletrabajoHeaderRow.getCell(i).border = {
                        top: { style: 'thin' }, left: { style: 'thin' },
                        bottom: { style: 'thin' }, right: { style: 'thin' }
                    };
                }
                rowIndex++;
                rowIndex = processDataRows(rowIndex, teletrabajoData, worksheet, headers);
            }

            // Inactive agents
            const inactivos = dayData.filter(row => row['Estado'] !== 'Activo');
            if (inactivos.length > 0) {
                const inactivosHeaderRow = worksheet.getRow(rowIndex);
                worksheet.mergeCells(rowIndex, 1, rowIndex, 10);
                const mainInactiveCell = inactivosHeaderRow.getCell(1);
                mainInactiveCell.value = 'INACTIVO';
                mainInactiveCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };
                mainInactiveCell.font = { color: { argb: 'FF000000' }, bold: true, name: 'Calibri', size: 11 };
                mainInactiveCell.alignment = { horizontal: 'center', vertical: 'middle' };
                for (let i = 1; i <= 10; i++) {
                    inactivosHeaderRow.getCell(i).border = {
                        top: { style: 'thin' }, left: { style: 'thin' },
                        bottom: { style: 'thin' }, right: { style: 'thin' }
                    };
                }
                rowIndex++;
                rowIndex = processInactiveDataRows(rowIndex, inactivos, worksheet, headers);
            }

            // Night shift table (simplified version from original)
            addNightShiftTable(worksheet, dayData, fechaDia);
        }

        function createHeaderRow(rIndex, text, fill, headers) {
            const worksheet = arguments[4] || null; // Get worksheet if passed
            const row = worksheet ? worksheet.getRow(rIndex) : null;
            
            if (row) {
                headers.forEach((header, index) => {
                    const cell = row.getCell(1 + index);
                    cell.value = index === 0 ? text : header;
                    cell.fill = fill;
                    cell.font = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 };
                    cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                    cell.border = {
                        top: { style: 'thin' }, left: { style: 'thin' },
                        bottom: { style: 'thin' }, right: { style: 'thin' }
                    };
                });
            }
            return rIndex + 1;
        }

        function processDataRows(rIndex, data, worksheet, headers) {
            data.sort((a, b) => {
                const startTimeA = new Date(a['Ini']);
                const startTimeB = new Date(b['Ini']);
                if (startTimeA - startTimeB !== 0) return startTimeA - startTimeB;
                const endTimeA = new Date(a['FIN']);
                const endTimeB = new Date(b['FIN']);
                return endTimeA - endTimeB;
            }).forEach(rowData => {
                const row = worksheet.getRow(rIndex);
                row.getCell(1).value = rowData['Nombre'] || '';

                const iniCell = row.getCell(4);
                iniCell.value = formatTime(rowData['Ini']);
                iniCell.font = { name: 'Calibri', size: 11, bold: true };

                row.getCell(6).value = rowData['Dur_ Colac'] === 30 ? '30' : 'X';
                row.getCell(7).value = rowData['Dur_ Colac'] === 60 ? '60' : 'X';

                const finCell = row.getCell(9);
                finCell.value = formatTime(rowData['FIN']);
                finCell.font = { name: 'Calibri', size: 11, bold: true };

                for (let i = 0; i < 10; i++) {
                    const cell = row.getCell(1 + i);
                    cell.border = {
                        top: { style: 'thin' }, left: { style: 'thin' },
                        bottom: { style: 'thin' }, right: { style: 'thin' }
                    };
                    if (!cell.font) cell.font = { name: 'Calibri', size: 11 };
                    if (i > 0) cell.alignment = { horizontal: 'center', vertical: 'middle' };
                }
                rIndex++;
            });
            return rIndex;
        }

        function processInactiveDataRows(rIndex, data, worksheet, headers) {
            data.sort((a, b) => {
                const startTimeA = new Date(a['Ini']);
                const startTimeB = new Date(b['Ini']);
                if (startTimeA - startTimeB !== 0) return startTimeA - startTimeB;
                const endTimeA = new Date(a['FIN']);
                const endTimeB = new Date(b['FIN']);
                return endTimeA - endTimeB;
            }).forEach(rowData => {
                const row = worksheet.getRow(rIndex);
                row.getCell(1).value = rowData['Nombre'] || '';

                const iniCell = row.getCell(4);
                iniCell.value = formatTime(rowData['Ini']);
                iniCell.font = { name: 'Calibri', size: 11, bold: true };

                const finCell = row.getCell(9);
                finCell.value = formatTime(rowData['FIN']);
                finCell.font = { name: 'Calibri', size: 11, bold: true };

                row.getCell(6).value = 'X';
                row.getCell(7).value = 'X';

                for (let i = 0; i < 10; i++) {
                    const cell = row.getCell(1 + i);
                    if (!cell.value && cell.value !== 0) cell.value = '';
                    cell.border = {
                        top: { style: 'thin' }, left: { style: 'thin' },
                        bottom: { style: 'thin' }, right: { style: 'thin' }
                    };
                    if (!cell.font) cell.font = { name: 'Calibri', size: 11 };
                    if (i !== 0) cell.alignment = { horizontal: 'center', vertical: 'middle' };
                }
                rIndex++;
            });
            return rIndex;
        }

        function addNightShiftTable(worksheet, dayData, fechaDia) {
            const nightShiftStartCol = 12;
            worksheet.getColumn(nightShiftStartCol - 1).width = 10;
            worksheet.getColumn(nightShiftStartCol).width = 35;
            worksheet.getColumn(nightShiftStartCol + 1).width = 10;
            worksheet.getColumn(nightShiftStartCol + 2).width = 10;
            worksheet.getColumn(nightShiftStartCol + 3).width = 10;
            worksheet.getColumn(nightShiftStartCol + 4).width = 10;

            const nightShiftAgents = dayData.filter(row => {
                if (!row['Ini'] || typeof row['Ini'].getHours !== 'function') return false;
                const d = new Date(row['Ini']);
                return d.getHours() === 0 && d.getMinutes() === 0;
            });

            if (nightShiftAgents.length > 0) {
                const headerRowIndex1 = 1;
                const headerRowIndex2 = 2;
                const headerRow1 = worksheet.getRow(headerRowIndex1);
                const headerRow2 = worksheet.getRow(headerRowIndex2);

                const headerFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F5A87' } };
                const headerFont = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 };
                const border = {
                    top: { style: 'thin' }, left: { style: 'thin' },
                    bottom: { style: 'thin' }, right: { style: 'thin' }
                };

                const mainHeaderCell = headerRow1.getCell(nightShiftStartCol);
                const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                const d = new Date(fechaDia);
                const formattedDateHeader = `Turno de madrugada ${days[d.getDay()]} ${d.getDate()} de ${months[d.getMonth()]} del ${d.getFullYear()}`;
                mainHeaderCell.value = formattedDateHeader;

                mainHeaderCell.fill = headerFill;
                mainHeaderCell.font = headerFont;
                mainHeaderCell.alignment = { horizontal: 'center', vertical: 'middle' };
                worksheet.mergeCells(headerRowIndex1, nightShiftStartCol, headerRowIndex1, nightShiftStartCol + 4);
                for (let i = 0; i < 5; i++) headerRow1.getCell(nightShiftStartCol + i).border = border;

                const headers2 = ['Nombre', 'Break 1', 'Colaci√≥n 30', 'Colaci√≥n 60', 'Break 2'];
                headers2.forEach((header, index) => {
                    const cell = headerRow2.getCell(nightShiftStartCol + index);
                    cell.value = header;
                    cell.fill = headerFill;
                    cell.font = headerFont;
                    cell.border = border;
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                });

                let dataRowIndex = headerRowIndex2 + 1;
                nightShiftAgents.forEach(rowData => {
                    const row = worksheet.getRow(dataRowIndex);
                    row.getCell(nightShiftStartCol).value = rowData['Nombre'] || '';
                    row.getCell(nightShiftStartCol + 2).value = rowData['Dur_ Colac'] === 30 ? 30 : 'X';
                    row.getCell(nightShiftStartCol + 3).value = rowData['Dur_ Colac'] === 60 ? 60 : 'X';

                    for (let i = 0; i < 5; i++) {
                        const cell = row.getCell(nightShiftStartCol + i);
                        cell.border = border;
                        cell.font = { name: 'Calibri', size: 11 };
                        cell.alignment = { horizontal: i === 0 ? 'left' : 'center', vertical: 'middle' };
                    }
                    dataRowIndex++;
                });
            }
        }

        async function downloadExcel() {
            if (generatedWorkbook && fileName) {
                const buffer = await generatedWorkbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        function formatTime(date) {
            if (!date || typeof date.getHours !== 'function') return '';
            const d = new Date(date);
            return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        function formatDate(date) {
            if (!date) return '';
            const d = new Date(date);
            const days = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
            const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
            return `${days[d.getDay()]}, ${d.getDate()} de ${months[d.getMonth()]} del ${d.getFullYear()}`;
        }

        function isLibre(row) {
            const ini = row['Ini'];
            return typeof ini === 'string' && ini.toUpperCase().includes('LIBRE');
        }

        function showStatus(message, type) {
            statusMessage.className = `status-message ${type}`;
            statusMessage.textContent = message;
            setTimeout(() => {
                statusMessage.className = 'status-message';
            }, 4000);
        }
    </script>
</body>
</html></template>
  <template id="mod-turnos"><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestiones Inbound - Generador de Turnos</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%236a11cb' d='M50 0 L100 25 L100 75 L50 100 L0 75 L0 25 Z'%3E%3C/path%3E%3Cpath fill='%23ffffff' d='M50 20 L75 35 L75 65 L50 80 L25 65 L25 35 Z'%3E%3C/path%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #f4f7fe;
            --color-surface: #ffffff;
            --color-primary-start: #6a11cb;
            --color-primary-end: #2575fc;
            --color-success-start: #16a34a;
            --color-success-end: #15803d;
            --color-text: #1e293b;
            --color-text-secondary: #64748b;
            --color-border: #e2e8f0;
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            --font-family: 'Manrope', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family); background-color: var(--color-bg); min-height: 100vh;
            display: flex; justify-content: center; align-items: center; padding: 20px;
            color: var(--color-text); position: relative; overflow: hidden;
        }
        .main-container {
            display: grid; grid-template-columns: 1fr; max-width: 1000px; width: 100%;
            background: var(--color-surface); border-radius: 24px; box-shadow: var(--shadow-lg);
            border: 1px solid white; overflow: hidden; z-index: 10;
        }
        @media (min-width: 800px) { .main-container { grid-template-columns: 40% 60%; } }
        .illustration-panel {
            background: linear-gradient(160deg, #f0f5ff, #e6efff); padding: 40px;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .excel-animation {
            width: 250px; height: 200px; background-color: #fff; border-radius: 8px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2); padding: 10px; display: flex;
            flex-direction: column; gap: 8px; transform: perspective(800px) rotateX(15deg) rotateY(-25deg);
        }
        .excel-header { width: 100%; height: 20px; background-color: #eef2f9; border-radius: 4px; }
        .excel-row { display: flex; gap: 8px; }
        .excel-cell { flex-grow: 1; height: 20px; background-color: #f8fafc; border-radius: 4px; position: relative; overflow: hidden; animation: cellPulse 2.5s ease-in-out infinite alternate; }
        .excel-cell::after { content: ''; position: absolute; top: 0; left: 0; height: 100%; background-image: linear-gradient(90deg, var(--color-primary-start), var(--color-primary-end)); border-radius: 4px; animation: fillBar 2.5s ease-in-out infinite alternate; }
        @keyframes cellPulse { from { opacity: 0.4; } to { opacity: 1; } }
        @keyframes fillBar { from { width: 20%; } to { width: 100%; } }
        .illustration-panel h2 { margin-top: 20px; font-size: 22px; color: var(--color-text); }
        .illustration-panel p { margin-top: 8px; font-size: 15px; color: var(--color-text-secondary); max-width: 300px; line-height: 1.6; }
        .content-panel { padding: 40px; }
        .header { text-align: center; margin-bottom: 30px; }
        h1 { color: var(--color-text); font-size: 28px; font-weight: 700; }
        .upload-area {
            border: 2px dashed var(--color-border); border-radius: 12px; padding: 40px 20px;
            text-align: center; transition: all 0.3s ease; cursor: pointer; background-color: #fafbff;
        }
        .upload-area:hover, .upload-area.dragover { border-color: var(--color-primary-end); background: #f7faff; transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(37, 117, 252, 0.1); }
        .upload-icon { width: 48px; height: 48px; margin: 0 auto 15px; background: linear-gradient(45deg, var(--color-primary-start), var(--color-primary-end)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease; }
        .upload-area:hover .upload-icon { transform: scale(1.1) rotate(10deg); }
        .upload-text { color: var(--color-text); font-size: 16px; font-weight: 600; }
        input[type="file"] { display: none; }
        .button-container { text-align: center; margin-top: 25px; }
        .button { background-image: linear-gradient(45deg, var(--color-primary-start) 0%, var(--color-primary-end) 100%); color: white; border: none; padding: 14px 35px; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 10px; }
        .button:hover { transform: translateY(-3px); box-shadow: 0 7px 20px rgba(106, 17, 203, 0.3); }
        .button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #downloadBtn { display: none; background-image: linear-gradient(45deg, var(--color-success-start) 0%, var(--color-success-end) 100%); }
        #downloadBtn:hover { box-shadow: 0 7px 20px rgba(22, 163, 74, 0.3); }
        .button-icon { width: 20px; height: 20px; }
        .file-info { background: #f8faff; padding: 15px; border-radius: 10px; margin-top: 20px; display: none; animation: fadeIn 0.5s; }
        .file-info.active { display: block; }
        .progress-bar { width: 100%; height: 8px; background: var(--color-border); border-radius: 4px; margin-top: 20px; overflow: hidden; display: none; }
        .progress-bar.active { display: block; }
        .progress-fill { height: 100%; background: linear-gradient(45deg, var(--color-primary-start), var(--color-primary-end)); border-radius: 4px; width: 0%; transition: width 0.3s ease; }
        .status-message { text-align: center; margin-top: 20px; padding: 15px; border-radius: 10px; display: none; animation: slideDown 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status-message.success { background: #e6f7f0; color: #0d8a54; display: block; }
        .status-message.error { background: #fdeaea; color: #d92d20; display: block; }
        #weekSelectorContainer { display: none; margin-top: 20px; animation: fadeIn 0.5s; position: relative; }
        #weekSelectorContainer label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--color-text-secondary); }
        .custom-select-wrapper { position: relative; }
        .custom-select-trigger { width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--color-border); background-color: #f8fafc; font-family: var(--font-family); font-size: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; }
        .custom-select-trigger:hover { border-color: var(--color-primary-end); }
        .custom-select-trigger::after { content: '‚ñº'; font-size: 12px; color: var(--color-text-secondary); transition: transform 0.3s ease; }
        .custom-select-wrapper.open .custom-select-trigger::after { transform: rotate(180deg); }
        .custom-options { position: absolute; top: 105%; left: 0; right: 0; background: var(--color-surface); border-radius: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); z-index: 100; max-height: 200px; overflow-y: auto; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; }
        .custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-option { padding: 12px 15px; cursor: pointer; transition: background-color 0.2s ease; border-bottom: 1px solid var(--color-border); }
        .custom-option:last-child { border-bottom: none; }
        .custom-option:hover { background-color: #f4f7fe; }
        .custom-option.selected { background-color: #eef2ff; font-weight: 600; color: var(--color-primary-end); }
        #weekSelector { display: none; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
</head>
<body>
    <div class="main-container">
        <div class="illustration-panel">
            <div class="excel-animation">
                <div class="excel-header"></div>
                <div class="excel-row"><div class="excel-cell" style="animation-delay: 0.2s;"></div><div class="excel-cell" style="animation-delay: 0.5s;"></div></div>
            </div>
            <h2>Gu√≠a R√°pida</h2>
            <p>Sube tu archivo Excel con los datos de turnos, selecciona una de las √∫ltimas 4 semanas disponibles y genera tu informe.</p>
        </div>
        <div class="content-panel">
            <div class="header"><h1>Generador de Turnos Diarios Inbound</h1></div>
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".xlsx,.xls, .csv">
                <div class="upload-icon"><svg xmlns="http://www.w3.org/2000/svg" class="button-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg></div>
                <div class="upload-text">Haz clic para seleccionar o arrastra tu archivo</div>
            </div>
            <div class="file-info" id="fileInfo"><span id="fileNameText"></span></div>

            <div id="weekSelectorContainer">
                <label for="weekSelector">2. Selecciona la semana a generar</label>
                <div class="custom-select-wrapper" id="customSelect">
                    <select id="weekSelector"></select>
                    <div class="custom-select-trigger" id="customSelectTrigger">-- Esperando archivo --</div>
                    <div class="custom-options" id="customOptions"></div>
                </div>
            </div>
            
            <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
            <div class="button-container">
                <button class="button" id="generateBtn" disabled>Generar Excel</button>
                <button class="button" id="downloadBtn">Descargar Excel</button>
            </div>
            <div class="status-message" id="statusMessage"></div>
        </div>
    </div>
    
    <script>
        let allData = null, turnosData = null, generatedWorkbook = null, fileName = '';
        
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileNameEl = document.getElementById('fileNameText');
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const statusMessage = document.getElementById('statusMessage');
        const weekSelectorContainer = document.getElementById('weekSelectorContainer');
        const weekSelector = document.getElementById('weekSelector');
        const customSelect = document.getElementById('customSelect');
        const customSelectTrigger = document.getElementById('customSelectTrigger');
        const customOptions = document.getElementById('customOptions');

        customSelectTrigger.addEventListener('click', () => customSelect.classList.toggle('open'));
        window.addEventListener('click', (e) => { if (!customSelect.contains(e.target)) customSelect.classList.remove('open'); });

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });
        
        function handleFile(file) {
            fileNameEl.textContent = file.name;
            fileInfo.classList.add('active');
            generateBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    allData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    populateWeekSelector(allData);
                    weekSelectorContainer.style.display = 'block';
                    showStatus('Archivo cargado. Por favor, selecciona una semana.', 'success');
                } catch(error) {
                    showStatus('Error al leer el archivo. Aseg√∫rate que sea un Excel v√°lido.', 'error');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        weekSelector.addEventListener('change', handleWeekSelection);

        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            monday.setHours(0, 0, 0, 0);
            return monday;
        }

        function populateWeekSelector(data) {
            const weekSet = new Set();
            data.forEach(row => {
                if (row.Fecha) weekSet.add(getMonday(row.Fecha).toISOString());
            });

            const sortedWeeks = Array.from(weekSet).sort((a, b) => new Date(b) - new Date(a));
            const last4Weeks = sortedWeeks.slice(0, 4); 

            weekSelector.innerHTML = '';
            customOptions.innerHTML = '';
            customSelectTrigger.textContent = '-- Selecciona una semana --';
            
            last4Weeks.forEach(mondayISO => {
                const monday = new Date(mondayISO);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                
                const monthName = sunday.toLocaleString('es-ES', { month: 'long' });
                const optionText = `Semana ${monday.getDate()} al ${sunday.getDate()} de ${monthName}`;
                
                const option = document.createElement('option');
                option.value = mondayISO;
                option.textContent = optionText;
                weekSelector.appendChild(option);

                const customOption = document.createElement('div');
                customOption.classList.add('custom-option');
                customOption.textContent = optionText;
                customOption.dataset.value = mondayISO;

                customOption.addEventListener('click', () => {
                    customSelectTrigger.textContent = customOption.textContent;
                    weekSelector.value = customOption.dataset.value;
                    weekSelector.dispatchEvent(new Event('change'));
                    document.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
                    customOption.classList.add('selected');
                    customSelect.classList.remove('open');
                });
                customOptions.appendChild(customOption);
            });
        }

        function handleWeekSelection(event) {
            const selectedMondayISO = event.target.value;
            if (!selectedMondayISO) {
                turnosData = null;
                generateBtn.disabled = true;
                return;
            }
            const selectedMonday = new Date(selectedMondayISO);
            const nextMonday = new Date(selectedMonday);
            nextMonday.setDate(selectedMonday.getDate() + 7);
            turnosData = allData.filter(row => {
                const rowDate = new Date(row.Fecha);
                return rowDate >= selectedMonday && rowDate < nextMonday;
            });
            generateBtn.disabled = false;
        }

        generateBtn.addEventListener('click', generateExcel);
        
        async function generateExcel() {
            if (!turnosData || turnosData.length === 0) {
                showStatus('No hay datos v√°lidos para procesar en la semana seleccionada.', 'error');
                return;
            }
            progressBar.classList.add('active');
            let progress = 0;
            const progressInterval = setInterval(() => { progress += 10; progressFill.style.width = progress + '%'; if (progress >= 100) clearInterval(progressInterval); }, 100);
            setTimeout(async () => {
                await createExcelWorkbookWithStyles();
                progressBar.classList.remove('active'); progressFill.style.width = '0%';
                if (fileName) { 
                    showStatus('Excel generado correctamente', 'success');
                    generateBtn.style.display = 'none'; downloadBtn.style.display = 'inline-flex';
                }
            }, 1500);
        }
        
        async function createExcelWorkbookWithStyles() {
            fileName = ''; 
            const workbook = new ExcelJS.Workbook();
            const sheetNames = ['Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sabado', 'Domingo'];
            const jsDayToSheetIndex = [6, 0, 1, 2, 3, 4, 5]; 

            let minDate = null, maxDate = null;
            
            sheetNames.forEach((sheetName, index) => {
                const dayOfWeekToFind = jsDayToSheetIndex.indexOf(index);
                const dayData = turnosData.filter(row => {
                    if (isLibre(row) || !row.Fecha) return false;
                    const rowDate = new Date(row.Fecha);
                    return rowDate.getDay() === dayOfWeekToFind;
                });
                
                if (dayData.length > 0) {
                    const fechaDia = dayData[0]['Fecha'];
                    if (!minDate || new Date(fechaDia) < new Date(minDate)) minDate = fechaDia;
                    if (!maxDate || new Date(fechaDia) > new Date(maxDate)) maxDate = fechaDia;
                    
                    const worksheet = workbook.addWorksheet(sheetName);
                    createStyledSheet(worksheet, dayData, fechaDia);
                }
            });

            if (minDate && maxDate) {
                const d1 = new Date(minDate), d2 = new Date(maxDate);
                const day1 = String(d1.getDate()).padStart(2, '0'), day2 = String(d2.getDate()).padStart(2, '0');
                const monthName = d1.toLocaleString('es-ES', { month: 'long' });
                fileName = `Turno diario semana del ${day1} al ${day2} de ${monthName} ${d1.getFullYear()}.xlsx`;
            } else {
                showStatus('No se encontraron turnos v√°lidos con fechas asignables a LUN-DOM para la semana seleccionada.', 'error');
            }
            generatedWorkbook = workbook;
        }
        
        function createStyledSheet(worksheet, dayData, fechaDia) {
            worksheet.columns = [ { width: 39.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10.5 }, { width: 10 } ];
            
            let rowIndex = 1;
            const fechaRow = worksheet.getRow(rowIndex);
            fechaRow.getCell(1).value = 'FECHA';
            fechaRow.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0B3041' } };
            fechaRow.getCell(1).font = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 };
            fechaRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            fechaRow.getCell(2).value = formatDate(fechaDia);
            worksheet.mergeCells(rowIndex, 2, rowIndex, 4);
            fechaRow.getCell(5).value = 'Permanencia';
            worksheet.mergeCells(rowIndex, 5, rowIndex, 6);
            fechaRow.getCell(5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0B3041' } };
            fechaRow.getCell(5).font = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 };
            fechaRow.getCell(5).alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
            for (let i = 1; i <= 10; i++) { fechaRow.getCell(i).border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } }; if (i !== 1 && i !== 5) { fechaRow.getCell(i).alignment = { horizontal: 'center', vertical: 'middle', wrapText: true }; } }
            worksheet.mergeCells(rowIndex, 7, rowIndex, 10);
            rowIndex = 2;
            const headers = ['SUPERVISOR / ANALISTA', 'HORA INGRESO', 'FURGON', 'INICIO TURNO', 'Break1', '30 MIN COLACI√ìN', '60 MIN COLACI√ìN', 'Break2', 'TERMINO TURNO', 'HORA SALIDA'];
            
            const processDataRows = (rIndex, data, startCol = 1) => { 
                data.sort((a, b) => {
                    const startTimeA = new Date(a['Ini']);
                    const startTimeB = new Date(b['Ini']);
                    if (startTimeA - startTimeB !== 0) return startTimeA - startTimeB;
                    const endTimeA = new Date(a['FIN']);
                    const endTimeB = new Date(b['FIN']);
                    return endTimeA - endTimeB;
                }).forEach(rowData => { 
                    const row = worksheet.getRow(rIndex); 
                    row.getCell(startCol).value = rowData['Nombre'] || ''; 
                    
                    const iniCell = row.getCell(startCol + 3);
                    iniCell.value = formatTime(rowData['Ini']); 
                    iniCell.font = { name: 'Calibri', size: 11, bold: true };
                    
                    row.getCell(startCol + 5).value = rowData['Dur_ Colac'] === 30 ? '30' : 'X'; 
                    row.getCell(startCol + 6).value = rowData['Dur_ Colac'] === 60 ? '60' : 'X'; 
                    
                    const finCell = row.getCell(startCol + 8);
                    finCell.value = formatTime(rowData['FIN']); 
                    finCell.font = { name: 'Calibri', size: 11, bold: true };
                    
                    for (let i = 0; i < 10; i++) { 
                        const cell = row.getCell(startCol + i);
                        cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } }; 
                        if (!cell.font) cell.font = { name: 'Calibri', size: 11 }; 
                        if (i > 0) cell.alignment = { horizontal: 'center', vertical: 'middle' }; 
                    } 
                    rIndex++; 
                }); 
                return rIndex; 
            };

            const processInactiveDataRows = (rIndex, data, startCol = 1) => {
                data.sort((a, b) => {
                    const startTimeA = new Date(a['Ini']);
                    const startTimeB = new Date(b['Ini']);
                    if (startTimeA - startTimeB !== 0) return startTimeA - startTimeB;
                    const endTimeA = new Date(a['FIN']);
                    const endTimeB = new Date(b['FIN']);
                    return endTimeA - endTimeB;
                }).forEach(rowData => {
                    const row = worksheet.getRow(rIndex);
                    row.getCell(startCol).value = rowData['Nombre'] || '';
                    
                    const iniCell = row.getCell(startCol + 3);
                    iniCell.value = formatTime(rowData['Ini']); // <-- CORRECCI√ìN AQU√ç
                    iniCell.font = { name: 'Calibri', size: 11, bold: true };
                    
                    const finCell = row.getCell(startCol + 8);
                    finCell.value = formatTime(rowData['FIN']); // <-- CORRECCI√ìN AQU√ç
                    finCell.font = { name: 'Calibri', size: 11, bold: true };

                    row.getCell(startCol + 5).value = 'X';
                    row.getCell(startCol + 6).value = 'X';
                    
                    for (let i = 0; i < 10; i++) {
                        const cell = row.getCell(startCol + i);
                        if (!cell.value && cell.value !== 0) cell.value = '';
                        cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                        if (!cell.font) cell.font = { name: 'Calibri', size: 11 };
                        if (i !== 0) cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    }
                    rIndex++;
                });
                return rIndex;
            };

            const createHeaderRow = (rIndex, text, fill, startCol = 1) => { 
                const row = worksheet.getRow(rIndex); 
                headers.forEach((header, index) => { 
                    const cell = row.getCell(startCol + index); 
                    cell.value = index === 0 ? text : header; 
                    cell.fill = fill; 
                    cell.font = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 }; 
                    cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true }; 
                    cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } }; 
                }); 
                return rIndex + 1; 
            };
            
            rowIndex = createHeaderRow(rowIndex, 'SUPERVISOR / ANALISTA', { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF104862' } });
            const supervisores = dayData.filter(row => row['Servicio'] === '10_Staff_Inbound' && row['Estado'] === 'Activo');
            rowIndex = processDataRows(rowIndex, supervisores);
            rowIndex = createHeaderRow(rowIndex, 'AGENTE MASIVO', { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F5A87' } });
            const agentesSite = dayData.filter(row => row['Servicio'] === '01_Masivo' && row['Estado'] === 'Activo' && row['Lugar'] === 'Site');
            rowIndex = processDataRows(rowIndex, agentesSite);
            
            const teletrabajoData = dayData.filter(row => row['Servicio'] === '01_Masivo' && row['Estado'] === 'Activo' && row['Lugar'] === 'TT');
            if (teletrabajoData.length > 0) {
                const teletrabajoHeaderRow = worksheet.getRow(rowIndex);
                worksheet.mergeCells(rowIndex, 1, rowIndex, 10);
                const teletrabajoCell = teletrabajoHeaderRow.getCell(1);
                teletrabajoCell.value = 'TELETRABAJO';
                teletrabajoCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF047857' } };
                teletrabajoCell.font = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 };
                teletrabajoCell.alignment = { horizontal: 'center', vertical: 'middle' };
                for(let i=1; i<=10; i++) teletrabajoHeaderRow.getCell(i).border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                rowIndex++;
                rowIndex = processDataRows(rowIndex, teletrabajoData);
            }
            
            const inactivos = dayData.filter(row => row['Estado'] !== 'Activo');
            if (inactivos.length > 0) {
                const yellowFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFF00' } };
                const blackFont = { color: { argb: 'FF000000' }, bold: true, name: 'Calibri', size: 11 };
                const border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                const inactivosHeaderRow = worksheet.getRow(rowIndex);
                worksheet.mergeCells(rowIndex, 1, rowIndex, 10);
                const mainInactiveCell = inactivosHeaderRow.getCell(1);
                mainInactiveCell.value = 'INACTIVO';
                mainInactiveCell.fill = yellowFill;
                mainInactiveCell.font = blackFont;
                mainInactiveCell.alignment = { horizontal: 'center', vertical: 'middle' };
                for(let i=1; i<=10; i++) inactivosHeaderRow.getCell(i).border = border;
                rowIndex++;
                rowIndex = processInactiveDataRows(rowIndex, inactivos);
            }

            // --- START: Turno de Madrugada Table (Simple) ---
            const nightShiftStartCol = 12; // Start in column L
            worksheet.getColumn(nightShiftStartCol - 1).width = 10; // Spacer K

            worksheet.getColumn(nightShiftStartCol).width = 35;      // L - Nombre
            worksheet.getColumn(nightShiftStartCol + 1).width = 10; // M - Break 1
            worksheet.getColumn(nightShiftStartCol + 2).width = 10; // N - Colaci√≥n 30
            worksheet.getColumn(nightShiftStartCol + 3).width = 10; // O - Colaci√≥n 60
            worksheet.getColumn(nightShiftStartCol + 4).width = 10; // P - Break 2

            const nightShiftAgents = dayData.filter(row => {
                if (!row['Ini'] || typeof row['Ini'].getHours !== 'function') return false;
                const d = new Date(row['Ini']);
                return d.getHours() === 0 && d.getMinutes() === 0;
            });

            if (nightShiftAgents.length > 0) {
                const headerRowIndex1 = 1;
                const headerRowIndex2 = 2;
                const headerRow1 = worksheet.getRow(headerRowIndex1);
                const headerRow2 = worksheet.getRow(headerRowIndex2);
                
                const headerFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F5A87' } };
                const headerFont = { color: { argb: 'FFFFFFFF' }, bold: true, name: 'Calibri', size: 11 };
                const border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                const mainHeaderCell = headerRow1.getCell(nightShiftStartCol);
                const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                const d = new Date(fechaDia);
                const formattedDateHeader = `Turno de madrugada ${days[d.getDay()]} ${d.getDate()} de ${months[d.getMonth()]} del ${d.getFullYear()}`;
                mainHeaderCell.value = formattedDateHeader;

                mainHeaderCell.fill = headerFill;
                mainHeaderCell.font = headerFont;
                mainHeaderCell.alignment = { horizontal: 'center', vertical: 'middle' };
                worksheet.mergeCells(headerRowIndex1, nightShiftStartCol, headerRowIndex1, nightShiftStartCol + 4);
                for (let i = 0; i < 5; i++) headerRow1.getCell(nightShiftStartCol + i).border = border;

                const headers2 = ['Nombre', 'Break 1', 'Colaci√≥n 30', 'Colaci√≥n 60', 'Break 2'];
                headers2.forEach((header, index) => {
                    const cell = headerRow2.getCell(nightShiftStartCol + index);
                    cell.value = header;
                    cell.fill = headerFill;
                    cell.font = headerFont;
                    cell.border = border;
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                });

                let dataRowIndex = headerRowIndex2 + 1;
                nightShiftAgents.forEach(rowData => {
                    const row = worksheet.getRow(dataRowIndex);
                    row.getCell(nightShiftStartCol).value = rowData['Nombre'] || '';
                    row.getCell(nightShiftStartCol + 2).value = rowData['Dur_ Colac'] === 30 ? 30 : 'X';
                    row.getCell(nightShiftStartCol + 3).value = rowData['Dur_ Colac'] === 60 ? 60 : 'X';

                    for (let i = 0; i < 5; i++) {
                        const cell = row.getCell(nightShiftStartCol + i);
                        cell.border = border;
                        cell.font = { name: 'Calibri', size: 11 };
                        cell.alignment = { horizontal: i === 0 ? 'left' : 'center', vertical: 'middle' };
                    }
                    dataRowIndex++;
                });
            }
        }

        function formatTime(date) { if (!date || typeof date.getHours !== 'function') return ''; const d = new Date(date); return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`; }
        function formatDate(date) { if (!date) return ''; const d = new Date(date); const days = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado']; const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre']; return `${days[d.getDay()]}, ${d.getDate()} de ${months[d.getMonth()]} del ${d.getFullYear()}`; }
        function isLibre(row) { const ini = row['Ini']; return typeof ini === 'string' && ini.toUpperCase().includes('LIBRE'); }
        function areSameDay(date1, date2) { const d1 = new Date(date1); const d2 = new Date(date2); return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate(); }
        downloadBtn.addEventListener('click', async () => { if (generatedWorkbook && fileName) { const buffer = await generatedWorkbook.xlsx.writeBuffer(); const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fileName; a.click(); URL.revokeObjectURL(url); } });
        function showStatus(message, type) { statusMessage.className = `status-message ${type}`; statusMessage.textContent = message; setTimeout(() => { statusMessage.className = 'status-message'; }, 4000); }
    </script>
</body>
</html></template>
  <template id="mod-cartas"><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Cartas Corporativas</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #f4f7fe;
            --color-surface: #ffffff;
            --color-primary-start: #6a11cb;
            --color-primary-end: #2575fc;
            --color-success-start: #16a34a;
            --color-success-end: #15803d;
            --color-text: #1e293b;
            --color-text-secondary: #64748b;
            --color-border: #e2e8f0;
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            --font-family: 'Manrope', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family); background-color: var(--color-bg); min-height: 100vh;
            display: flex; justify-content: center; align-items: center; padding: 20px;
            color: var(--color-text); position: relative; overflow: hidden;
        }
        .main-container {
            display: grid; grid-template-columns: 1fr; max-width: 1000px; width: 100%;
            background: var(--color-surface); border-radius: 24px; box-shadow: var(--shadow-lg);
            border: 1px solid white; overflow: hidden; z-index: 10;
        }
        @media (min-width: 800px) { .main-container { grid-template-columns: 40% 60%; } }
        .illustration-panel {
            background: linear-gradient(160deg, #f0f5ff, #e6efff); padding: 40px;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        /* Nueva animaci√≥n de Documento Word */
        .doc-animation {
            width: 200px;
            height: 220px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.2);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transform: perspective(800px) rotateX(10deg) rotateY(-20deg);
            border-top: 25px solid #2b579a; /* Barra azul de Word */
        }
        .doc-line {
            height: 8px;
            background-color: #eef2f9;
            border-radius: 4px;
            opacity: 0;
            animation: writeLine 6s ease-out infinite;
        }
        .doc-line.short { width: 60%; }
        .doc-line.medium { width: 85%; }
        .doc-line.long { width: 100%; }

        /* Keyframes para la animaci√≥n de escritura */
        @keyframes writeLine {
            0% { width: 0%; opacity: 1; }
            80% { width: var(--final-width, 100%); opacity: 1; }
            100% { width: var(--final-width, 100%); opacity: 1; }
        }
        
        .doc-line:nth-child(1) { --final-width: 90%; animation-delay: 0s; }
        .doc-line:nth-child(2) { --final-width: 100%; animation-delay: 0.5s; }
        .doc-line:nth-child(3) { --final-width: 60%; animation-delay: 1s; }
        .doc-line:nth-child(4) { --final-width: 80%; animation-delay: 1.5s; }
        .doc-line:nth-child(5) { --final-width: 95%; animation-delay: 2s; }
        .doc-line:nth-child(6) { --final-width: 70%; animation-delay: 2.5s; }

        .illustration-panel h2 { margin-top: 20px; font-size: 22px; color: var(--color-text); }
        .illustration-panel p { margin-top: 8px; font-size: 15px; color: var(--color-text-secondary); max-width: 300px; line-height: 1.6; }
        .content-panel { padding: 40px; }
        .header { text-align: center; margin-bottom: 30px; }
        h1 { color: var(--color-text); font-size: 28px; font-weight: 700; }
        .upload-area {
            border: 2px dashed var(--color-border); border-radius: 12px; padding: 40px 20px;
            text-align: center; transition: all 0.3s ease; cursor: pointer; background-color: #fafbff;
        }
        .upload-area:hover, .upload-area.dragover { border-color: var(--color-primary-end); background: #f7faff; transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(37, 117, 252, 0.1); }
        .upload-icon { width: 48px; height: 48px; margin: 0 auto 15px; background: linear-gradient(45deg, var(--color-primary-start), var(--color-primary-end)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease; }
        .upload-area:hover .upload-icon { transform: scale(1.1) rotate(10deg); }
        .upload-text { color: var(--color-text); font-size: 16px; font-weight: 600; }
        input[type="file"] { display: none; }
        .button { background-image: linear-gradient(45deg, var(--color-primary-start) 0%, var(--color-primary-end) 100%); color: white; border: none; padding: 14px 35px; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 10px; width: 100%; justify-content: center; margin-top: 15px; }
        .button:hover { transform: translateY(-3px); box-shadow: 0 7px 20px rgba(106, 17, 203, 0.3); }
        .button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .status { margin-top: 20px; padding: 15px; border-radius: 10px; text-align: center; font-weight: 500; display: none; animation: slideDown 0.5s; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status.success { background: #e6f7f0; color: #0d8a54; display: block; }
        .status.error { background: #fdeaea; color: #d92d20; display: block; }
        .status.warning { background: #fffbeb; color: #b45309; display: block; }
        .hidden { display: none; }
        .date-filter-container { background-color: #f8faff; border-radius: 12px; padding: 20px; margin-top: 25px; border: 1px solid var(--color-border); }
        .date-filter-container h3 { text-align: center; margin-bottom: 25px; color: var(--color-text); font-weight: 600; font-size: 18px; }
        .slider-labels { display: flex; justify-content: space-between; margin-top: 10px; font-weight: 600; color: var(--color-text-secondary); font-size: 14px; }
        #date-slider { margin: 25px 10px 15px; }
        /* Estilos para noUiSlider */
        #date-slider .noUi-connect { background: linear-gradient(45deg, var(--color-primary-start), var(--color-primary-end)); }
        #date-slider .noUi-handle { border: 3px solid var(--color-surface); border-radius: 50%; width: 24px; height: 24px; right: -12px; top: -9px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); cursor: pointer; }
        #date-slider .noUi-handle:focus { outline: none; }
        #date-slider .noUi-handle::before, #date-slider .noUi-handle::after { display: none; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="illustration-panel">
            <div class="doc-animation">
                <div class="doc-line"></div>
                <div class="doc-line"></div>
                <div class="doc-line"></div>
                <div class="doc-line"></div>
                <div class="doc-line"></div>
                <div class="doc-line"></div>
            </div>
            <h2>Gu√≠a R√°pida</h2>
            <p>Sube tu archivo Excel con las incidencias, filtra por fecha si es necesario, y genera las cartas de amonestaci√≥n o compromiso en segundos.</p>
        </div>

        <div class="content-panel">
            <div class="header">
                <h1>üè¢ Generador de Cartas</h1>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                <div class="upload-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                </div>
                <div id="uploadText" class="upload-text">Haz clic o arrastra tu archivo Excel</div>
            </div>

            <div class="date-filter-container hidden" id="dateFilterContainer">
                <h3>üìÖ Filtrar por Fecha de Incidencia</h3>
                <div id="date-slider"></div>
                <div class="slider-labels">
                    <span id="slider-start-date"></span>
                    <span id="slider-end-date"></span>
                </div>
            </div>
    
            <button class="button hidden" id="generateBtn">
                <span id="btnText">üöÄ Generar Cartas</span>
            </button>
            
            <div class="status" id="status"></div>
        </div>
    </div>

    <script>
        let fullProcessedData = []; 
        let processedData = []; 
        let dateSlider = null;

        const COLUMN_MAPPING = {
            nombres: ['nombre', 'nombres', 'agente', 'agentes', 'trabajador'],
            rut: ['rut', 'cedula', 'c√©dula', 'ci'],
            fecha: ['fecha', 'date', 'fecha_incidencia'],
            duracion: ['duracion', 'duraci√≥n', 'minutos'],
            inicioTurno: ['inicio turno', 'inicio_turno', 'turno', 'hora inicio'],
            finTurno: ['fin turno', 'fin_turno', 'termino turno', 'hora fin'],
            incidencia: ['incidencia'],
            tipoCarta: ['tipo de carta', 'tipo carta']
        };

        const elements = {
            uploadArea: document.getElementById('uploadArea'),
            fileInput: document.getElementById('fileInput'),
            dateFilterContainer: document.getElementById('dateFilterContainer'),
            dateSlider: document.getElementById('date-slider'),
            sliderStartDate: document.getElementById('slider-start-date'),
            sliderEndDate: document.getElementById('slider-end-date'),
            generateBtn: document.getElementById('generateBtn'),
            btnText: document.getElementById('btnText'),
            status: document.getElementById('status')
        };

        elements.uploadArea.addEventListener('click', () => elements.fileInput.click());
        elements.fileInput.addEventListener('change', handleFileSelect);
        elements.generateBtn.addEventListener('click', generateDocuments);
        
        // Soporte para Drag & Drop
        elements.uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); elements.uploadArea.classList.add('dragover'); });
        elements.uploadArea.addEventListener('dragleave', () => { elements.uploadArea.classList.remove('dragover'); });
        elements.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                elements.fileInput.files = e.dataTransfer.files;
                handleFileSelect({ target: elements.fileInput });
            }
        });

        function showStatus(message, type = 'success') {
            elements.status.className = `status ${type}`;
            elements.status.textContent = message;
            elements.status.style.display = 'block';
        }

        function handleFileSelect(event) {
            fullProcessedData = [];
            processedData = [];
            if(dateSlider) { dateSlider.destroy(); dateSlider = null; }
            elements.dateFilterContainer.classList.add('hidden');
            elements.generateBtn.classList.add('hidden');
            
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('uploadText').textContent = file.name;
            showStatus('Procesando archivo...', 'warning');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: null });
                    processData(rawData);
                } catch (error) {
                    console.error("Error detallado:", error);
                    showStatus('Error al leer el archivo. Verifique que el formato sea correcto.', 'error');
                }
            };
            reader.readAsBinaryString(file);
        }
        
        function parseDate(dateValue) {
            if (!dateValue) return null;
            if (dateValue instanceof Date && !isNaN(dateValue)) return dateValue;
            if (typeof dateValue === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                return new Date(excelEpoch.getTime() + dateValue * 86400000);
            }
            if (typeof dateValue === 'string') {
                let date = new Date(dateValue);
                if (!isNaN(date)) return date;
                if (dateValue.includes('/')) {
                    const parts = dateValue.split('/');
                    if (parts.length === 3) {
                        date = new Date(parts[2], parts[1] - 1, parts[0]);
                        if (!isNaN(date)) return date;
                    }
                }
            }
            return null;
        }

        function formatShiftTime(value) {
            if (value instanceof Date && !isNaN(value)) {
                const hours = value.getHours().toString().padStart(2, '0');
                const minutes = value.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            }
            return value;
        }

        function toProperCase(str) {
            if (!str) return '';
            return str.toString().toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
        
        function processData(data) {
            if (!data || data.length === 0) {
                showStatus('El archivo est√° vac√≠o o no tiene un formato v√°lido.', 'error'); return;
            }
            const headers = Object.keys(data[0]);
            const columnMap = {};
            
            const missingCols = Object.keys(COLUMN_MAPPING).filter(key => {
                const foundHeader = headers.find(h => COLUMN_MAPPING[key].some(alias => h.toLowerCase().includes(alias)));
                if(foundHeader) columnMap[key] = foundHeader;
                return !foundHeader;
            });

            if (missingCols.length > 0) {
                showStatus(`Error: Faltan las siguientes columnas en el archivo: ${missingCols.join(', ')}.`, 'error'); return;
            }

            const allData = data.map(row => ({
                nombres: row[columnMap.nombres] || '',
                rut: row[columnMap.rut] || '',
                fecha: parseDate(row[columnMap.fecha]),
                duracion: row[columnMap.duracion] || '',
                inicioTurno: formatShiftTime(row[columnMap.inicioTurno]) || '00:00',
                finTurno: formatShiftTime(row[columnMap.finTurno]) || '00:00',
                incidencia: (row[columnMap.incidencia] || '').toString().toLowerCase().trim(),
                tipoCarta: (row[columnMap.tipoCarta] || '').toString().toLowerCase().trim()
            })).filter(row => row.nombres && row.rut && row.fecha);

            fullProcessedData = allData.filter(row => {
                const esAtraso = (row.incidencia === 'atraso' || row.incidencia === 'atrasos') && ['amonestacion', 'amonestaci√≥n', 'compromiso'].includes(row.tipoCarta);
                const esAusencia = (row.incidencia === 'ausencia') && ['amonestacion', 'amonestaci√≥n', 'compromiso'].includes(row.tipoCarta);
                const esAbandono = (row.incidencia === 'abandono de trabajo') && ['amonestacion', 'amonestaci√≥n', 'compromiso'].includes(row.tipoCarta);
                return esAtraso || esAusencia || esAbandono;
            });
            
            if (fullProcessedData.length === 0) {
                showStatus('No se encontraron registros que cumplan con los criterios definidos.', 'error'); return;
            }
            
            const uniqueTimestamps = [...new Set(fullProcessedData.map(d => new Date(d.fecha).setHours(0, 0, 0, 0)))].sort((a, b) => a - b);
            
            if (uniqueTimestamps.length < 2) {
                processedData = [...fullProcessedData];
                elements.dateFilterContainer.classList.add('hidden');
                showResults();
            } else {
                setupAndShowDateFilter(uniqueTimestamps);
            }
        }

        function setupAndShowDateFilter(uniqueTimestamps) {
            const minTimestamp = uniqueTimestamps[0];
            const maxTimestamp = uniqueTimestamps[uniqueTimestamps.length - 1];
            if (dateSlider) dateSlider.destroy();
            dateSlider = noUiSlider.create(elements.dateSlider, {
                start: [minTimestamp, maxTimestamp], connect: true,
                range: { min: minTimestamp, max: maxTimestamp }, step: 24 * 60 * 60 * 1000,
            });
            const formatDateForDisplay = (ts) => new Date(parseInt(ts)).toLocaleDateString('es-CL', { timeZone: 'UTC' });
            dateSlider.on('slide', (values) => { applyFiltersAndShowResults(values.map(v => parseInt(v))); });
            dateSlider.on('update', (values) => {
                 elements.sliderStartDate.textContent = formatDateForDisplay(values[0]);
                 elements.sliderEndDate.textContent = formatDateForDisplay(values[1]);
            });
            elements.dateFilterContainer.classList.remove('hidden');
            applyFiltersAndShowResults(dateSlider.get(true));
        }

        function applyFiltersAndShowResults(values) {
            const [startTimestamp, endTimestamp] = values;
            processedData = fullProcessedData.filter(row => {
                const rowTimestamp = new Date(row.fecha).setHours(0,0,0,0);
                return rowTimestamp >= startTimestamp && rowTimestamp <= endTimestamp;
            });
            showResults();
        }

        function showResults() {
            if (processedData.length > 0) {
                elements.generateBtn.classList.remove('hidden');
                elements.btnText.textContent = `üöÄ Generar ${processedData.length} Cartas`;
                showStatus(`${processedData.length} registros encontrados y listos para generar.`, 'success');
            } else {
                elements.generateBtn.classList.add('hidden');
                showStatus('No se encontraron registros en el rango de fechas seleccionado.', 'warning');
            }
        }
        
        function createWordDocument(data) {
            const today = new Date().toLocaleDateString('es-CL', { day: '2-digit', month: 'long', year: 'numeric' });
            const incidentDate = data.fecha.toLocaleDateString('es-CL', { day: '2-digit', month: 'long', timeZone: 'UTC' }).replace('-', ' de ');
            const headerHtml = `<div style='font-family: Calibri, sans-serif; color: #1f4e9b; font-weight: bold; font-size: 18pt;'>Konecta</div><div style='font-family: Calibri, sans-serif; font-size: 10pt; line-height: 1.2;'><b>KALLPLAT CHILE LIMITADA</b><br>RUT: 76.071.717-7<br>Giro: Actividades de Call Center<br>Calle Rodrigo de Araya N¬∫ 1045, Macul. Santiago.</div>`;
            
            let bodyHtml;
            const esCompromiso = data.tipoCarta === 'compromiso';

            if (data.incidencia.includes('abandono')) {
                const titulo = esCompromiso ? 'Carta de Compromiso' : 'Carta de Amonestaci√≥n';
                const parrafoInspeccion = esCompromiso ? '' : ' De acuerdo a lo anterior, esta amonestaci√≥n ser√° informada a la Inspecci√≥n del Trabajo y quedar√° una copia en su carpeta personal.';
                const textoCC = esCompromiso ? 'CC. Carpeta personal' : 'CC. Carpeta personal<br>Inspecci√≥n del Trabajo';
                
                const page1 = `<table style='width: 100%; border-collapse: collapse;'>
                                <tr><td style='padding-bottom: 10px;'>${headerHtml}</td></tr>
                                <tr>
                                    <td>
                                        <p style='text-align: right; padding-top:20px;'>Osorno, ${today}</p>
                                        <p style='text-align: center; font-weight: bold; text-decoration: underline; padding-top:30px;'>${titulo}</p>
                                        <br><br>
                                        <p style='margin-bottom: 20px;'><b>Se√±or (a):</b> ${toProperCase(data.nombres)}<br><b>Rut:</b> ${data.rut}</p>
                                        <p style='margin-bottom: 20px;'><b>Presente.</b></p>
                                        <p style='margin-bottom: 20px;'>De mi consideraci√≥n:</p>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Cumplo con informarle a Ud. que es su obligaci√≥n cumplir en forma √≠ntegra su jornada laboral, para poder desempe√±ar en forma correcta las funciones para las que fue contratado, el d√≠a ${incidentDate}, sin justificaci√≥n alguna y sin autorizaci√≥n de su jefatura directa se ha ausentado durante su jornada de trabajo desde las ${data.inicioTurno} a ${data.finTurno} horas y al ser buscado en plataforma Genesys iCloud no pudo ser ubicada en conexi√≥n desde su modalidad de teletrabajo.</p>
                                    </td>
                                </tr>
                            </table>`;
                
                const page2 = `<table style='width: 100%; border-collapse: collapse;'>
                                <tr><td style='padding-bottom: 10px;'>${headerHtml}</td></tr>
                                <tr>
                                    <td style='padding-top: 20px;'>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Le recordamos que debe respetar la letra A) del Reglamento Interno de Orden Higiene y Seguridad que en el apartado referido a las Prohibiciones en el Titulo XV en su art√≠culo 87, indica ‚Ä¶‚Äù Abandonar el trabajo o ausentarse intempestivamente del recinto en que √©ste se desarrolla durante la jornada laboral sin justificaci√≥n y/o autorizaci√≥n.</p>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>En atenci√≥n a lo se√±alado con anterioridad se le solicita encarecidamente, que tome las medidas pertinentes para solucionar estas dificultades que entorpecen el normal funcionamiento de nuestra empresa, a fin de evitar sanciones posteriores.${parrafoInspeccion}</p>
                                        <p style='margin-top: 30px;'>Sin otro particular,</p>
                                        <p style='margin-top: 10px; margin-bottom: 80px;'>Le saluda atentamente,</p>
                                        <table style="width:100%;"><tr><td style="text-align:left; vertical-align:bottom;"><b>Jefe de Servicios</b></td><td style="text-align:right; vertical-align:bottom;"><b>Nombre:</b> ${toProperCase(data.nombres)}<br><b>Rut:</b> ${data.rut}</td></tr></table>
                                        <div style='margin-top: 50px; font-weight: bold;'>${textoCC}</div>
                                    </td>
                                </tr>
                           </table>`;
                bodyHtml = `${page1}<br clear=all style='mso-special-character:line-break; page-break-before:always'>${page2}`;

            } else if (data.incidencia.includes('ausencia')) {
                const titulo = esCompromiso ? 'Carta Compromiso' : 'Carta Amonestaci√≥n';
                const page1 = `<table style='width: 100%; border-collapse: collapse;'>
                                <tr><td style='padding-bottom: 10px;'>${headerHtml}</td></tr>
                                <tr>
                                    <td>
                                        <p style='text-align: right; padding-top:20px;'>Osorno, ${today}</p>
                                        <p style='text-align: center; text-decoration: underline; font-weight:bold; padding-top:30px;'>${titulo}</p>
                                        <br><br>
                                        <p><b>Se√±or(a):</b> ${toProperCase(data.nombres)}</p>
                                        <p><b>RUT:</b> ${data.rut}</p>
                                        <p style='font-weight: bold; margin-bottom: 20px;'>Presente</p>
                                        <p style='margin-bottom: 20px;'>De nuestra consideraci√≥n:</p>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Cumplo con informarle a Ud. que, seg√∫n lo dispuesto en su contrato individual de trabajo, usted debe entregar una atenci√≥n de calidad al momento de realizar las atenciones.</p>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Le recordamos que debe respetar la Cl√°usula Primera y Cuarta de su Contrato Individual de trabajo... El d√≠a en que ha dejado de prestar sus funciones injustificadamente ${incidentDate} en su turno programado de ${data.inicioTurno} a ${data.finTurno} hrs., debe cumplir con lo establecido en el Reglamento Interno...</p>
                                    </td>
                                </tr>
                            </table>`;
                const page2 = `<table style='width: 100%; border-collapse: collapse;'>
                                <tr><td style='padding-bottom: 10px;'>${headerHtml}</td></tr>
                                <tr>
                                    <td style='padding-top: 20px;'>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Con el objeto de que Ud. se comprometa a no presentar Alguna Ausencia y Cumplir con su Turno, se efect√∫a esta carta de Amonestaci√≥n.</p>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>En atenci√≥n a los puntos se√±alados con anterioridad se le solicita encarecidamente, que tome las medidas pertinentes para solucionar estas dificultades que entorpecen el normal funcionamiento de sus deberes laborales en nuestra empresa, a fin de evitar sanciones posteriores</p>
                                        <p style='margin-top: 30px;'>Sin otro particular, le saluda atentamente,</p>
                                        <br><br><br><br>
                                        <table style="width:100%;"><tr><td style="text-align:left; vertical-align:bottom;"><b>Jefe de Servicio</b><br>Konecta Chile Limitada.</td><td style="text-align:right; vertical-align:bottom;"><b>Nombre del Trabajador:</b> ${toProperCase(data.nombres)}<br>${data.rut}</td></tr></table>
                                    </td>
                                </tr>
                           </table>`;
                bodyHtml = `${page1}<br clear=all style='mso-special-character:line-break; page-break-before:always'>${page2}`;

            } else { // L√≥gica para cartas de Atraso
                const titulo = esCompromiso ? 'Carta de Compromiso' : 'Carta de Amonestaci√≥n';
                const duracionTexto = data.duracion ? `de una duraci√≥n de ${data.duracion} ` : `de una duraci√≥n de AGREGAR `;
                const parrafoInspeccion = esCompromiso ? '' : ' De acuerdo con lo anterior, esta amonestaci√≥n ser√° informada a la Inspecci√≥n del Trabajo y quedar√° una copia en su carpeta personal.';
                const textoCC = esCompromiso ? 'CC. Carpeta personal' : 'CC. Carpeta personal<br>Inspecci√≥n del Trabajo';
                const parrafoPrincipal = `<p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>El d√≠a ${incidentDate}, presenta un atraso injustificado, ${duracionTexto}ya que su turno programado para ese d√≠a era de ${data.inicioTurno} horas, al presentar estos atrasos en su hora de ingreso, perjudica el normal funcionamiento de la plataforma, que necesita contar con una cantidad de ejecutivos disponibles para atender en el horario en que su turno fue programado, perjudicando gravemente los niveles de servicio de la compa√±√≠a y la calidad de atenci√≥n a nuestros clientes.</p>`;
                const parrafoReglamento = `<p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Le recordamos que debe respetar la <b>letra b)</b> del Reglamento Interno de Orden Higiene y Seguridad que en el apartado referido a las prohibiciones en el Titulo XV en su art√≠culo 87, indica ‚Ä¶‚Äù llegar atrasado o registrar en forma reiterada, atrasos en su hora de ingreso‚Ä¶‚Äù. En atenci√≥n a lo se√±alado con anterioridad se le solicita encarecidamente, que tome las medidas pertinentes para solucionar estas dificultades que entorpecen el normal funcionamiento de nuestra empresa, a fin de evitar sanciones posteriores.${parrafoInspeccion}</p>`;
                
                const page1 = `<table style='width: 100%; border-collapse: collapse;'>
                                <tr><td style='padding-bottom: 10px;'>${headerHtml}</td></tr>
                                <tr>
                                    <td>
                                        <p style='text-align: right; padding-top:20px;'>Osorno, ${today}</p>
                                        <p style='text-align: center; font-weight: bold; text-decoration: underline; padding-top:30px;'>${titulo}</p>
                                        <br><br>
                                        <p style='margin-bottom: 20px;'><b>Se√±or (a):</b> ${toProperCase(data.nombres)}<br><b>Rut:</b> ${data.rut}</p>
                                        <p style='margin-bottom: 20px;'><b>Presente.</b></p>
                                        <p style='margin-bottom: 20px;'>De mi consideraci√≥n:</p>
                                        <p style='text-align: justify; margin-bottom: 12px; line-height: 1.4;'>Cumplo con informarle a Ud. que es su obligaci√≥n cumplir en forma √≠ntegra su jornada laboral.</p>
                                        ${parrafoPrincipal}
                                    </td>
                                </tr>
                            </table>`;
                const page2 = `<table style='width: 100%; border-collapse: collapse;'>
                                <tr><td style='padding-bottom: 10px;'>${headerHtml}</td></tr>
                                <tr><td style='padding-top: 20px;'>${parrafoReglamento}<p style='margin-top: 30px;'>Sin otro particular,</p><p style='margin-top: 10px; margin-bottom: 80px;'>Le saluda atentamente,</p><table style="width:100%;"><tr><td style="text-align:left; vertical-align:bottom;"><b>Jefe de Servicios</b></td><td style="text-align:right; vertical-align:bottom;"><b>Nombre:</b> ${toProperCase(data.nombres)}<br><b>Rut:</b> ${data.rut}</td></tr></table><div style='margin-top: 50px; font-weight: bold;'>${textoCC}</div></td></tr>
                            </table>`;
                bodyHtml = `${page1}<br clear=all style='mso-special-character:line-break; page-break-before:always'>${page2}`;
            }
            
            return `<html xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head><meta charset='utf-8'><title>Carta Generada</title></head>
                <body style='font-family: Calibri, sans-serif; font-size: 11pt;'>${bodyHtml}</body>
                </html>`;
        }

        async function generateDocuments() {
            elements.generateBtn.disabled = true;
            elements.btnText.textContent = '‚è≥ Generando...';
            
            try {
                const zip = new JSZip();
                for (let i = 0; i < processedData.length; i++) {
                    const row = processedData[i];
                    const htmlContent = createWordDocument(row);
                    const blob = new Blob(['\ufeff', htmlContent], { type: 'application/msword' });
                    
                    let nombreBase;
                    if (row.incidencia.includes('abandono')) {
                        const tipo = row.tipoCarta === 'compromiso' ? 'Compromiso' : 'Amonestacion';
                        nombreBase = `${tipo}_Abandono_Trabajo`;
                    } else if (row.incidencia.includes('ausencia')) {
                        const tipo = row.tipoCarta === 'compromiso' ? 'Compromiso' : 'Amonestacion';
                        nombreBase = `${tipo}_Ausencia`;
                    } else {
                        const tipo = row.tipoCarta === 'compromiso' ? 'Compromiso' : 'Amonestacion';
                        nombreBase = `${tipo}_Atrasos`;
                    }
                    const cleanName = row.nombres.replace(/[^\w\s-]/g, '').trim().replace(/\s+/g, '_');
                    const fileName = `${nombreBase}_${row.rut}_${cleanName}.doc`;

                    zip.file(fileName, blob);
                    await new Promise(r => setTimeout(r, 10));
                }

                if (processedData.length > 0) {
                    const zipBlob = await zip.generateAsync({ type: 'blob' });
                    saveAs(zipBlob, `Cartas_Generadas_${new Date().toISOString().split('T')[0]}.zip`);
                    showStatus(`¬°√âxito! Se generaron ${processedData.length} cartas.`, 'success');
                }
            } catch (error) {
                console.error("Error al generar documentos:", error);
                showStatus('Ocurri√≥ un error al generar el archivo ZIP.', 'error');
            } finally {
                elements.generateBtn.disabled = false;
                if (processedData.length > 0) {
                   elements.btnText.textContent = `üöÄ Generar ${processedData.length} Cartas`;
                }
            }
        }
    </script>
</body>
</html></template>
  <script>
    function notify(t){document.getElementById('iaMsg').textContent=t;}
    function setBannerLoading(nombre){const b=document.getElementById('topBanner');b.querySelector('h1').textContent=nombre;b.querySelector('p').innerHTML='<span class="loader"></span> Cargando‚Ä¶';}
    function setBannerReady(nombre,det){const b=document.getElementById('topBanner');b.querySelector('h1').textContent=nombre;b.querySelector('p').textContent='‚úÖ '+det;}
    function openSection(id){document.getElementById('inicio').style.display='none';document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');if(id==='calendario'){setBannerLoading('üìÖ Calendario Teletrabajo');loadFrame('calendario');notify('‚öôÔ∏è Abriendo Calendario‚Ä¶');}if(id==='turnos'){setBannerLoading('üìä Turnos Diarios');loadFrame('turnos');notify('‚öôÔ∏è Abriendo Turnos‚Ä¶');}if(id==='cartas'){setBannerLoading('üìÑ Carta de Amonestaci√≥n');loadFrame('cartas');notify('‚öôÔ∏è Abriendo Cartas‚Ä¶');}}
    function goInicio(){document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));document.getElementById('inicio').style.display='block';const b=document.getElementById('topBanner');b.querySelector('h1').textContent='‚ö° Gestor Operativo';b.querySelector('p').textContent='Plataforma de automatizaci√≥n inteligente';notify('üè† Inicio');}
    const blobUrls={};function moduleHtml(id){return document.getElementById(id).innerHTML;}function toBlobUrl(id){if(blobUrls[id])return blobUrls[id];const html=moduleHtml(id);const blob=new Blob([html],{type:'text/html'});const url=URL.createObjectURL(blob);blobUrls[id]=url;return url;}
    function hideOverlay(w){const ov=document.getElementById('overlay-'+w);if(ov)ov.style.display='none';}
    function loadFrame(w){let fid='',tid='',nn='';if(w==='calendario'){fid='frame-calendario';tid='mod-calendario';nn='Calendario';}if(w==='turnos'){fid='frame-turnos';tid='mod-turnos';nn='Turnos';}if(w==='cartas'){fid='frame-cartas';tid='mod-cartas';nn='Cartas';}const f=document.getElementById(fid);if(!f.getAttribute('src')){f.addEventListener('load',()=>{setBannerReady(f.title,'M√≥dulo listo');hideOverlay(w);notify('‚úÖ '+nn+' listo: puedes trabajar y descargar.');},{once:true});f.src=toBlobUrl(tid);}else{hideOverlay(w);setBannerReady(f.title,'M√≥dulo listo');}}
  </script>
</body>
</html>
